<!doctype html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0"
    />
    <title>Nations League âš½</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Russo+One&family=Barlow+Condensed:wght@400;600;700&display=swap");
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }
      body {
        background: #0a0e17;
        font-family: "Barlow Condensed", sans-serif;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        color: #fff;
      }
      #gameContainer {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }
      #scoreboard {
        display: none;
        justify-content: center;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        background: linear-gradient(180deg, #111827, #0a0e17);
        z-index: 10;
        height: 50px;
        min-height: 50px;
      }
      #scoreboard.active {
        display: flex;
      }
      .ts {
        display: flex;
        align-items: center;
        gap: 5px;
        font-family: "Russo One", sans-serif;
      }
      .ts .fl {
        font-size: 20px;
      }
      .ts .tn {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        max-width: 65px;
        overflow: hidden;
        white-space: nowrap;
      }
      .ts .sc {
        font-size: 28px;
        min-width: 24px;
        text-align: center;
      }
      .th .tn,
      .th .sc {
        color: #93c5fd;
      }
      .ta .tn,
      .ta .sc {
        color: #fca5a5;
      }
      #sd {
        font-size: 18px;
        color: #4b5563;
        font-family: "Russo One", sans-serif;
      }
      #gt {
        font-size: 9px;
        color: #6b7280;
        text-align: center;
      }
      canvas {
        flex: 1;
        display: block;
        touch-action: none;
      }
      .ov {
        position: absolute;
        inset: 0;
        z-index: 100;
        display: none;
        flex-direction: column;
        align-items: center;
        overflow-y: auto;
        background: rgba(10, 14, 23, 0.98);
      }
      .ov.a {
        display: flex;
      }
      .oc {
        width: 100%;
        max-width: 420px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }
      h1.t {
        font-family: "Russo One", sans-serif;
        font-size: 26px;
        text-shadow: 0 0 30px rgba(250, 204, 21, 0.4);
        margin-top: 16px;
        text-align: center;
      }
      h2.s {
        font-family: "Russo One", sans-serif;
        font-size: 14px;
        color: #9ca3af;
        margin-bottom: 6px;
      }
      .b {
        background: linear-gradient(135deg, #1e40af, #3b82f6);
        border: none;
        color: #fff;
        font-family: "Russo One", sans-serif;
        font-size: 13px;
        padding: 11px 24px;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        max-width: 420px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        display: block;
        margin: 0 auto 8px auto;
      }
      .b:active {
        transform: scale(0.97);
      }
      .b2 {
        background: linear-gradient(135deg, #374151, #4b5563);
        box-shadow: 0 4px 8px rgba(75, 85, 99, 0.3);
      }
      .bg {
        background: linear-gradient(135deg, #92400e, #f59e0b);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      }
      .br {
        background: linear-gradient(135deg, #991b1b, #ef4444);
      }
      .bs {
        font-size: 10px;
        padding: 7px 14px;
        min-width: 80px;
      }
      .tg {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px;
        width: 100%;
        max-height: 50vh;
        overflow-y: auto;
        padding: 2px;
      }
      .tc {
        background: #1f2937;
        border: 2px solid #374151;
        border-radius: 7px;
        padding: 7px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .tc:active,
      .tc.sel {
        border-color: #3b82f6;
        background: #1e3a5f;
      }
      .tc .f {
        font-size: 22px;
      }
      .tc .i {
        flex: 1;
        min-width: 0;
      }
      .tc .n {
        font-size: 11px;
        font-weight: 700;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .tc .r {
        font-size: 9px;
        color: #9ca3af;
      }
      .tc .o {
        font-family: "Russo One", sans-serif;
        font-size: 14px;
        color: #facc15;
      }
      .fg {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px;
        width: 100%;
      }
      .fb {
        background: #1f2937;
        border: 2px solid #374151;
        color: #d1d5db;
        font-family: "Barlow Condensed", sans-serif;
        font-size: 15px;
        font-weight: 600;
        padding: 9px;
        border-radius: 7px;
        cursor: pointer;
        text-align: center;
      }
      .fb:active,
      .fb.sel {
        border-color: #3b82f6;
        background: #1e3a5f;
        color: #fff;
      }
      .gt {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
        margin-bottom: 6px;
      }
      .gt th {
        background: #1e293b;
        padding: 3px 5px;
        text-align: left;
        font-weight: 600;
        color: #9ca3af;
        font-size: 9px;
      }
      .gt td {
        padding: 3px 5px;
        border-bottom: 1px solid #1e293b;
      }
      .gt tr.q td {
        color: #22c55e;
      }
      .gt tr.e td {
        color: #6b7280;
      }
      .mr {
        font-size: 10px;
        color: #9ca3af;
        padding: 2px 5px;
      }
      #ti {
        position: absolute;
        top: 54px;
        left: 50%;
        transform: translateX(-50%);
        font-weight: 700;
        font-size: 11px;
        padding: 3px 10px;
        border-radius: 10px;
        z-index: 20;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        pointer-events: none;
        white-space: nowrap;
      }
      #go {
        position: absolute;
        inset: 0;
        z-index: 80;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        pointer-events: none;
      }
      #go.a {
        display: flex;
        animation: gf 2.5s ease-out forwards;
      }
      .gx {
        font-family: "Russo One", sans-serif;
        font-size: 52px;
        color: #fff;
        text-shadow: 0 0 60px rgba(250, 204, 21, 0.8);
        animation: gp 0.4s ease-in-out 3;
      }
      .gs {
        font-size: 16px;
        color: #facc15;
        font-weight: 700;
        margin-top: 4px;
      }
      @keyframes gf {
        0% {
          background: rgba(250, 204, 21, 0.3);
        }
        100% {
          background: transparent;
        }
      }
      @keyframes gp {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      #pb {
        position: absolute;
        bottom: 14px;
        left: 50%;
        transform: translateX(-50%);
        width: 140px;
        height: 8px;
        background: rgba(17, 24, 39, 0.9);
        border-radius: 4px;
        overflow: hidden;
        z-index: 30;
        display: none;
        border: 1px solid #374151;
      }
      #pf {
        height: 100%;
        width: 0%;
        border-radius: 4px;
      }
      #ins {
        position: absolute;
        bottom: 28px;
        left: 50%;
        transform: translateX(-50%);
        color: #6b7280;
        font-size: 10px;
        text-align: center;
        z-index: 20;
        pointer-events: none;
        white-space: nowrap;
      }
      #pi {
        position: absolute;
        background: rgba(17, 24, 39, 0.95);
        border: 1px solid #374151;
        border-radius: 7px;
        padding: 7px 9px;
        color: #fff;
        font-size: 10px;
        pointer-events: none;
        z-index: 50;
        display: none;
        min-width: 130px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
      }
      #mo {
        position: absolute;
        inset: 0;
        z-index: 90;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: rgba(10, 14, 23, 0.95);
      }
      #mo.a {
        display: flex;
      }
      .mot {
        font-family: "Russo One", sans-serif;
        font-size: 22px;
        margin-bottom: 4px;
      }
      .mos {
        font-family: "Russo One", sans-serif;
        font-size: 44px;
        color: #facc15;
      }
      .mosb {
        font-size: 13px;
        color: #9ca3af;
        margin-bottom: 14px;
      }
      
      /* ============================================ */
      /* SQUAD BUILDER & SHOP STYLES */
      /* ============================================ */
      
      /* Tab Navigation */
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        border-bottom: 2px solid #1f2937;
        padding-bottom: 8px;
      }
      .tab {
        background: #1f2937;
        border: none;
        color: #9ca3af;
        font-family: "Barlow Condensed", sans-serif;
        font-size: 14px;
        font-weight: 600;
        padding: 8px 16px;
        border-radius: 6px 6px 0 0;
        cursor: pointer;
        transition: all 0.2s;
      }
      .tab.active {
        background: #3b82f6;
        color: #fff;
      }
      
      /* Player Card */
      .player-card {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        border: 2px solid #374151;
        border-radius: 8px;
        padding: 10px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }
      .player-card:hover {
        border-color: #3b82f6;
        transform: translateY(-2px);
      }
      .player-card.selected {
        border-color: #facc15;
        background: linear-gradient(135deg, #422006 0%, #1f2937 100%);
      }
      
      /* Tier colors */
      .player-card.legendary {
        border-color: #fbbf24;
        box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
      }
      .player-card.epic {
        border-color: #a855f7;
        box-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
      }
      .player-card.rare {
        border-color: #3b82f6;
        box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
      }
      .player-card.common {
        border-color: #6b7280;
      }
      
      .player-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }
      .player-card-name {
        font-family: "Russo One", sans-serif;
        font-size: 13px;
        color: #fff;
      }
      .player-card-ovr {
        font-family: "Russo One", sans-serif;
        font-size: 18px;
        color: #facc15;
      }
      .player-card-info {
        font-size: 10px;
        color: #9ca3af;
        margin-bottom: 4px;
      }
      .player-card-country {
        font-size: 16px;
        margin-right: 4px;
      }
      .player-card-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 3px;
        font-size: 9px;
        color: #d1d5db;
      }
      .player-card-stat {
        display: flex;
        justify-content: space-between;
      }
      .player-card-stat-label {
        color: #9ca3af;
      }
      
      /* Shop Pack Card */
      .pack-card {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        border: 2px solid #374151;
        border-radius: 10px;
        padding: 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .pack-card:hover {
        border-color: #3b82f6;
        transform: scale(1.05);
      }
      .pack-card:active {
        transform: scale(0.98);
      }
      .pack-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .pack-card.disabled:hover {
        transform: none;
        border-color: #374151;
      }
      .pack-icon {
        font-size: 48px;
        margin-bottom: 8px;
      }
      .pack-name {
        font-family: "Russo One", sans-serif;
        font-size: 16px;
        color: #fff;
        margin-bottom: 4px;
      }
      .pack-info {
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 8px;
      }
      .pack-cost {
        font-family: "Russo One", sans-serif;
        font-size: 20px;
        color: #facc15;
      }
      
      /* Squad Formation Display */
      .formation-display {
        background: #0a1628;
        border: 2px solid #1f2937;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
        position: relative;
        aspect-ratio: 2/3;
      }
      .formation-player-slot {
        position: absolute;
        width: 50px;
        height: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .formation-player-slot:hover {
        transform: scale(1.1);
      }
      .formation-player-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #1f2937;
        border: 2px solid #374151;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Russo One", sans-serif;
        font-size: 16px;
        color: #9ca3af;
        margin-bottom: 2px;
      }
      .formation-player-slot.filled .formation-player-circle {
        background: #3b82f6;
        border-color: #60a5fa;
        color: #fff;
      }
      .formation-player-name {
        font-size: 8px;
        color: #9ca3af;
        text-align: center;
        white-space: nowrap;
      }
      
      /* Grid layouts */
      .players-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        max-height: 400px;
        overflow-y: auto;
      }
      .packs-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      
      /* Pack Opening Animation */
      .pack-opening {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      .pack-opening.active {
        display: flex;
      }
      .pack-opening-card {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        border: 3px solid #fbbf24;
        border-radius: 12px;
        padding: 20px;
        min-width: 280px;
        text-align: center;
        animation: cardReveal 0.5s ease-out;
      }
      @keyframes cardReveal {
        from {
          transform: scale(0) rotateY(180deg);
          opacity: 0;
        }
        to {
          transform: scale(1) rotateY(0deg);
          opacity: 1;
        }
      }
      
      ::-webkit-scrollbar {
        width: 3px;
      }
      ::-webkit-scrollbar-track {
        background: #0a0e17;
      }
      ::-webkit-scrollbar-thumb {
        background: #374151;
        border-radius: 2px;
      }
    </style>
  </head>
  <body>
    <div id="gameContainer">
      <div id="scoreboard">
        <div class="ts th">
          <span class="fl" id="hf"></span><span class="tn" id="hn"></span
          ><span class="sc" id="hs">0</span>
        </div>
        <div style="text-align: center">
          <div id="sd">-</div>
          <div id="gt">90 perc</div>
        </div>
        <div class="ts ta">
          <span class="sc" id="as">0</span><span class="tn" id="an"></span
          ><span class="fl" id="af"></span>
        </div>
      </div>
      
      <!-- PLAYER SYSTEM DEBUG (top-right corner) -->
      <div id="playerDebug" style="
        position: fixed;
        top: 10px;
        right: 10px;
        background: rgba(17, 24, 39, 0.95);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 11px;
        color: #9ca3af;
        z-index: 1000;
        font-family: 'Barlow Condensed', sans-serif;
        display: none;
      ">
        <div style="color: #fbbf24; font-weight: 600; margin-bottom: 4px;">âš½ Player System</div>
        <div>Level: <span id="debugLevel">1</span> (<span id="debugXP">0</span>/<span id="debugNextXP">1000</span> XP)</div>
        <div>Coins: <span id="debugCoins" style="color: #fbbf24;">0</span></div>
        <div>Players: <span id="debugPlayers">0</span></div>
      </div>
      
      <canvas id="gameCanvas"></canvas>
      <div id="ti"></div>
      <div id="pi"></div>
      <div id="pb"><div id="pf"></div></div>
      <div id="ins"></div>
      <div id="go">
        <div class="gx">âš½ GÃ“L!</div>
        <div class="gs" id="gsc"></div>
      </div>
      <div id="mo">
        <div class="mot" id="moT"></div>
        <div class="mos" id="moS"></div>
        <div class="mosb" id="moSb"></div>
        <button class="b" onclick="moCont()">Continue</button>
      </div>
      <div class="ov a" id="menu">
        <div class="oc">
          <h1 class="t">âš½ Football Manager 2026</h1>
          <h2 class="s">Main Menu</h2>
          
          <!-- Player System Buttons -->
          <button class="b" onclick="openSquadBuilder()" style="background: linear-gradient(135deg, #3b82f6, #1e40af); border: none;">
            ğŸ‘¥ My Squad
          </button>
          <button class="b" onclick="openShop()" style="background: linear-gradient(135deg, #f59e0b, #d97706); border: none;">
            ğŸ›’ Shop
          </button>
          
          <h2 class="s" style="margin-top: 16px;">Choose Tournament</h2>
          <button class="b" onclick="openQM()">âš¡ Quick Match</button>
          <button class="b" onclick="selectCup('EURO')">ğŸ† European Championship (55 teams)</button>
          <button class="b" onclick="selectCup('AFCON')">ğŸ† African Championship (54 teams)</button>
          <button class="b" onclick="selectCup('COPA')">ğŸ† South American Cup (10 teams)</button>
          <button class="b" onclick="selectCup('AFC')">ğŸ† Asian Championship (24 teams)</button>
          <button class="b" onclick="selectCup('CONCACAF')">ğŸ† North American Cup (16 teams)</button>
          <button class="b bg" onclick="selectCup('WC')">ğŸŒ World Championship (Qualifiers + Finals)</button>
        </div>
      </div>
      <div class="ov" id="tsel">

        <div class="oc">
          <h2 class="s" id="tst"></h2>
          
          <input
            type="text"
            id="tsrch"
            placeholder="Search..."
            style="
              width: 100%;
              padding: 7px 10px;
              border-radius: 6px;
              border: 1px solid #374151;
              background: #1f2937;
              color: #fff;
              font-size: 13px;
              outline: none;
            "
            oninput="filt()"
          />
          <div class="tg" id="tgr"></div>
          <button class="b b2 bs" onclick="bMenu()">Back</button>
        </div>
      </div>
      <div class="ov" id="fsel">
        <div class="oc">
          <h2 class="s" id="fst"></h2>
          <div class="fg" id="fgr"></div>
          <button class="b b2 bs" onclick="bTS()">Back</button>
        </div>
      </div>
      <div class="ov" id="cup"><div class="oc" id="cupc"></div></div>
      
      <!-- SQUAD BUILDER OVERLAY -->
      <div class="ov" id="squadBuilder">
        <div class="oc">
          <h2 class="s">ğŸ‘¥ My Squad</h2>
          
          <!-- User Stats -->
          <div style="background: #1f2937; padding: 10px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 11px; color: #9ca3af;">Level <span id="sbLevel">1</span></div>
              <div style="font-size: 9px; color: #6b7280;"><span id="sbXP">0</span>/<span id="sbNextXP">1000</span> XP</div>
            </div>
            <div style="text-align: right;">
              <div style="font-family: 'Russo One', sans-serif; font-size: 18px; color: #facc15;">
                <span id="sbCoins">0</span> ğŸ’°
              </div>
              <div style="font-size: 9px; color: #6b7280;"><span id="sbPlayers">0</span> players</div>
            </div>
          </div>
          
          <!-- Tabs -->
          <div class="tabs">
            <button class="tab active" onclick="switchSquadTab('lineup')">Starting XI</button>
            <button class="tab" onclick="switchSquadTab('collection')">Collection</button>
          </div>
          
          <!-- LINEUP TAB -->
          <div id="squadLineup">
            <div style="font-size: 11px; color: #9ca3af; margin-bottom: 8px;">
              Formation:
            </div>
            <div style="display: flex; gap: 6px; margin-bottom: 12px;">
              <button class="fb" onclick="changeFormation('4-4-2')">4-4-2</button>
              <button class="fb" onclick="changeFormation('5-4-1')">5-4-1</button>
              <button class="fb" onclick="changeFormation('3-4-3')">3-4-3</button>
            </div>
            
            <!-- Formation Display -->
            <div class="formation-display" id="formationDisplay">
              <!-- Will be populated by JS -->
            </div>
            
            <button class="b" onclick="autoSelectBest()">âš¡ Auto-Select Best XI</button>
          </div>
          
          <!-- COLLECTION TAB -->
          <div id="squadCollection" style="display: none;">
            <input
              type="text"
              id="collectionSearch"
              placeholder="Search players..."
              style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #374151; background: #1f2937; color: #fff; font-size: 13px; margin-bottom: 10px;"
              oninput="filterCollection()"
            />
            
            <div style="font-size: 10px; color: #9ca3af; margin-bottom: 4px;">Filter by Tier:</div>
            <div style="display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap;">
              <button class="fb" onclick="filterByTier('all')">All</button>
              <button class="fb" onclick="filterByTier('legendary')">â­ Legendary</button>
              <button class="fb" onclick="filterByTier('epic')">ğŸŸ£ Epic</button>
              <button class="fb" onclick="filterByTier('rare')">ğŸ”µ Rare</button>
              <button class="fb" onclick="filterByTier('common')">âšª Common</button>
            </div>
            
            <div style="font-size: 10px; color: #9ca3af; margin-bottom: 4px;">Filter by Position:</div>
            <div style="display: flex; gap: 4px; margin-bottom: 10px; flex-wrap: wrap; font-size: 11px;">
              <button class="fb" onclick="filterByPosition('all')">All</button>
              <button class="fb" onclick="filterByPosition('GK')">GK</button>
              <button class="fb" onclick="filterByPosition('DEF')">DEF</button>
              <button class="fb" onclick="filterByPosition('MID')">MID</button>
              <button class="fb" onclick="filterByPosition('ATT')">ATT</button>
            </div>
            
            <div class="players-grid" id="collectionGrid">
              <!-- Will be populated by JS -->
            </div>
          </div>
          
          <button class="b b2 bs" onclick="closeSquadBuilder()">Back</button>
        </div>
      </div>
      
      <!-- SHOP OVERLAY -->
      <div class="ov" id="shop">
        <div class="oc">
          <h2 class="s">ğŸ›’ Shop</h2>
          
          <!-- User Coins -->
          <div style="background: #1f2937; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center;">
            <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px;">Your Balance</div>
            <div style="font-family: 'Russo One', sans-serif; font-size: 32px; color: #facc15;">
              <span id="shopCoins">0</span> ğŸ’°
            </div>
          </div>
          
          <!-- Packs Grid -->
          <div class="packs-grid">
            <!-- Bronze Pack -->
            <div class="pack-card" onclick="buyPack('bronze')">
              <div class="pack-icon">ğŸ“¦</div>
              <div class="pack-name">Bronze Pack</div>
              <div class="pack-info">3 players<br>75% Common, 24% Rare</div>
              <div class="pack-cost">200 ğŸ’°</div>
            </div>
            
            <!-- Silver Pack -->
            <div class="pack-card" onclick="buyPack('silver')">
              <div class="pack-icon">ğŸ“¦</div>
              <div class="pack-name">Silver Pack</div>
              <div class="pack-info">5 players<br>60% Common, 30% Rare, 9% Epic</div>
              <div class="pack-cost">500 ğŸ’°</div>
            </div>
            
            <!-- Gold Pack -->
            <div class="pack-card" onclick="buyPack('gold')">
              <div class="pack-icon">ğŸ</div>
              <div class="pack-name">Gold Pack</div>
              <div class="pack-info">5 players<br>50% Rare, 25% Epic, 5% Legendary</div>
              <div class="pack-cost">1500 ğŸ’°</div>
            </div>
            
            <!-- Premium Pack -->
            <div class="pack-card" onclick="buyPack('premium')">
              <div class="pack-icon">ğŸ’</div>
              <div class="pack-name">Premium Pack</div>
              <div class="pack-info">7 players<br>1 Legendary guaranteed!</div>
              <div class="pack-cost">3000 ğŸ’°</div>
            </div>
          </div>
          
          <button class="b b2 bs" style="margin-top: 16px;" onclick="closeShop()">Back</button>
        </div>
      </div>
      
      <!-- PACK OPENING ANIMATION -->
      <div class="pack-opening" id="packOpening">
        <div class="pack-opening-card" id="packCard">
          <!-- Will be populated by JS -->
        </div>
        <button class="b" style="margin-top: 20px;" onclick="closePackOpening()">Continue</button>
      </div>
    </div>

    <script>
      // Helper: Calculate My Squad average rating
      function getMySquadAverageRating() {
        if (G.userSquad.players.length === 0) return 65;
        
        const players = G.userSquad.players
          .slice(0, 11) // First 11 only
          .map(id => getPlayerById(id))
          .filter(p => p);
        
        if (players.length === 0) return 65;
        
        const avgOverall = players.reduce((sum, p) => sum + p.overall, 0) / players.length;
        return Math.round(avgOverall);
      }
      
      const TEAMS = [
        // MY SQUAD - Dynamic team based on user's players
        { 
          name: "My Squad", 
          code: "MY_SQUAD", 
          flag: "âš½", 
          rank: 0, 
          continent: "MY_SQUAD",
          isMySquad: true,
          get avgRating() { return getMySquadAverageRating(); }
        },
        
        // EUROPE (UEFA) - 55 teams (COMPLETE)
        { name: "Spain", code: "ESP", flag: "ğŸ‡ªğŸ‡¸", rank: 1, continent: "UEFA" },
        { name: "France", code: "FRA", flag: "ğŸ‡«ğŸ‡·", rank: 3, continent: "UEFA" },
        { name: "England", code: "ENG", flag: "ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿", rank: 4, continent: "UEFA" },
        { name: "Portugal", code: "POR", flag: "ğŸ‡µğŸ‡¹", rank: 6, continent: "UEFA" },
        { name: "Netherlands", code: "NED", flag: "ğŸ‡³ğŸ‡±", rank: 7, continent: "UEFA" },
        { name: "Belgium", code: "BEL", flag: "ğŸ‡§ğŸ‡ª", rank: 9, continent: "UEFA" },
        { name: "Germany", code: "GER", flag: "ğŸ‡©ğŸ‡ª", rank: 10, continent: "UEFA" },
        { name: "Croatia", code: "CRO", flag: "ğŸ‡­ğŸ‡·", rank: 11, continent: "UEFA" },
        { name: "Italy", code: "ITA", flag: "ğŸ‡®ğŸ‡¹", rank: 17, continent: "UEFA" },
        { name: "Switzerland", code: "SUI", flag: "ğŸ‡¨ğŸ‡­", rank: 18, continent: "UEFA" },
        { name: "Denmark", code: "DEN", flag: "ğŸ‡©ğŸ‡°", rank: 21, continent: "UEFA" },
        { name: "Austria", code: "AUT", flag: "ğŸ‡¦ğŸ‡¹", rank: 24, continent: "UEFA" },
        { name: "Turkey", code: "TUR", flag: "ğŸ‡¹ğŸ‡·", rank: 25, continent: "UEFA" },
        { name: "Ukraine", code: "UKR", flag: "ğŸ‡ºğŸ‡¦", rank: 27, continent: "UEFA" },
        { name: "Norway", code: "NOR", flag: "ğŸ‡³ğŸ‡´", rank: 28, continent: "UEFA" },
        { name: "Poland", code: "POL", flag: "ğŸ‡µğŸ‡±", rank: 30, continent: "UEFA" },
        { name: "Wales", code: "WAL", flag: "ğŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿", rank: 31, continent: "UEFA" },
        { name: "Scotland", code: "SCO", flag: "ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿", rank: 34, continent: "UEFA" },
        { name: "Serbia", code: "SRB", flag: "ğŸ‡·ğŸ‡¸", rank: 35, continent: "UEFA" },
        { name: "Hungary", code: "HUN", flag: "ğŸ‡­ğŸ‡º", rank: 39, continent: "UEFA" },
        { name: "Sweden", code: "SWE", flag: "ğŸ‡¸ğŸ‡ª", rank: 41, continent: "UEFA" },
        { name: "Czech Republic", code: "CZE", flag: "ğŸ‡¨ğŸ‡¿", rank: 42, continent: "UEFA" },
        { name: "Slovakia", code: "SVK", flag: "ğŸ‡¸ğŸ‡°", rank: 43, continent: "UEFA" },
        { name: "Greece", code: "GRE", flag: "ğŸ‡¬ğŸ‡·", rank: 44, continent: "UEFA" },
        { name: "Romania", code: "ROU", flag: "ğŸ‡·ğŸ‡´", rank: 45, continent: "UEFA" },
        { name: "Slovenia", code: "SVN", flag: "ğŸ‡¸ğŸ‡®", rank: 51, continent: "UEFA" },
        { name: "Albania", code: "ALB", flag: "ğŸ‡¦ğŸ‡±", rank: 52, continent: "UEFA" },
        { name: "Ireland", code: "IRL", flag: "ğŸ‡®ğŸ‡ª", rank: 53, continent: "UEFA" },
        { name: "Bosnia", code: "BIH", flag: "ğŸ‡§ğŸ‡¦", rank: 56, continent: "UEFA" },
        { name: "Georgia", code: "GEO", flag: "ğŸ‡¬ğŸ‡ª", rank: 57, continent: "UEFA" },
        { name: "Iceland", code: "ISL", flag: "ğŸ‡®ğŸ‡¸", rank: 58, continent: "UEFA" },
        { name: "Finland", code: "FIN", flag: "ğŸ‡«ğŸ‡®", rank: 59, continent: "UEFA" },
        { name: "Northern Ireland", code: "NIR", flag: "ğŸ‡¬ğŸ‡§", rank: 65, continent: "UEFA" },
        { name: "Bulgaria", code: "BUL", flag: "ğŸ‡§ğŸ‡¬", rank: 66, continent: "UEFA" },
        { name: "Montenegro", code: "MNE", flag: "ğŸ‡²ğŸ‡ª", rank: 67, continent: "UEFA" },
        { name: "North Macedonia", code: "MKD", flag: "ğŸ‡²ğŸ‡°", rank: 68, continent: "UEFA" },
        { name: "Israel", code: "ISR", flag: "ğŸ‡®ğŸ‡±", rank: 69, continent: "UEFA" },
        { name: "Cyprus", code: "CYP", flag: "ğŸ‡¨ğŸ‡¾", rank: 70, continent: "UEFA" },
        { name: "Armenia", code: "ARM", flag: "ğŸ‡¦ğŸ‡²", rank: 71, continent: "UEFA" },
        { name: "Belarus", code: "BLR", flag: "ğŸ‡§ğŸ‡¾", rank: 72, continent: "UEFA" },
        { name: "Kosovo", code: "KVX", flag: "ğŸ‡½ğŸ‡°", rank: 73, continent: "UEFA" },
        { name: "Luxembourg", code: "LUX", flag: "ğŸ‡±ğŸ‡º", rank: 74, continent: "UEFA" },
        { name: "Azerbaijan", code: "AZE", flag: "ğŸ‡¦ğŸ‡¿", rank: 75, continent: "UEFA" },
        { name: "Kazakhstan", code: "KAZ", flag: "ğŸ‡°ğŸ‡¿", rank: 76, continent: "UEFA" },
        { name: "Lithuania", code: "LTU", flag: "ğŸ‡±ğŸ‡¹", rank: 77, continent: "UEFA" },
        { name: "Latvia", code: "LVA", flag: "ğŸ‡±ğŸ‡»", rank: 78, continent: "UEFA" },
        { name: "Estonia", code: "EST", flag: "ğŸ‡ªğŸ‡ª", rank: 79, continent: "UEFA" },
        { name: "Faroe Islands", code: "FRO", flag: "ğŸ‡«ğŸ‡´", rank: 80, continent: "UEFA" },
        { name: "Malta", code: "MLT", flag: "ğŸ‡²ğŸ‡¹", rank: 81, continent: "UEFA" },
        { name: "Moldova", code: "MDA", flag: "ğŸ‡²ğŸ‡©", rank: 82, continent: "UEFA" },
        { name: "Liechtenstein", code: "LIE", flag: "ğŸ‡±ğŸ‡®", rank: 83, continent: "UEFA" },
        { name: "Andorra", code: "AND", flag: "ğŸ‡¦ğŸ‡©", rank: 84, continent: "UEFA" },
        { name: "San Marino", code: "SMR", flag: "ğŸ‡¸ğŸ‡²", rank: 85, continent: "UEFA" },
        { name: "Gibraltar", code: "GIB", flag: "ğŸ‡¬ğŸ‡®", rank: 86, continent: "UEFA" },

        // SOUTH AMERICA (CONMEBOL) - 10 teams (ALL)
        { name: "Argentina", code: "ARG", flag: "ğŸ‡¦ğŸ‡·", rank: 2, continent: "CONMEBOL" },
        { name: "Brazil", code: "BRA", flag: "ğŸ‡§ğŸ‡·", rank: 5, continent: "CONMEBOL" },
        { name: "Colombia", code: "COL", flag: "ğŸ‡¨ğŸ‡´", rank: 13, continent: "CONMEBOL" },
        { name: "Uruguay", code: "URU", flag: "ğŸ‡ºğŸ‡¾", rank: 14, continent: "CONMEBOL" },
        { name: "Ecuador", code: "ECU", flag: "ğŸ‡ªğŸ‡¨", rank: 23, continent: "CONMEBOL" },
        { name: "Paraguay", code: "PAR", flag: "ğŸ‡µğŸ‡¾", rank: 37, continent: "CONMEBOL" },
        { name: "Venezuela", code: "VEN", flag: "ğŸ‡»ğŸ‡ª", rank: 46, continent: "CONMEBOL" },
        { name: "Chile", code: "CHI", flag: "ğŸ‡¨ğŸ‡±", rank: 47, continent: "CONMEBOL" },
        { name: "Peru", code: "PER", flag: "ğŸ‡µğŸ‡ª", rank: 48, continent: "CONMEBOL" },
        { name: "Bolivia", code: "BOL", flag: "ğŸ‡§ğŸ‡´", rank: 49, continent: "CONMEBOL" },

        // AFRICA (CAF) - 54 teams (COMPLETE)
        { name: "Morocco", code: "MAR", flag: "ğŸ‡²ğŸ‡¦", rank: 8, continent: "CAF" },
        { name: "Senegal", code: "SEN", flag: "ğŸ‡¸ğŸ‡³", rank: 12, continent: "CAF" },
        { name: "Egypt", code: "EGY", flag: "ğŸ‡ªğŸ‡¬", rank: 32, continent: "CAF" },
        { name: "Algeria", code: "ALG", flag: "ğŸ‡©ğŸ‡¿", rank: 33, continent: "CAF" },
        { name: "Nigeria", code: "NGA", flag: "ğŸ‡³ğŸ‡¬", rank: 36, continent: "CAF" },
        { name: "Tunisia", code: "TUN", flag: "ğŸ‡¹ğŸ‡³", rank: 38, continent: "CAF" },
        { name: "Ivory Coast", code: "CIV", flag: "ğŸ‡¨ğŸ‡®", rank: 40, continent: "CAF" },
        { name: "South Africa", code: "RSA", flag: "ğŸ‡¿ğŸ‡¦", rank: 50, continent: "CAF" },
        { name: "Cameroon", code: "CMR", flag: "ğŸ‡¨ğŸ‡²", rank: 54, continent: "CAF" },
        { name: "Ghana", code: "GHA", flag: "ğŸ‡¬ğŸ‡­", rank: 60, continent: "CAF" },
        { name: "Mali", code: "MLI", flag: "ğŸ‡²ğŸ‡±", rank: 61, continent: "CAF" },
        { name: "DR Congo", code: "COD", flag: "ğŸ‡¨ğŸ‡©", rank: 62, continent: "CAF" },
        { name: "Burkina Faso", code: "BFA", flag: "ğŸ‡§ğŸ‡«", rank: 64, continent: "CAF" },
        { name: "Guinea", code: "GUI", flag: "ğŸ‡¬ğŸ‡³", rank: 87, continent: "CAF" },
        { name: "Zambia", code: "ZAM", flag: "ğŸ‡¿ğŸ‡²", rank: 88, continent: "CAF" },
        { name: "Gabon", code: "GAB", flag: "ğŸ‡¬ğŸ‡¦", rank: 89, continent: "CAF" },
        { name: "Angola", code: "ANG", flag: "ğŸ‡¦ğŸ‡´", rank: 90, continent: "CAF" },
        { name: "Benin", code: "BEN", flag: "ğŸ‡§ğŸ‡¯", rank: 91, continent: "CAF" },
        { name: "Uganda", code: "UGA", flag: "ğŸ‡ºğŸ‡¬", rank: 92, continent: "CAF" },
        { name: "Guinea-Bissau", code: "GNB", flag: "ğŸ‡¬ğŸ‡¼", rank: 93, continent: "CAF" },
        { name: "Kenya", code: "KEN", flag: "ğŸ‡°ğŸ‡ª", rank: 94, continent: "CAF" },
        { name: "Mauritania", code: "MTN", flag: "ğŸ‡²ğŸ‡·", rank: 95, continent: "CAF" },
        { name: "Mozambique", code: "MOZ", flag: "ğŸ‡²ğŸ‡¿", rank: 96, continent: "CAF" },
        { name: "Equatorial Guinea", code: "EQG", flag: "ğŸ‡¬ğŸ‡¶", rank: 97, continent: "CAF" },
        { name: "Namibia", code: "NAM", flag: "ğŸ‡³ğŸ‡¦", rank: 98, continent: "CAF" },
        { name: "Zimbabwe", code: "ZIM", flag: "ğŸ‡¿ğŸ‡¼", rank: 99, continent: "CAF" },
        { name: "Tanzania", code: "TAN", flag: "ğŸ‡¹ğŸ‡¿", rank: 100, continent: "CAF" },
        { name: "Central Africa", code: "CTA", flag: "ğŸ‡¨ğŸ‡«", rank: 101, continent: "CAF" },
        { name: "Togo", code: "TOG", flag: "ğŸ‡¹ğŸ‡¬", rank: 102, continent: "CAF" },
        { name: "Niger", code: "NIG", flag: "ğŸ‡³ğŸ‡ª", rank: 103, continent: "CAF" },
        { name: "Comoros", code: "COM", flag: "ğŸ‡°ğŸ‡²", rank: 104, continent: "CAF" },
        { name: "Sierra Leone", code: "SLE", flag: "ğŸ‡¸ğŸ‡±", rank: 105, continent: "CAF" },
        { name: "Malawi", code: "MWI", flag: "ğŸ‡²ğŸ‡¼", rank: 106, continent: "CAF" },
        { name: "Madagascar", code: "MAD", flag: "ğŸ‡²ğŸ‡¬", rank: 107, continent: "CAF" },
        { name: "Liberia", code: "LBR", flag: "ğŸ‡±ğŸ‡·", rank: 108, continent: "CAF" },
        { name: "Botswana", code: "BOT", flag: "ğŸ‡§ğŸ‡¼", rank: 109, continent: "CAF" },
        { name: "Gambia", code: "GAM", flag: "ğŸ‡¬ğŸ‡²", rank: 110, continent: "CAF" },
        { name: "Sudan", code: "SDN", flag: "ğŸ‡¸ğŸ‡©", rank: 111, continent: "CAF" },
        { name: "Ethiopia", code: "ETH", flag: "ğŸ‡ªğŸ‡¹", rank: 112, continent: "CAF" },
        { name: "Rwanda", code: "RWA", flag: "ğŸ‡·ğŸ‡¼", rank: 113, continent: "CAF" },
        { name: "Burundi", code: "BDI", flag: "ğŸ‡§ğŸ‡®", rank: 114, continent: "CAF" },
        { name: "Libya", code: "LBY", flag: "ğŸ‡±ğŸ‡¾", rank: 115, continent: "CAF" },
        { name: "Congo", code: "CGO", flag: "ğŸ‡¨ğŸ‡¬", rank: 116, continent: "CAF" },
        { name: "South Sudan", code: "SSD", flag: "ğŸ‡¸ğŸ‡¸", rank: 117, continent: "CAF" },
        { name: "Mauritius", code: "MRI", flag: "ğŸ‡²ğŸ‡º", rank: 118, continent: "CAF" },
        { name: "Eswatini", code: "SWZ", flag: "ğŸ‡¸ğŸ‡¿", rank: 119, continent: "CAF" },
        { name: "Chad", code: "CHA", flag: "ğŸ‡¹ğŸ‡©", rank: 120, continent: "CAF" },
        { name: "Lesotho", code: "LES", flag: "ğŸ‡±ğŸ‡¸", rank: 121, continent: "CAF" },
        { name: "Cape Verde", code: "CPV", flag: "ğŸ‡¨ğŸ‡»", rank: 122, continent: "CAF" },
        { name: "Sao Tome", code: "STP", flag: "ğŸ‡¸ğŸ‡¹", rank: 123, continent: "CAF" },
        { name: "Seychelles", code: "SEY", flag: "ğŸ‡¸ğŸ‡¨", rank: 124, continent: "CAF" },
        { name: "Djibouti", code: "DJI", flag: "ğŸ‡©ğŸ‡¯", rank: 125, continent: "CAF" },
        { name: "Somalia", code: "SOM", flag: "ğŸ‡¸ğŸ‡´", rank: 126, continent: "CAF" },
        { name: "Eritrea", code: "ERI", flag: "ğŸ‡ªğŸ‡·", rank: 127, continent: "CAF" },

        // ASIA (AFC) - 24 selected teams
        { name: "Japan", code: "JPN", flag: "ğŸ‡¯ğŸ‡µ", rank: 19, continent: "AFC" },
        { name: "Iran", code: "IRN", flag: "ğŸ‡®ğŸ‡·", rank: 20, continent: "AFC" },
        { name: "South Korea", code: "KOR", flag: "ğŸ‡°ğŸ‡·", rank: 22, continent: "AFC" },
        { name: "Australia", code: "AUS", flag: "ğŸ‡¦ğŸ‡º", rank: 26, continent: "AFC" },
        { name: "Uzbekistan", code: "UZB", flag: "ğŸ‡ºğŸ‡¿", rank: 47, continent: "AFC" },
        { name: "Qatar", code: "QAT", flag: "ğŸ‡¶ğŸ‡¦", rank: 48, continent: "AFC" },
        { name: "Saudi Arabia", code: "KSA", flag: "ğŸ‡¸ğŸ‡¦", rank: 49, continent: "AFC" },
        { name: "Iraq", code: "IRQ", flag: "ğŸ‡®ğŸ‡¶", rank: 55, continent: "AFC" },
        { name: "UAE", code: "UAE", flag: "ğŸ‡¦ğŸ‡ª", rank: 128, continent: "AFC" },
        { name: "Oman", code: "OMA", flag: "ğŸ‡´ğŸ‡²", rank: 129, continent: "AFC" },
        { name: "Jordan", code: "JOR", flag: "ğŸ‡¯ğŸ‡´", rank: 130, continent: "AFC" },
        { name: "Bahrain", code: "BHR", flag: "ğŸ‡§ğŸ‡­", rank: 131, continent: "AFC" },
        { name: "China", code: "CHN", flag: "ğŸ‡¨ğŸ‡³", rank: 132, continent: "AFC" },
        { name: "Palestine", code: "PLE", flag: "ğŸ‡µğŸ‡¸", rank: 133, continent: "AFC" },
        { name: "Kyrgyzstan", code: "KGZ", flag: "ğŸ‡°ğŸ‡¬", rank: 134, continent: "AFC" },
        { name: "Tajikistan", code: "TJK", flag: "ğŸ‡¹ğŸ‡¯", rank: 135, continent: "AFC" },
        { name: "Vietnam", code: "VIE", flag: "ğŸ‡»ğŸ‡³", rank: 136, continent: "AFC" },
        { name: "Thailand", code: "THA", flag: "ğŸ‡¹ğŸ‡­", rank: 137, continent: "AFC" },
        { name: "Indonesia", code: "IDN", flag: "ğŸ‡®ğŸ‡©", rank: 138, continent: "AFC" },
        { name: "India", code: "IND", flag: "ğŸ‡®ğŸ‡³", rank: 139, continent: "AFC" },
        { name: "Syria", code: "SYR", flag: "ğŸ‡¸ğŸ‡¾", rank: 140, continent: "AFC" },
        { name: "Lebanon", code: "LBN", flag: "ğŸ‡±ğŸ‡§", rank: 141, continent: "AFC" },
        { name: "Malaysia", code: "MAS", flag: "ğŸ‡²ğŸ‡¾", rank: 142, continent: "AFC" },
        { name: "Hong Kong", code: "HKG", flag: "ğŸ‡­ğŸ‡°", rank: 143, continent: "AFC" },

        // NORTH/CENTRAL AMERICA (CONCACAF) - 16 teams
        { name: "USA", code: "USA", flag: "ğŸ‡ºğŸ‡¸", rank: 15, continent: "CONCACAF" },
        { name: "Mexico", code: "MEX", flag: "ğŸ‡²ğŸ‡½", rank: 16, continent: "CONCACAF" },
        { name: "Panama", code: "PAN", flag: "ğŸ‡µğŸ‡¦", rank: 29, continent: "CONCACAF" },
        { name: "Honduras", code: "HON", flag: "ğŸ‡­ğŸ‡³", rank: 63, continent: "CONCACAF" },
        { name: "Canada", code: "CAN", flag: "ğŸ‡¨ğŸ‡¦", rank: 144, continent: "CONCACAF" },
        { name: "Costa Rica", code: "CRC", flag: "ğŸ‡¨ğŸ‡·", rank: 145, continent: "CONCACAF" },
        { name: "Jamaica", code: "JAM", flag: "ğŸ‡¯ğŸ‡²", rank: 146, continent: "CONCACAF" },
        { name: "El Salvador", code: "SLV", flag: "ğŸ‡¸ğŸ‡»", rank: 147, continent: "CONCACAF" },
        { name: "Curacao", code: "CUW", flag: "ğŸ‡¨ğŸ‡¼", rank: 148, continent: "CONCACAF" },
        { name: "Guatemala", code: "GUA", flag: "ğŸ‡¬ğŸ‡¹", rank: 149, continent: "CONCACAF" },
        { name: "Trinidad", code: "TRI", flag: "ğŸ‡¹ğŸ‡¹", rank: 150, continent: "CONCACAF" },
        { name: "Haiti", code: "HAI", flag: "ğŸ‡­ğŸ‡¹", rank: 151, continent: "CONCACAF" },
        { name: "Nicaragua", code: "NCA", flag: "ğŸ‡³ğŸ‡®", rank: 152, continent: "CONCACAF" },
        { name: "Suriname", code: "SUR", flag: "ğŸ‡¸ğŸ‡·", rank: 153, continent: "CONCACAF" },
        { name: "Dominica", code: "DMA", flag: "ğŸ‡©ğŸ‡²", rank: 154, continent: "CONCACAF" },
        { name: "Grenada", code: "GRN", flag: "ğŸ‡¬ğŸ‡©", rank: 155, continent: "CONCACAF" },
      ];

      const FMS = {
        "4-4-2": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.15, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.12, p: "CB" },
            { x: 0.62, y: 0.12, p: "CB" },
            { x: 0.85, y: 0.18, p: "RB" },
            { x: 0.20, y: 0.38, p: "LM" },
            { x: 0.37, y: 0.25, p: "CM" },
            { x: 0.63, y: 0.25, p: "CM" },
            { x: 0.80, y: 0.38, p: "RM" },
            { x: 0.30, y: 0.50, p: "ST" },
            { x: 0.70, y: 0.50, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.15, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.85, y: 0.35, p: "RB" },
            { x: 0.1, y: 0.70, p: "LM" },
            { x: 0.35, y: 0.60, p: "CM" },
            { x: 0.65, y: 0.60, p: "CM" },
            { x: 0.9, y: 0.70, p: "RM" },
            { x: 0.25, y: 0.80, p: "ST" },
            { x: 0.75, y: 0.80, p: "ST" },
          ],
        },
        "4-3-3": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.37, y: 0.12, p: "CB" },
            { x: 0.63, y: 0.12, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.25, y: 0.25, p: "CM" },
            { x: 0.5, y: 0.22, p: "CM" },
            { x: 0.75, y: 0.25, p: "CM" },
            { x: 0.20, y: 0.44, p: "LW" },
            { x: 0.5, y: 0.50, p: "ST" },
            { x: 0.80, y: 0.44, p: "RW" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.37, y: 0.30, p: "CB" },
            { x: 0.63, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.25, y: 0.60, p: "CM" },
            { x: 0.5, y: 0.55, p: "CM" },
            { x: 0.75, y: 0.60, p: "CM" },
            { x: 0.10, y: 0.82, p: "LW" },
            { x: 0.5, y: 0.85, p: "ST" },
            { x: 0.90, y: 0.82, p: "RW" },
          ],
        },
        "3-5-2": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.15, p: "CB" },
            { x: 0.5, y: 0.12, p: "CB" },
            { x: 0.75, y: 0.15, p: "CB" },
            { x: 0.08, y: 0.34, p: "LWB" },
            { x: 0.3, y: 0.32, p: "CM" },
            { x: 0.5, y: 0.28, p: "CDM" },
            { x: 0.7, y: 0.32, p: "CM" },
            { x: 0.92, y: 0.34, p: "RWB" },
            { x: 0.35, y: 0.52, p: "ST" },
            { x: 0.65, y: 0.52, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.30, p: "CB" },
            { x: 0.5, y: 0.27, p: "CB" },
            { x: 0.75, y: 0.30, p: "CB" },
            { x: 0.06, y: 0.60, p: "LWB" },
            { x: 0.28, y: 0.58, p: "CM" },
            { x: 0.5, y: 0.55, p: "CDM" },
            { x: 0.72, y: 0.58, p: "CM" },
            { x: 0.94, y: 0.60, p: "RWB" },
            { x: 0.35, y: 0.82, p: "ST" },
            { x: 0.65, y: 0.82, p: "ST" },
          ],
        },
        "4-2-3-1": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.15, p: "CB" },
            { x: 0.62, y: 0.15, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.35, y: 0.3, p: "CDM" },
            { x: 0.65, y: 0.3, p: "CDM" },
            { x: 0.13, y: 0.44, p: "LW" },
            { x: 0.5, y: 0.42, p: "CAM" },
            { x: 0.87, y: 0.44, p: "RW" },
            { x: 0.5, y: 0.56, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.35, y: 0.52, p: "CDM" },
            { x: 0.65, y: 0.52, p: "CDM" },
            { x: 0.12, y: 0.75, p: "LW" },
            { x: 0.5, y: 0.72, p: "CAM" },
            { x: 0.88, y: 0.75, p: "RW" },
            { x: 0.5, y: 0.85, p: "ST" },
          ],
        },
        "5-3-2": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.08, y: 0.22, p: "LWB" },
            { x: 0.28, y: 0.15, p: "CB" },
            { x: 0.5, y: 0.12, p: "CB" },
            { x: 0.72, y: 0.15, p: "CB" },
            { x: 0.92, y: 0.22, p: "RWB" },
            { x: 0.25, y: 0.35, p: "CM" },
            { x: 0.5, y: 0.32, p: "CM" },
            { x: 0.75, y: 0.35, p: "CM" },
            { x: 0.35, y: 0.52, p: "ST" },
            { x: 0.65, y: 0.52, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.06, y: 0.48, p: "LWB" },
            { x: 0.28, y: 0.30, p: "CB" },
            { x: 0.5, y: 0.27, p: "CB" },
            { x: 0.72, y: 0.30, p: "CB" },
            { x: 0.94, y: 0.48, p: "RWB" },
            { x: 0.25, y: 0.60, p: "CM" },
            { x: 0.5, y: 0.58, p: "CM" },
            { x: 0.75, y: 0.60, p: "CM" },
            { x: 0.35, y: 0.82, p: "ST" },
            { x: 0.65, y: 0.82, p: "ST" },
          ],
        },
        "4-1-4-1": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.15, p: "CB" },
            { x: 0.62, y: 0.15, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.5, y: 0.28, p: "CDM" },
            { x: 0.1, y: 0.42, p: "LM" },
            { x: 0.37, y: 0.4, p: "CM" },
            { x: 0.63, y: 0.4, p: "CM" },
            { x: 0.9, y: 0.42, p: "RM" },
            { x: 0.5, y: 0.56, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.5, y: 0.50, p: "CDM" },
            { x: 0.08, y: 0.68, p: "LM" },
            { x: 0.35, y: 0.65, p: "CM" },
            { x: 0.65, y: 0.65, p: "CM" },
            { x: 0.92, y: 0.68, p: "RM" },
            { x: 0.5, y: 0.85, p: "ST" },
          ],
        },
        "3-1-4-2": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.12, p: "CB" },
            { x: 0.5, y: 0.09, p: "CB" },
            { x: 0.75, y: 0.12, p: "CB" },
            { x: 0.5, y: 0.22, p: "CDM" },
            { x: 0.15, y: 0.35, p: "LM" },
            { x: 0.38, y: 0.30, p: "CM" },
            { x: 0.62, y: 0.30, p: "CM" },
            { x: 0.85, y: 0.35, p: "RM" },
            { x: 0.35, y: 0.48, p: "ST" },
            { x: 0.65, y: 0.48, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.28, p: "CB" },
            { x: 0.5, y: 0.25, p: "CB" },
            { x: 0.75, y: 0.28, p: "CB" },
            { x: 0.5, y: 0.45, p: "CDM" },
            { x: 0.12, y: 0.65, p: "LM" },
            { x: 0.35, y: 0.60, p: "CM" },
            { x: 0.65, y: 0.60, p: "CM" },
            { x: 0.88, y: 0.65, p: "RM" },
            { x: 0.30, y: 0.82, p: "ST" },
            { x: 0.70, y: 0.82, p: "ST" },
          ],
        },
        "3-2-3-2": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.12, p: "CB" },
            { x: 0.5, y: 0.09, p: "CB" },
            { x: 0.75, y: 0.12, p: "CB" },
            { x: 0.35, y: 0.24, p: "CDM" },
            { x: 0.65, y: 0.24, p: "CDM" },
            { x: 0.15, y: 0.42, p: "LM" },
            { x: 0.5, y: 0.38, p: "CAM" },
            { x: 0.85, y: 0.42, p: "RM" },
            { x: 0.35, y: 0.54, p: "ST" },
            { x: 0.65, y: 0.54, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.28, p: "CB" },
            { x: 0.5, y: 0.25, p: "CB" },
            { x: 0.75, y: 0.28, p: "CB" },
            { x: 0.35, y: 0.48, p: "CDM" },
            { x: 0.65, y: 0.48, p: "CDM" },
            { x: 0.12, y: 0.68, p: "LM" },
            { x: 0.5, y: 0.65, p: "CAM" },
            { x: 0.88, y: 0.68, p: "RM" },
            { x: 0.30, y: 0.82, p: "ST" },
            { x: 0.70, y: 0.82, p: "ST" },
          ],
        },
        "3-2-4-1": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.12, p: "CB" },
            { x: 0.5, y: 0.09, p: "CB" },
            { x: 0.75, y: 0.12, p: "CB" },
            { x: 0.35, y: 0.24, p: "CDM" },
            { x: 0.65, y: 0.24, p: "CDM" },
            { x: 0.1, y: 0.44, p: "LM" },
            { x: 0.35, y: 0.40, p: "CAM" },
            { x: 0.65, y: 0.40, p: "CAM" },
            { x: 0.9, y: 0.44, p: "RM" },
            { x: 0.5, y: 0.56, p: "CF" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.28, p: "CB" },
            { x: 0.5, y: 0.25, p: "CB" },
            { x: 0.75, y: 0.28, p: "CB" },
            { x: 0.35, y: 0.48, p: "CDM" },
            { x: 0.65, y: 0.48, p: "CDM" },
            { x: 0.08, y: 0.70, p: "LM" },
            { x: 0.32, y: 0.65, p: "CAM" },
            { x: 0.68, y: 0.65, p: "CAM" },
            { x: 0.92, y: 0.70, p: "RM" },
            { x: 0.5, y: 0.85, p: "CF" },
          ],
        },
        "3-4-1-2": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.12, p: "CB" },
            { x: 0.5, y: 0.09, p: "CB" },
            { x: 0.75, y: 0.12, p: "CB" },
            { x: 0.1, y: 0.30, p: "LM" },
            { x: 0.35, y: 0.24, p: "CM" },
            { x: 0.65, y: 0.24, p: "CM" },
            { x: 0.9, y: 0.30, p: "RM" },
            { x: 0.5, y: 0.40, p: "CAM" },
            { x: 0.35, y: 0.52, p: "ST" },
            { x: 0.65, y: 0.52, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.28, p: "CB" },
            { x: 0.5, y: 0.25, p: "CB" },
            { x: 0.75, y: 0.28, p: "CB" },
            { x: 0.08, y: 0.58, p: "LM" },
            { x: 0.32, y: 0.52, p: "CM" },
            { x: 0.68, y: 0.52, p: "CM" },
            { x: 0.92, y: 0.58, p: "RM" },
            { x: 0.5, y: 0.70, p: "CAM" },
            { x: 0.30, y: 0.82, p: "ST" },
            { x: 0.70, y: 0.82, p: "ST" },
          ],
        },
        "3-4-2-1": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.12, p: "CB" },
            { x: 0.5, y: 0.09, p: "CB" },
            { x: 0.75, y: 0.12, p: "CB" },
            { x: 0.1, y: 0.32, p: "LM" },
            { x: 0.37, y: 0.26, p: "CM" },
            { x: 0.63, y: 0.26, p: "CM" },
            { x: 0.9, y: 0.32, p: "RM" },
            { x: 0.25, y: 0.46, p: "LF" },
            { x: 0.75, y: 0.46, p: "RF" },
            { x: 0.5, y: 0.56, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.28, p: "CB" },
            { x: 0.5, y: 0.25, p: "CB" },
            { x: 0.75, y: 0.28, p: "CB" },
            { x: 0.08, y: 0.60, p: "LM" },
            { x: 0.35, y: 0.55, p: "CM" },
            { x: 0.65, y: 0.55, p: "CM" },
            { x: 0.92, y: 0.60, p: "RM" },
            { x: 0.25, y: 0.75, p: "LF" },
            { x: 0.75, y: 0.75, p: "RF" },
            { x: 0.5, y: 0.85, p: "ST" },
          ],
        },
        "3-4-3": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.12, p: "CB" },
            { x: 0.5, y: 0.09, p: "CB" },
            { x: 0.75, y: 0.12, p: "CB" },
            { x: 0.1, y: 0.32, p: "LM" },
            { x: 0.37, y: 0.26, p: "CM" },
            { x: 0.63, y: 0.26, p: "CM" },
            { x: 0.9, y: 0.32, p: "RM" },
            { x: 0.2, y: 0.48, p: "LW" },
            { x: 0.5, y: 0.50, p: "ST" },
            { x: 0.8, y: 0.48, p: "RW" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.28, p: "CB" },
            { x: 0.5, y: 0.25, p: "CB" },
            { x: 0.75, y: 0.28, p: "CB" },
            { x: 0.08, y: 0.60, p: "LM" },
            { x: 0.35, y: 0.55, p: "CM" },
            { x: 0.65, y: 0.55, p: "CM" },
            { x: 0.92, y: 0.60, p: "RM" },
            { x: 0.12, y: 0.82, p: "LW" },
            { x: 0.5, y: 0.85, p: "ST" },
            { x: 0.88, y: 0.82, p: "RW" },
          ],
        },
        "3-5-1-1": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.12, p: "CB" },
            { x: 0.5, y: 0.09, p: "CB" },
            { x: 0.75, y: 0.12, p: "CB" },
            { x: 0.08, y: 0.30, p: "LM" },
            { x: 0.3, y: 0.26, p: "CDM" },
            { x: 0.5, y: 0.24, p: "CM" },
            { x: 0.7, y: 0.26, p: "CDM" },
            { x: 0.92, y: 0.30, p: "RM" },
            { x: 0.5, y: 0.42, p: "CF" },
            { x: 0.5, y: 0.54, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.25, y: 0.28, p: "CB" },
            { x: 0.5, y: 0.25, p: "CB" },
            { x: 0.75, y: 0.28, p: "CB" },
            { x: 0.06, y: 0.58, p: "LM" },
            { x: 0.28, y: 0.52, p: "CDM" },
            { x: 0.5, y: 0.50, p: "CM" },
            { x: 0.72, y: 0.52, p: "CDM" },
            { x: 0.94, y: 0.58, p: "RM" },
            { x: 0.5, y: 0.72, p: "CF" },
            { x: 0.5, y: 0.85, p: "ST" },
          ],
        },
        "4-1-2-1-2": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.15, p: "CB" },
            { x: 0.62, y: 0.15, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.5, y: 0.28, p: "CDM" },
            { x: 0.35, y: 0.40, p: "CM" },
            { x: 0.65, y: 0.40, p: "CM" },
            { x: 0.5, y: 0.48, p: "CAM" },
            { x: 0.35, y: 0.56, p: "ST" },
            { x: 0.65, y: 0.56, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.5, y: 0.50, p: "CDM" },
            { x: 0.32, y: 0.62, p: "CM" },
            { x: 0.68, y: 0.62, p: "CM" },
            { x: 0.5, y: 0.72, p: "CAM" },
            { x: 0.30, y: 0.82, p: "ST" },
            { x: 0.70, y: 0.82, p: "ST" },
          ],
        },
        "4-1-2-3": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.15, p: "CB" },
            { x: 0.62, y: 0.15, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.5, y: 0.28, p: "CDM" },
            { x: 0.35, y: 0.38, p: "CM" },
            { x: 0.65, y: 0.38, p: "CM" },
            { x: 0.2, y: 0.50, p: "LW" },
            { x: 0.5, y: 0.52, p: "ST" },
            { x: 0.8, y: 0.50, p: "RW" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.5, y: 0.50, p: "CDM" },
            { x: 0.32, y: 0.62, p: "CM" },
            { x: 0.68, y: 0.62, p: "CM" },
            { x: 0.12, y: 0.78, p: "LW" },
            { x: 0.5, y: 0.85, p: "ST" },
            { x: 0.88, y: 0.78, p: "RW" },
          ],
        },
        "4-1-3-2": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.15, p: "CB" },
            { x: 0.62, y: 0.15, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.5, y: 0.28, p: "CDM" },
            { x: 0.2, y: 0.40, p: "LM" },
            { x: 0.5, y: 0.38, p: "CM" },
            { x: 0.8, y: 0.40, p: "RM" },
            { x: 0.35, y: 0.52, p: "ST" },
            { x: 0.65, y: 0.52, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.5, y: 0.50, p: "CDM" },
            { x: 0.15, y: 0.65, p: "LM" },
            { x: 0.5, y: 0.62, p: "CM" },
            { x: 0.85, y: 0.65, p: "RM" },
            { x: 0.30, y: 0.82, p: "ST" },
            { x: 0.70, y: 0.82, p: "ST" },
          ],
        },
        "4-2-2-2": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.15, p: "CB" },
            { x: 0.62, y: 0.15, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.35, y: 0.28, p: "CDM" },
            { x: 0.65, y: 0.28, p: "CDM" },
            { x: 0.28, y: 0.44, p: "CAM" },
            { x: 0.72, y: 0.44, p: "CAM" },
            { x: 0.35, y: 0.56, p: "ST" },
            { x: 0.65, y: 0.56, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.35, y: 0.50, p: "CDM" },
            { x: 0.65, y: 0.50, p: "CDM" },
            { x: 0.25, y: 0.70, p: "CAM" },
            { x: 0.75, y: 0.70, p: "CAM" },
            { x: 0.30, y: 0.82, p: "ST" },
            { x: 0.70, y: 0.82, p: "ST" },
          ],
        },
        "4-2-3-1": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.15, p: "CB" },
            { x: 0.62, y: 0.15, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.35, y: 0.28, p: "CDM" },
            { x: 0.65, y: 0.28, p: "CDM" },
            { x: 0.2, y: 0.44, p: "CAM" },
            { x: 0.5, y: 0.42, p: "CAM" },
            { x: 0.8, y: 0.44, p: "CAM" },
            { x: 0.5, y: 0.56, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.35, y: 0.50, p: "CDM" },
            { x: 0.65, y: 0.50, p: "CDM" },
            { x: 0.15, y: 0.72, p: "CAM" },
            { x: 0.5, y: 0.70, p: "CAM" },
            { x: 0.85, y: 0.72, p: "CAM" },
            { x: 0.5, y: 0.85, p: "ST" },
          ],
        },
        "4-2-4": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.15, p: "CB" },
            { x: 0.62, y: 0.15, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.35, y: 0.28, p: "CM" },
            { x: 0.65, y: 0.28, p: "CM" },
            { x: 0.15, y: 0.46, p: "LW" },
            { x: 0.38, y: 0.50, p: "ST" },
            { x: 0.62, y: 0.50, p: "ST" },
            { x: 0.85, y: 0.46, p: "RW" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.35, y: 0.52, p: "CM" },
            { x: 0.65, y: 0.52, p: "CM" },
            { x: 0.12, y: 0.75, p: "LW" },
            { x: 0.35, y: 0.82, p: "ST" },
            { x: 0.65, y: 0.82, p: "ST" },
            { x: 0.88, y: 0.75, p: "RW" },
          ],
        },
        "4-3-1-2": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.15, p: "CB" },
            { x: 0.62, y: 0.15, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.25, y: 0.30, p: "CM" },
            { x: 0.5, y: 0.28, p: "CM" },
            { x: 0.75, y: 0.30, p: "CM" },
            { x: 0.5, y: 0.44, p: "CAM" },
            { x: 0.35, y: 0.56, p: "ST" },
            { x: 0.65, y: 0.56, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.22, y: 0.58, p: "CM" },
            { x: 0.5, y: 0.55, p: "CM" },
            { x: 0.78, y: 0.58, p: "CM" },
            { x: 0.5, y: 0.72, p: "CAM" },
            { x: 0.30, y: 0.82, p: "ST" },
            { x: 0.70, y: 0.82, p: "ST" },
          ],
        },
        "4-3-2-1": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.15, p: "CB" },
            { x: 0.62, y: 0.15, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.25, y: 0.30, p: "CM" },
            { x: 0.5, y: 0.28, p: "CM" },
            { x: 0.75, y: 0.30, p: "CM" },
            { x: 0.3, y: 0.48, p: "LF" },
            { x: 0.7, y: 0.48, p: "RF" },
            { x: 0.5, y: 0.58, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.22, y: 0.58, p: "CM" },
            { x: 0.5, y: 0.55, p: "CM" },
            { x: 0.78, y: 0.58, p: "CM" },
            { x: 0.25, y: 0.75, p: "LF" },
            { x: 0.75, y: 0.75, p: "RF" },
            { x: 0.5, y: 0.85, p: "ST" },
          ],
        },
        "4-4-1-1": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.15, p: "CB" },
            { x: 0.62, y: 0.15, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.15, y: 0.38, p: "LM" },
            { x: 0.38, y: 0.32, p: "CM" },
            { x: 0.62, y: 0.32, p: "CM" },
            { x: 0.85, y: 0.38, p: "RM" },
            { x: 0.5, y: 0.48, p: "CF" },
            { x: 0.5, y: 0.58, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.12, y: 0.65, p: "LM" },
            { x: 0.35, y: 0.58, p: "CM" },
            { x: 0.65, y: 0.58, p: "CM" },
            { x: 0.88, y: 0.65, p: "RM" },
            { x: 0.5, y: 0.75, p: "CF" },
            { x: 0.5, y: 0.85, p: "ST" },
          ],
        },
        "4-5-1": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.18, p: "LB" },
            { x: 0.38, y: 0.15, p: "CB" },
            { x: 0.62, y: 0.15, p: "CB" },
            { x: 0.87, y: 0.18, p: "RB" },
            { x: 0.1, y: 0.38, p: "LM" },
            { x: 0.35, y: 0.32, p: "CM" },
            { x: 0.5, y: 0.30, p: "CDM" },
            { x: 0.65, y: 0.32, p: "CM" },
            { x: 0.9, y: 0.38, p: "RM" },
            { x: 0.5, y: 0.56, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.13, y: 0.35, p: "LB" },
            { x: 0.38, y: 0.30, p: "CB" },
            { x: 0.62, y: 0.30, p: "CB" },
            { x: 0.87, y: 0.35, p: "RB" },
            { x: 0.08, y: 0.68, p: "LM" },
            { x: 0.32, y: 0.60, p: "CM" },
            { x: 0.5, y: 0.58, p: "CDM" },
            { x: 0.68, y: 0.60, p: "CM" },
            { x: 0.92, y: 0.68, p: "RM" },
            { x: 0.5, y: 0.85, p: "ST" },
          ],
        },
        "5-2-1-2": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.08, y: 0.22, p: "LWB" },
            { x: 0.28, y: 0.15, p: "CB" },
            { x: 0.5, y: 0.12, p: "CB" },
            { x: 0.72, y: 0.15, p: "CB" },
            { x: 0.92, y: 0.22, p: "RWB" },
            { x: 0.35, y: 0.32, p: "CM" },
            { x: 0.65, y: 0.32, p: "CM" },
            { x: 0.5, y: 0.45, p: "CAM" },
            { x: 0.35, y: 0.56, p: "ST" },
            { x: 0.65, y: 0.56, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.06, y: 0.48, p: "LWB" },
            { x: 0.28, y: 0.30, p: "CB" },
            { x: 0.5, y: 0.27, p: "CB" },
            { x: 0.72, y: 0.30, p: "CB" },
            { x: 0.94, y: 0.48, p: "RWB" },
            { x: 0.32, y: 0.62, p: "CM" },
            { x: 0.68, y: 0.62, p: "CM" },
            { x: 0.5, y: 0.72, p: "CAM" },
            { x: 0.30, y: 0.82, p: "ST" },
            { x: 0.70, y: 0.82, p: "ST" },
          ],
        },
        "5-2-2-1": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.08, y: 0.22, p: "LWB" },
            { x: 0.28, y: 0.15, p: "CB" },
            { x: 0.5, y: 0.12, p: "CB" },
            { x: 0.72, y: 0.15, p: "CB" },
            { x: 0.92, y: 0.22, p: "RWB" },
            { x: 0.35, y: 0.32, p: "CM" },
            { x: 0.65, y: 0.32, p: "CM" },
            { x: 0.25, y: 0.48, p: "LW" },
            { x: 0.75, y: 0.48, p: "RW" },
            { x: 0.5, y: 0.58, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.06, y: 0.48, p: "LWB" },
            { x: 0.28, y: 0.30, p: "CB" },
            { x: 0.5, y: 0.27, p: "CB" },
            { x: 0.72, y: 0.30, p: "CB" },
            { x: 0.94, y: 0.48, p: "RWB" },
            { x: 0.32, y: 0.62, p: "CM" },
            { x: 0.68, y: 0.62, p: "CM" },
            { x: 0.18, y: 0.78, p: "LW" },
            { x: 0.82, y: 0.78, p: "RW" },
            { x: 0.5, y: 0.85, p: "ST" },
          ],
        },
        "5-2-3": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.08, y: 0.22, p: "LWB" },
            { x: 0.28, y: 0.15, p: "CB" },
            { x: 0.5, y: 0.12, p: "CB" },
            { x: 0.72, y: 0.15, p: "CB" },
            { x: 0.92, y: 0.22, p: "RWB" },
            { x: 0.35, y: 0.32, p: "CM" },
            { x: 0.65, y: 0.32, p: "CM" },
            { x: 0.20, y: 0.52, p: "LW" },
            { x: 0.5, y: 0.54, p: "ST" },
            { x: 0.80, y: 0.52, p: "RW" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.06, y: 0.48, p: "LWB" },
            { x: 0.28, y: 0.30, p: "CB" },
            { x: 0.5, y: 0.27, p: "CB" },
            { x: 0.72, y: 0.30, p: "CB" },
            { x: 0.94, y: 0.48, p: "RWB" },
            { x: 0.32, y: 0.62, p: "CM" },
            { x: 0.68, y: 0.62, p: "CM" },
            { x: 0.12, y: 0.82, p: "LW" },
            { x: 0.5, y: 0.85, p: "ST" },
            { x: 0.88, y: 0.82, p: "RW" },
          ],
        },
        "5-4-1": {
          d: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.08, y: 0.22, p: "LWB" },
            { x: 0.28, y: 0.15, p: "CB" },
            { x: 0.5, y: 0.12, p: "CB" },
            { x: 0.72, y: 0.15, p: "CB" },
            { x: 0.92, y: 0.22, p: "RWB" },
            { x: 0.15, y: 0.38, p: "LM" },
            { x: 0.38, y: 0.34, p: "CM" },
            { x: 0.62, y: 0.34, p: "CM" },
            { x: 0.85, y: 0.38, p: "RM" },
            { x: 0.5, y: 0.56, p: "ST" },
          ],
          a: [
            { x: 0.5, y: 0.04, p: "GK" },
            { x: 0.06, y: 0.48, p: "LWB" },
            { x: 0.28, y: 0.30, p: "CB" },
            { x: 0.5, y: 0.27, p: "CB" },
            { x: 0.72, y: 0.30, p: "CB" },
            { x: 0.94, y: 0.48, p: "RWB" },
            { x: 0.12, y: 0.68, p: "LM" },
            { x: 0.35, y: 0.62, p: "CM" },
            { x: 0.65, y: 0.62, p: "CM" },
            { x: 0.88, y: 0.68, p: "RM" },
            { x: 0.5, y: 0.85, p: "ST" },
          ],
        },
      };

      const LN = [
        "Silva",
        "Kim",
        "Park",
        "Mohamed",
        "Ali",
        "Santos",
        "LÃ³pez",
        "MÃ¼ller",
        "Petrov",
        "Tanaka",
        "Hassan",
        "Ahmed",
        "Diallo",
        "TourÃ©",
        "Nakamura",
        "Lee",
        "Chen",
        "Okafor",
        "Ndiaye",
        "HernÃ¡ndez",
        "Johansson",
        "Eriksen",
        "Nielsen",
        "Popov",
        "Ivanov",
        "Novak",
        "HorvÃ¡th",
        "KovÃ¡cs",
        "Rossi",
        "Schmidt",
        "GarcÃ­a",
        "FernÃ¡ndez",
        "GonzÃ¡lez",
        "RodrÃ­guez",
        "MartÃ­nez",
        "SÃ¡nchez",
      ];
      function gNames() {
        const n = [];
        const u = new Set();
        for (let i = 0; i < 11; i++) {
          let s;
          do {
            s = LN[Math.floor(Math.random() * LN.length)];
          } while (u.has(s) && u.size < LN.length);
          u.add(s);
          n.push(s);
        }
        return n;
      }

      const C = document.getElementById("gameCanvas"),
        X = C.getContext("2d");
      let G = {
        mode: "menu",
        state: "menu",
        turn: "home",
        hs: 0,
        as: 0,
        ht: null,
        at: null,
        hf: "4-3-3",
        af: "4-4-2",
        pl: { home: [], away: [] },
        ball: { x: 0, y: 0, r: 5 },
        sel: null,
        ds: null,
        dc: null,
        fw: 0,
        fh: 0,
        fx: 0,
        fy: 0,
        gw: 0,
        gh: 0,
        anims: [],
        // mg: 5, // REMOVED - No more goal limit
        matchTime: 0, // Current match time (0-90 seconds, represents 90 minutes)
        matchDuration: 90, // Match duration in seconds (= 90 minutes)
        matchStartTime: null, // Timestamp when match started
        matchTimerSpeed: 1, // 1 second = 1 minute (90 real seconds = 90 game minutes)
        cup: null,
        step: "home",
        poss: "home",
        lastK: null,
        passesAfterWin: 0,
        ballWinner: null, // Ki szerezte meg a labdÃ¡t
        useMySquad: false, // Use user's custom squad instead of country team
        
        // PLAYER DATABASE & USER PROGRESSION
        playersDB: [], // 2079 players from JSON
        userSquad: {
          players: [], // Player IDs (max 23)
          formation: '4-3-3',
          coins: 0,
          level: 1,
          xp: 0,
          nextLevelXP: 1000
        },
        userCollection: new Set(), // All owned player IDs
      };
      const FR = 1.5;

      function resize() {
        const c = document.getElementById("gameContainer"),
          sb = document.getElementById("scoreboard");
        C.width = c.clientWidth;
        C.height = c.clientHeight - (sb.classList.contains("active") ? 50 : 0);
        const p = 10,
          aW = C.width - p * 2,
          aH = C.height - p * 2;
        if (aH / aW > FR) {
          G.fw = aW;
          G.fh = G.fw * FR;
        } else {
          G.fh = aH;
          G.fw = G.fh / FR;
        }
        G.fx = (C.width - G.fw) / 2;
        G.fy = (C.height - G.fh) / 2;
        G.gw = G.fw * 0.26;
        G.gh = G.fh * 0.035;
        G.ball.r = Math.max(4, G.fw * 0.013);
      }

      function initP() {
        // Check if we should use user's custom squad
        if (G.useMySquad && G.playersDB.length > 0) {
          initUserSquad();
          return;
        }
        
        // Original generic player initialization
        ["home", "away"].forEach((t) => {
          const fm = t === "home" ? G.hf : G.af;
          const fd = FMS[fm];
          const nm = gNames();
          const ps = G.poss === t ? fd.a : fd.d;
          G.pl[t] = ps.map((pp, i) => {
            let fx, fy;
            if (t === "home") {
              fx = G.fx + pp.x * G.fw;
              fy = G.fy + G.fh - pp.y * G.fh;
            } else {
              fx = G.fx + (1 - pp.x) * G.fw;
              fy = G.fy + pp.y * G.fh;
            }
            return {
              id: `${t}_${i}`,
              team: t,
              name: nm[i],
              position: pp.p,
              bx: fx,
              by: fy,
              x: fx,
              y: fy,
              r: Math.max(9, G.fw * 0.025),
              hb: false,
              num: i === 0 ? 1 : i + 1,
              // MozgÃ¡s vÃ¡ltozÃ³k
              moveTargetX: fx,
              moveTargetY: fy,
              moveTimer: Math.random() * 2000, // Random kezdÃ©s
              moveState: 'rest', // 'moving' vagy 'rest'
            };
          });
        });
        G.ball.x = G.fx + G.fw / 2;
        G.ball.y = G.fy + G.fh / 2;
        abn(G.turn);
      }
      
      // Load user's custom squad into match
      function initUserSquad() {
        const formation = G.hf;
        const fd = FMS[formation];
        const ps = G.poss === "home" ? fd.a : fd.d;
        
        // Load home team from user's squad
        G.pl.home = ps.map((pp, i) => {
          // Get player from squad (if exists)
          const playerId = G.userSquad.players[i];
          const player = playerId ? getPlayerById(playerId) : null;
          
          let fx = G.fx + pp.x * G.fw;
          let fy = G.fy + G.fh - pp.y * G.fh;
          
          return {
            id: `home_${i}`,
            team: 'home',
            name: player ? player.name : '???',
            position: pp.p,
            bx: fx,
            by: fy,
            x: fx,
            y: fy,
            r: Math.max(9, G.fw * 0.025),
            hb: false,
            num: i === 0 ? 1 : i + 1,
            moveTargetX: fx,
            moveTargetY: fy,
            moveTimer: Math.random() * 2000,
            moveState: 'rest',
            
            // PLAYER STATS (from database)
            playerData: player, // Full player object
            speed: player ? player.speed : 70,
            stamina: player ? player.stamina : 70,
            shooting: player ? player.shooting : 70,
            passing: player ? player.passing : 70,
            tackling: player ? player.tackling : 70,
            marking: player ? player.marking : 70,
            positioning: player ? player.positioning : 70,
            reflexes: player ? player.reflexes : 70,
            finishing: player ? player.finishing : 70,
            composure: player ? player.composure : 70,
            currentStamina: player ? player.stamina : 70, // Starts at max
          };
        });
        
        // Away team is still generic
        const awayFm = G.af;
        const awayFd = FMS[awayFm];
        const awayPs = G.poss === "away" ? awayFd.a : awayFd.d;
        const nm = gNames();
        
        G.pl.away = awayPs.map((pp, i) => {
          let fx = G.fx + (1 - pp.x) * G.fw;
          let fy = G.fy + pp.y * G.fh;
          
          return {
            id: `away_${i}`,
            team: 'away',
            name: nm[i],
            position: pp.p,
            bx: fx,
            by: fy,
            x: fx,
            y: fy,
            r: Math.max(9, G.fw * 0.025),
            hb: false,
            num: i === 0 ? 1 : i + 1,
            moveTargetX: fx,
            moveTargetY: fy,
            moveTimer: Math.random() * 2000,
            moveState: 'rest',
            
            // Generic stats for AI
            speed: 70,
            stamina: 70,
            shooting: 70,
            passing: 70,
            tackling: 70,
            currentStamina: 70,
          };
        });
        
        G.ball.x = G.fx + G.fw / 2;
        G.ball.y = G.fy + G.fh / 2;
        abn(G.turn);
      }
      
      function abn(t) {
        let md = 1e9,
          cl = null;
        G.pl[t].forEach((p) => {
          const d = Math.hypot(p.x - G.ball.x, p.y - G.ball.y);
          if (d < md) {
            md = d;
            cl = p;
          }
        });
        if (cl) {
          G.pl.home.forEach((p) => (p.hb = false));
          G.pl.away.forEach((p) => (p.hb = false));
          cl.hb = true;
          
          // KRITIKUS: NE Ã¡llÃ­tsuk Ã¡t a bx,by-t!
          // A jÃ¡tÃ©kos maradjon ahol van, ne ugorjon vissza
          // cl.bx = cl.x;  â† TÃ–RÃ–LVE
          // cl.by = cl.y;  â† TÃ–RÃ–LVE
          
          cl.moveState = 'rest'; // MegÃ¡llÃ­tjuk a mozgÃ¡st
          
          // Labda a jÃ¡tÃ©koshoz
          G.ball.x = cl.x;
          G.ball.y = cl.y;
          G.sel = cl;
        }
      }

      function adjustPositions(team) {
        const minDist = 30;
        const players = G.pl[team];
        for (let i = 0; i < players.length; i++)
          for (let j = i + 1; j < players.length; j++) {
            const p1 = players[i],
              p2 = players[j],
              dx = p1.x - p2.x,
              dy = p1.y - p2.y,
              dist = Math.hypot(dx, dy);
            if (dist < minDist) {
              const overlap = minDist - dist,
                nx = dx / dist,
                ny = dy / dist;
              p1.x += (nx * overlap) / 2;
              p1.y += (ny * overlap) / 2;
              p2.x -= (nx * overlap) / 2;
              p2.y -= (ny * overlap) / 2;
              p1.bx = p1.x;
              p1.by = p1.y;
              p2.bx = p2.x;
              p2.by = p2.y;
            }
          }
      }

      function updFP(anim = true) {
        ["home", "away"].forEach((t) => {
          const fm = t === "home" ? G.hf : G.af;
          const fd = FMS[fm];
          const ps = G.poss === t ? fd.a : fd.d;
          G.pl[t].forEach((p, i) => {
            if (p.hb) return;
            
            // CSAK a labdÃ¡t szerzÅ‘ jÃ¡tÃ©kos marad vÃ©dekezÅ‘ben 1 passzig
            if (G.ballWinner && p.id === G.ballWinner.id && G.passesAfterWin < 1) {
              return;
            }
            
            const pp = ps[i];
            let fx, fy;
            if (t === "home") {
              fx = G.fx + pp.x * G.fw;
              fy = G.fy + G.fh - pp.y * G.fh;
            } else {
              fx = G.fx + (1 - pp.x) * G.fw;
              fy = G.fy + pp.y * G.fh;
            }
            
            // BeÃ¡llÃ­tjuk a CÃ‰L pozÃ­ciÃ³t (targetBx, targetBy)
            // Az updatePlayerMovement majd lassan odaviszi a bx,by-t
            if (anim) {
              p.targetBx = fx;
              p.targetBy = fy;
            } else {
              // Ha nincs animÃ¡ciÃ³, azonnal oda tesszÃ¼k
              p.bx = fx;
              p.by = fy;
              p.x = fx;
              p.y = fy;
            }
          });
        });
      }

      // Drawing
      function dF() {
        const { fx, fy, fw, fh } = G;
        
        // SÃ¶tÃ©tebb, realisztikusabb zÃ¶ld
        X.fillStyle = "#1a6b1a";
        X.fillRect(fx, fy, fw, fh);
        
        // CsÃ­kok (stripes) - sÃ¶tÃ©tebb Ã©s vilÃ¡gosabb
        for (let i = 0; i < 14; i++) {
          if (i % 2 === 0) {
            X.fillStyle = "rgba(0,0,0,.04)";
            X.fillRect(fx, fy + (fh / 14) * i, fw, fh / 14);
          }
        }
        
        // FehÃ©r vonalak - vastagabb Ã©s vilÃ¡gosabb
        X.strokeStyle = "rgba(255,255,255,.8)";
        X.lineWidth = 2;
        X.strokeRect(fx, fy, fw, fh);
        
        // KÃ¶zÃ©pvonal
        X.beginPath();
        X.moveTo(fx, fy + fh / 2);
        X.lineTo(fx + fw, fy + fh / 2);
        X.stroke();
        
        // KÃ¶zÃ©pkÃ¶r
        X.beginPath();
        X.arc(fx + fw / 2, fy + fh / 2, fw * 0.1, 0, Math.PI * 2);
        X.stroke();
        
        // KÃ¶zÃ©ppont
        X.fillStyle = "rgba(255,255,255,.9)";
        X.beginPath();
        X.arc(fx + fw / 2, fy + fh / 2, 3, 0, Math.PI * 2);
        X.fill();
        
        // Kapuk Ã©s 16-osok
        const gaW = fw * 0.44,
          gaH = fh * 0.065,
          paW = fw * 0.64,
          paH = fh * 0.13;
        X.strokeRect(fx + (fw - paW) / 2, fy, paW, paH);
        X.strokeRect(fx + (fw - gaW) / 2, fy, gaW, gaH);
        X.strokeRect(fx + (fw - paW) / 2, fy + fh - paH, paW, paH);
        X.strokeRect(fx + (fw - gaW) / 2, fy + fh - gaH, gaW, gaH);
        
        // BÃ¼ntetÅ‘pontok
        X.fillStyle = "rgba(255,255,255,.9)";
        X.beginPath();
        X.arc(fx + fw / 2, fy + fh * 0.1, 2.5, 0, Math.PI * 2);
        X.fill();
        X.beginPath();
        X.arc(fx + fw / 2, fy + fh * 0.9, 2.5, 0, Math.PI * 2);
        X.fill();
        
        // BÃ¼ntetÅ‘Ã­v felsÅ‘
        X.beginPath();
        X.arc(
          fx + fw / 2,
          fy + fh * 0.1,
          fw * 0.08,
          0.2 * Math.PI,
          0.8 * Math.PI,
        );
        X.stroke();
        
        // BÃ¼ntetÅ‘Ã­v alsÃ³
        X.beginPath();
        X.arc(
          fx + fw / 2,
          fy + fh * 0.9,
          fw * 0.08,
          1.2 * Math.PI,
          1.8 * Math.PI,
        );
        X.stroke();
        const gw = G.gw;
        dGN(fx + (fw - gw) / 2, fy - G.gh, gw, G.gh, "#60a5fa");
        dGN(fx + (fw - gw) / 2, fy + fh, gw, G.gh, "#f87171");
      }
      function dGN(x, y, w, h, c) {
        X.fillStyle = c + "20";
        X.fillRect(x, y, w, h);
        X.strokeStyle = c;
        X.lineWidth = 2;
        X.strokeRect(x, y, w, h);
        X.strokeStyle = c + "25";
        X.lineWidth = 0.4;
        for (let i = x; i <= x + w; i += 5) {
          X.beginPath();
          X.moveTo(i, y);
          X.lineTo(i, y + h);
          X.stroke();
        }
        for (let j = y; j <= y + h; j += 5) {
          X.beginPath();
          X.moveTo(x, j);
          X.lineTo(x + w, j);
          X.stroke();
        }
      }

      function dP() {
        [...G.pl.home, ...G.pl.away].forEach((p) => {
          const ih = p.team === "home",
            is = G.sel && G.sel.id === p.id,
            ic = p.team === G.turn;
          
          // ÃrnyÃ©k - nagyobb Ã©s lÃ¡gyabb
          X.fillStyle = "rgba(0,0,0,.3)";
          X.beginPath();
          X.ellipse(p.x + 1, p.y + 3, p.r * 1.1, p.r * 0.6, 0, 0, Math.PI * 2);
          X.fill();
          
          // JÃ¡tÃ©kos szÃ­nek - Ã©lÃ©nkebb
          const mc = ih ? "#1d4ed8" : "#dc2626", // SÃ¶tÃ©tebb kÃ©k/piros
            lc = ih ? "#60a5fa" : "#f87171",      // VilÃ¡gosabb kÃ©k/piros
            hc = ih ? "#bfdbfe" : "#fecaca";      // Highlight szÃ­n
          
          // 3D gradient effekt
          const gr = X.createRadialGradient(p.x - p.r * 0.3, p.y - p.r * 0.3, 1, p.x, p.y, p.r);
          gr.addColorStop(0, hc);
          gr.addColorStop(0.4, lc);
          gr.addColorStop(1, mc);
          
          X.fillStyle = gr;
          X.beginPath();
          X.arc(p.x, p.y, p.r, 0, Math.PI * 2);
          X.fill();
          
          // KÃ¼lsÅ‘ kÃ¶r (outline)
          X.strokeStyle = is
            ? "#facc15"
            : ic
              ? "rgba(255,255,255,.7)"
              : "rgba(255,255,255,.3)";
          X.lineWidth = is ? 3 : 1.5;
          X.stroke();
          
          // KijelÃ¶lt jÃ¡tÃ©kos extra effekt
          if (is && G.state === "playing") {
            X.strokeStyle = "#facc1570";
            X.lineWidth = 2;
            X.beginPath();
            X.arc(p.x, p.y, p.r + 5, 0, Math.PI * 2);
            X.stroke();
            
            // PulzÃ¡lÃ³ effekt
            const pulse = Math.sin(Date.now() / 200) * 0.3 + 0.7;
            X.strokeStyle = `rgba(250, 204, 21, ${pulse * 0.4})`;
            X.lineWidth = 1.5;
            X.beginPath();
            X.arc(p.x, p.y, p.r + 8, 0, Math.PI * 2);
            X.stroke();
          }
          
          // LabdÃ¡t birtoklÃ³ jÃ¡tÃ©kos jelzÃ©s
          if (p.hb) {
            X.strokeStyle = "#facc15";
            X.lineWidth = 2;
            X.setLineDash([4, 4]);
            X.beginPath();
            X.arc(p.x, p.y, p.r + 7, 0, Math.PI * 2);
            X.stroke();
            X.setLineDash([]);
          }
          
          // SzÃ¡m a jÃ¡tÃ©koson - Ã¡rnyÃ©kkal
          X.fillStyle = "rgba(0,0,0,.4)";
          X.font = `bold ${Math.max(8, p.r * 0.7)}px 'Barlow Condensed',sans-serif`;
          X.textAlign = "center";
          X.textBaseline = "middle";
          X.fillText(p.num, p.x + 0.5, p.y + 0.5);
          
          X.fillStyle = "#fff";
          X.fillText(p.num, p.x, p.y);
          
          // PozÃ­ciÃ³ nÃ©v - Ã¡rnyÃ©kkal
          X.fillStyle = "rgba(0,0,0,.5)";
          X.font = `bold ${Math.max(6, p.r * 0.45)}px 'Barlow Condensed',sans-serif`;
          X.fillText(p.position, p.x + 0.5, p.y + p.r + 7.5);
          
          X.fillStyle = "rgba(255,255,255,.85)";
          X.fillText(p.position, p.x, p.y + p.r + 7);
        });
      }

      function dB() {
        const b = G.ball;
        
        // ÃrnyÃ©k - nagyobb Ã©s lÃ¡gyabb
        X.fillStyle = "rgba(0,0,0,.35)";
        X.beginPath();
        X.ellipse(b.x + 1, b.y + 2, b.r * 1.2, b.r * 0.6, 0, 0, Math.PI * 2);
        X.fill();
        
        // Labda fehÃ©r alapszÃ­n - 3D gradient
        const gr = X.createRadialGradient(b.x - b.r * 0.3, b.y - b.r * 0.3, 1, b.x, b.y, b.r);
        gr.addColorStop(0, "#ffffff");
        gr.addColorStop(0.7, "#f0f0f0");
        gr.addColorStop(1, "#d0d0d0");
        
        X.fillStyle = gr;
        X.beginPath();
        X.arc(b.x, b.y, b.r, 0, Math.PI * 2);
        X.fill();
        
        // Fekete Ã¶tszÃ¶gek (egyszerÅ±sÃ­tett focilabda minta)
        X.fillStyle = "#1a1a1a";
        
        // FelsÅ‘ Ã¶tszÃ¶g
        X.beginPath();
        for (let i = 0; i < 5; i++) {
          const angle = (i * 2 * Math.PI) / 5 - Math.PI / 2;
          const x = b.x + Math.cos(angle) * b.r * 0.4;
          const y = b.y - b.r * 0.5 + Math.sin(angle) * b.r * 0.4;
          if (i === 0) X.moveTo(x, y);
          else X.lineTo(x, y);
        }
        X.closePath();
        X.fill();
        
        // Bal oldal Ã¶tszÃ¶g
        X.beginPath();
        for (let i = 0; i < 5; i++) {
          const angle = (i * 2 * Math.PI) / 5 + Math.PI / 6;
          const x = b.x - b.r * 0.5 + Math.cos(angle) * b.r * 0.35;
          const y = b.y + Math.sin(angle) * b.r * 0.35;
          if (i === 0) X.moveTo(x, y);
          else X.lineTo(x, y);
        }
        X.closePath();
        X.fill();
        
        // Jobb oldal Ã¶tszÃ¶g
        X.beginPath();
        for (let i = 0; i < 5; i++) {
          const angle = (i * 2 * Math.PI) / 5 - Math.PI / 6;
          const x = b.x + b.r * 0.5 + Math.cos(angle) * b.r * 0.35;
          const y = b.y + Math.sin(angle) * b.r * 0.35;
          if (i === 0) X.moveTo(x, y);
          else X.lineTo(x, y);
        }
        X.closePath();
        X.fill();
        
        // Highlight a tetejÃ©n (fÃ©ny effekt)
        const hlgr = X.createRadialGradient(b.x - b.r * 0.3, b.y - b.r * 0.3, 0, b.x - b.r * 0.3, b.y - b.r * 0.3, b.r * 0.5);
        hlgr.addColorStop(0, "rgba(255,255,255,.6)");
        hlgr.addColorStop(1, "rgba(255,255,255,0)");
        X.fillStyle = hlgr;
        X.beginPath();
        X.arc(b.x, b.y, b.r, 0, Math.PI * 2);
        X.fill();
      }

      function fPT(sh, dx, dy, md) {
        const ms = G.pl[sh.team].filter((p) => p.id !== sh.id);
        let best = null,
          bd = 1e9;
        ms.forEach((t) => {
          const tdx = t.x - sh.x,
            tdy = t.y - sh.y,
            td = Math.hypot(tdx, tdy);
          if (td > md * 1.5 || td < 10) return;
          const dot = (tdx * dx + tdy * dy) / td;
          if (dot > 0.8) {
            const perp = Math.abs(-dy * tdx + dx * tdy);
            if (perp < t.r * 3.5 && td < bd) {
              bd = td;
              best = t;
            }
          }
        });
        return best;
      }

      function dAL() {
        if (!G.ds || !G.dc || !G.sel) return;
        const p = G.sel,
          dx = G.ds.x - G.dc.x,
          dy = G.ds.y - G.dc.y,
          len = Math.hypot(dx, dy);
        if (len < 8) return;
        const pw = Math.min(len / 150, 1),
          dix = dx / len,
          diy = dy / len,
          al = pw * G.fw * 0.35 * 0.75; // 25%-kal kisebb csÃºzli
        const ex = p.x + dix * al,
          ey = p.y + diy * al;
        
        // DINAMIKUS TÃPUS MEGHATÃROZÃS: lÃ¶vÃ©s vagy passzolÃ¡s?
        const md = pw * G.fw * 0.75;
        const potentialTarget = fPT(p, dix, diy, md);
        const actionType = potentialTarget ? "pass" : "shoot"; // Ha van target â†’ passz, kÃ¼lÃ¶nben â†’ lÃ¶vÃ©s
        
        // PONTOSSÃG a megfelelÅ‘ tÃ­pussal
        let acc = gAcc(p, al, actionType);
        
        // VÃ‰DÅK ERÅS PASSZ PENALTY (ha passz)
        if (actionType === "pass") {
          const isDefender = ['CB', 'LB', 'RB', 'LWB', 'RWB'].includes(p.position);
          if (isDefender && pw > 0.4) {
            const powerPenalty = (pw - 0.4) * 1.5;
            acc = acc * (1 - powerPenalty);
            acc = Math.max(0.1, acc);
          }
        }
        
        const sp = (1 - acc) * 0.55; // HibahatÃ¡r szÃ¶ge
        
        // PIROS HÃROMSZÃ–G (hibahatÃ¡r) - SOKKAL LÃTHATÃ“BB!
        // KitÃ¶ltÃ©s - erÅ‘sebb piros
        X.fillStyle = "rgba(239,68,68,0.25)"; // ErÅ‘sebb! 0.15 â†’ 0.25
        X.beginPath();
        X.moveTo(p.x, p.y);
        X.lineTo(
          p.x + Math.cos(Math.atan2(diy, dix) - sp) * al,
          p.y + Math.sin(Math.atan2(diy, dix) - sp) * al,
        );
        X.lineTo(
          p.x + Math.cos(Math.atan2(diy, dix) + sp) * al,
          p.y + Math.sin(Math.atan2(diy, dix) + sp) * al,
        );
        X.closePath();
        X.fill();
        
        // VASTAG PIROS KÃ–RVONAL - ÃšJ!
        X.strokeStyle = "rgba(239,68,68,0.6)"; // JÃ³l lÃ¡thatÃ³ piros
        X.lineWidth = 2; // Vastag vonal!
        X.stroke();
        
        // SZAGGATOTT VONAL (irÃ¡ny)
        X.strokeStyle = `rgba(250,204,21,${0.4 + pw * 0.5})`;
        X.lineWidth = 1.5;
        X.setLineDash([4, 3]);
        X.beginPath();
        X.moveTo(p.x, p.y);
        X.lineTo(ex, ey);
        X.stroke();
        X.setLineDash([]);
        
        // NYÃL HEGYE (sÃ¡rga)
        const ha = 7,
          an = Math.atan2(diy, dix);
        X.fillStyle = "#facc15";
        X.beginPath();
        X.moveTo(ex, ey);
        X.lineTo(ex - ha * Math.cos(an - 0.4), ey - ha * Math.sin(an - 0.4));
        X.lineTo(ex - ha * Math.cos(an + 0.4), ey - ha * Math.sin(an + 0.4));
        X.closePath();
        X.fill();
        
        // ERÅ MÃ‰RÅ
        const pb = document.getElementById("pb"),
          pf = document.getElementById("pf");
        pb.style.display = "block";
        pf.style.width = pw * 100 + "%";
        pf.style.background = `rgb(${Math.round(255 * pw)},${Math.round(255 * (1 - pw))},40)`;
        
        // PASSZ TARGET JELZÃ‰S (zÃ¶ld kÃ¶r)
        if (potentialTarget) {
          X.strokeStyle = "#22c55e";
          X.lineWidth = 2;
          X.beginPath();
          X.arc(potentialTarget.x, potentialTarget.y, potentialTarget.r + 5, 0, Math.PI * 2);
          X.stroke();
        }
      }

      // Mechanics
      function gAcc(p, d, type) {
        // type = "pass" vagy "shoot"
        
        // TÃ¡volsÃ¡g alapÃº alap pontossÃ¡g
        const maxDist = G.fh * 0.8;
        let baseAcc = 1 - (d / maxDist) * 0.85;
        baseAcc = Math.max(0.08, Math.min(0.85, baseAcc)); // 8-85%
        
        // POZÃCIÃ“ ALAPÃš MÃ“DOSÃTÃ“K
        const pos = p.position;
        let modifier = 1.0; // AlapÃ©rtelmezett (nincs mÃ³dosÃ­tÃ¡s)
        
        // CSATÃROK: RW, LW, CF, ST, LF, RF
        const isAttacker = ['RW', 'LW', 'CF', 'ST', 'LF', 'RF'].includes(pos);
        
        // KÃ–ZÃ‰PPÃLYÃSOK: CM, CDM, CAM, LM, RM
        const isMidfielder = ['CM', 'CDM', 'CAM', 'LM', 'RM'].includes(pos);
        
        // VÃ‰DÅK: CB, LB, RB, LWB, RWB
        const isDefender = ['CB', 'LB', 'RB', 'LWB', 'RWB'].includes(pos);
        
        if (type === "shoot") {
          // KAPURA LÃ–VÃ‰S
          if (isAttacker) {
            modifier = 1.15; // +15% pontossÃ¡g (csatÃ¡rok jÃ³k lÅ‘ni)
          } else if (isMidfielder) {
            modifier = 0.85; // -15% pontossÃ¡g (kÃ¶zÃ©ppÃ¡lyÃ¡sok kevÃ©sbÃ©)
          } else if (isDefender) {
            modifier = 0.70; // -30% pontossÃ¡g (vÃ©dÅ‘k gyengÃ©k lÅ‘ni)
          }
        } else if (type === "pass") {
          // PASSZOLÃS
          if (isAttacker) {
            modifier = 0.90; // -10% pontossÃ¡g (csatÃ¡rok kevÃ©sbÃ© jÃ³k passzolni)
          } else if (isMidfielder) {
            modifier = 1.10; // +10% pontossÃ¡g (kÃ¶zÃ©ppÃ¡lyÃ¡sok jÃ³k passzolni)
          } else if (isDefender) {
            modifier = 1.05; // +5% pontossÃ¡g (vÃ©dÅ‘k is jÃ³k passzolni)
          }
        }
        
        // ===== PLAYER STATS INTEGRATION =====
        
        // 1. SHOOTING/PASSING STAT MODIFIER (if player has stats)
        if (p.shooting !== undefined && p.passing !== undefined) {
          const stat = type === "shoot" ? p.shooting : p.passing;
          // stat = 50-95 typically
          // 50 = 0.70x (worse), 70 = 1.0x (neutral), 90 = 1.30x (better)
          const statModifier = 0.4 + (stat / 100) * 0.9; // 0.85-1.30 range
          modifier *= statModifier;
        }
        
        // 2. STAMINA FATIGUE (70+ minutes)
        if (G.matchTime >= 70 && p.currentStamina !== undefined) {
          // Calculate fatigue based on current stamina
          // High stamina (80+) = little fatigue
          // Low stamina (50-) = heavy fatigue
          const fatigueAmount = Math.max(0, (70 - p.currentStamina) / 100); // 0-0.7
          const fatiguePenalty = 1 - (fatigueAmount * 0.4); // Max -40% when stamina = 30
          modifier *= fatiguePenalty;
        }
        
        // Alkalmazzuk a mÃ³dosÃ­tÃ³t
        let finalAcc = baseAcc * modifier;
        
        // VÃ©gsÅ‘ hatÃ¡rok: 5-95%
        return Math.max(0.05, Math.min(0.95, finalAcc));
      }
      function aIn(tx, ty, sx, sy, a) {
        const d = Math.hypot(tx - sx, ty - sy),
          mo = d * (1 - a) * 0.55; // NÃ–VELVE 0.35 â†’ 0.55 (nagyobb szÃ³rÃ¡s)
        return {
          x: tx + (Math.random() - 0.5) * 2 * mo,
          y: ty + (Math.random() - 0.5) * 2 * mo,
        };
      }

      function kick(pl, dx, dy, pw) {
        if (G.state !== "playing") return;
        
        // Ha a ballWinner passzol, csak nullÃ¡zzuk (ne Ã¡llÃ­tsuk vissza hirtelen)
        // Az updFP folyamatosan fut a hÃ¡ttÃ©rben, Ã­gy smooth lesz az Ã¡tmenet
        if (G.ballWinner && pl.id === G.ballWinner.id) {
          G.ballWinner = null;
        }
        
        const sp = pw * G.fh * 0.04,
          md = pw * G.fw * 0.75;
        const pt = fPT(pl, dx, dy, md);
        let tx, ty, kt;
        G.lastK = pl;
        G.passesAfterWin++;
        
        // EXTRA BIZTONSÃG: Reset animÃ¡ciÃ³ Ã¡llapot rÃºgÃ¡skor
        // Ãgy biztosan nem lesz "instant jump" ha kÃ¶zben mozgott volna
        pl.moveState = 'rest';
        pl.moveStartTime = Date.now();
        pl.moveTargetX = undefined;
        pl.moveTargetY = undefined;
        
        // EXTRA KRITIKUS: Reset targetBx/targetBy is!
        pl.targetBx = undefined;
        pl.targetBy = undefined;
        pl.bx = pl.x;
        pl.by = pl.y;
        
        if (pt) {
          kt = "pass";
          let a = gAcc(pl, Math.hypot(pt.x - pl.x, pt.y - pl.y), "pass");
          
          // VÃ‰DÅK: ErÅ‘s passzoknÃ¡l pontatlanabbak!
          const isDefender = ['CB', 'LB', 'RB', 'LWB', 'RWB'].includes(pl.position);
          if (isDefender && pw > 0.4) {
            // KÃ¶zepes-erÅ‘s passzok (40% felett)
            const powerPenalty = (pw - 0.4) * 1.5; // 0.4-1.0 â†’ 0-0.9 penalty
            a = a * (1 - powerPenalty); // CsÃ¶kkentjÃ¼k a pontossÃ¡got
            a = Math.max(0.1, a); // Min 10%
          }
          
          const r = aIn(pt.x, pt.y, pl.x, pl.y, a);
          tx = r.x;
          ty = r.y;
        } else {
          kt = "shoot";
          tx = pl.x + dx * md;
          ty = pl.y + dy * md;
          const d = Math.hypot(tx - pl.x, ty - pl.y),
            a = gAcc(pl, d, "shoot"),
            r = aIn(tx, ty, pl.x, pl.y, a);
          tx = r.x;
          ty = r.y;
        }
        G.state = "anim";
        pl.hb = false;
        const td = Math.hypot(tx - pl.x, ty - pl.y),
          dur = Math.max(200, (td / sp) * 16);
        anBall(pl.x, pl.y, tx, ty, dur, kt, pt);
      }

      function anBall(sx, sy, ex, ey, dur, kt, pt) {
        const st = performance.now();
        function s(n) {
          let t = Math.min((n - st) / dur, 1);
          t = 1 - (1 - t) * (1 - t);
          G.ball.x = sx + (ex - sx) * t;
          G.ball.y = sy + (ey - sy) * t;
          if (cGoal()) return;
          if (G.ball.x < G.fx) G.ball.x = G.fx;
          if (G.ball.x > G.fx + G.fw) G.ball.x = G.fx + G.fw;
          if (G.ball.y < G.fy - G.gh) G.ball.y = G.fy;
          if (G.ball.y > G.fy + G.fh + G.gh) G.ball.y = G.fy + G.fh;
          const op = G.turn === "home" ? "away" : "home";
          let ic = false;
          G.pl[op].forEach((o) => {
            if (ic) return;
            const d = Math.hypot(o.x - G.ball.x, o.y - G.ball.y);
            if (d < o.r + G.ball.r + 2) {
              const ch = o.position === "GK" ? 0.65 : 0.40; // Kapus 65%, mezÅ‘nyjÃ¡tÃ©kos 40%
              if (Math.random() < ch) {
                ic = true;
                G.pl.home.forEach((p) => (p.hb = false));
                G.pl.away.forEach((p) => (p.hb = false));
                o.hb = true;
                G.ball.x = o.x;
                G.ball.y = o.y;
                G.sel = o;
                G.turn = op;
                G.poss = op;
                G.passesAfterWin = 0;
                G.ballWinner = o; // BeÃ¡llÃ­tjuk ki szerezte meg
                
                // KRITIKUS: Reset mozgÃ¡s Ã¡llapot hogy ne legyen "instant jump" rÃºgÃ¡s utÃ¡n
                o.moveState = 'rest';
                o.moveStartTime = Date.now();
                o.moveTargetX = undefined;
                o.moveTargetY = undefined;
                
                // EXTRA KRITIKUS: Reset targetBx/targetBy is!
                // Ãgy nem folytatja a tÃ¡madÃ³ pozÃ­ciÃ³ba menetelt labdavesztÃ©s utÃ¡n
                o.targetBx = undefined;
                o.targetBy = undefined;
                // Jelenlegi pozÃ­ciÃ³ = base pozÃ­ciÃ³
                o.bx = o.x;
                o.by = o.y;
                
                G.state = "playing";
                updFP();
                uUI();
              }
            }
          });
          if (ic) return;
          if (pt && t > 0.35) {
            const d = Math.hypot(pt.x - G.ball.x, pt.y - G.ball.y);
            if (d < pt.r + G.ball.r + 6) {
              G.pl.home.forEach((p) => (p.hb = false));
              G.pl.away.forEach((p) => (p.hb = false));
              pt.hb = true;
              G.ball.x = pt.x;
              G.ball.y = pt.y;
              G.sel = pt;
              
              // KRITIKUS: Reset mozgÃ¡s Ã¡llapot passzolÃ¡s elkapÃ¡skor is
              pt.moveState = 'rest';
              pt.moveStartTime = Date.now();
              pt.moveTargetX = undefined;
              pt.moveTargetY = undefined;
              
              // EXTRA KRITIKUS: Reset targetBx/targetBy is!
              pt.targetBx = undefined;
              pt.targetBy = undefined;
              pt.bx = pt.x;
              pt.by = pt.y;
              
              G.state = "playing";
              uIns();
              return;
            }
          }
          if (t < 1) requestAnimationFrame(s);
          else fTurn();
        }
        requestAnimationFrame(s);
      }

      function cGoal() {
        const b = G.ball,
          gL = G.fx + (G.fw - G.gw) / 2,
          gR = gL + G.gw;
        if (b.y <= G.fy && b.x >= gL && b.x <= gR) {
          // Kapu pozÃ­ciÃ³ alapÃº gÃ³l esÃ©ly szÃ¡mÃ­tÃ¡s
          const gCenter = gL + G.gw / 2;
          const distFromCenter = Math.abs(b.x - gCenter);
          const distPercent = (distFromCenter / (G.gw / 2)) * 100; // 0-100%
          
          let goalChance;
          if (distPercent <= 20) {
            goalChance = 0.01; // Kapu kÃ¶zepe (0-20%): 1% gÃ³l esÃ©ly
          } else if (distPercent <= 50) {
            goalChance = 0.20; // Kapu 20-50%: 20% gÃ³l esÃ©ly
          } else if (distPercent <= 75) {
            goalChance = 0.35; // Kapu 50-75%: 35% gÃ³l esÃ©ly
          } else {
            goalChance = 0.50; // Kapu 75-100%: 50% gÃ³l esÃ©ly
          }
          
          if (Math.random() < goalChance) {
            sGoal("home");
            return true;
          } else {
            // VÃ©dÃ©s
            const k = G.pl.away.find((p) => p.position === "GK");
            if (k) {
              doSave(k, "away");
              return true;
            }
          }
        }
        if (b.y >= G.fy + G.fh && b.x >= gL && b.x <= gR) {
          // Kapu pozÃ­ciÃ³ alapÃº gÃ³l esÃ©ly szÃ¡mÃ­tÃ¡s
          const gCenter2 = gL + G.gw / 2;
          const distFromCenter2 = Math.abs(b.x - gCenter2);
          const distPercent2 = (distFromCenter2 / (G.gw / 2)) * 100;
          
          let goalChance2;
          if (distPercent2 <= 20) {
            goalChance2 = 0.01; // Kapu kÃ¶zepe: 1%
          } else if (distPercent2 <= 50) {
            goalChance2 = 0.20; // 20-50%: 20%
          } else if (distPercent2 <= 75) {
            goalChance2 = 0.35; // 50-75%: 35%
          } else {
            goalChance2 = 0.50; // 75-100%: 50%
          }
          
          if (Math.random() < goalChance2) {
            sGoal("away");
            return true;
          } else {
            // VÃ©dÃ©s
            const k = G.pl.home.find((p) => p.position === "GK");
            if (k) {
              doSave(k, "home");
              return true;
            }
          }
        }
        return false;
      }

      function doSave(k, t) {
        G.pl.home.forEach((p) => (p.hb = false));
        G.pl.away.forEach((p) => (p.hb = false));
        k.hb = true;
        G.ball.x = k.x;
        G.ball.y = k.y;
        G.sel = k;
        G.turn = t;
        G.poss = t;
        G.passesAfterWin = 0;
        G.ballWinner = k; // BeÃ¡llÃ­tjuk a kapust
        
        // KRITIKUS: Reset mozgÃ¡s Ã¡llapot vÃ©dÃ©skor is
        k.moveState = 'rest';
        k.moveStartTime = Date.now();
        k.moveTargetX = undefined;
        k.moveTargetY = undefined;
        
        // EXTRA KRITIKUS: Reset targetBx/targetBy is!
        k.targetBx = undefined;
        k.targetBy = undefined;
        k.bx = k.x;
        k.by = k.y;
        
        G.state = "playing";
        updFP();
        uUI();
        addFT(k.x, k.y - 18, "VÃ‰DÃ‰S!", "#22c55e");
      }

      function sGoal(t) {
        G.state = "goal";
        if (t === "home") {
          G.hs++;
          document.getElementById("hs").textContent = G.hs;
          
          // XP reward for goal scored (only for player's team)
          if (G.playersDB.length > 0) {
            addUserXP(10); // +10 XP per goal
            updateDebugUI(); // Update UI
          }
        } else {
          G.as++;
          document.getElementById("as").textContent = G.as;
        }
        const sn = G.lastK ? G.lastK.name : "?";
        document.getElementById("gsc").textContent =
          `${t === "home" ? G.ht.flag : G.at.flag} (${G.hs} - ${G.as})`;
        document.getElementById("go").classList.add("a");
        setTimeout(() => {
          document.getElementById("go").classList.remove("a");
          // NO MORE GOAL LIMIT CHECK - match continues until timer ends
          rAG(t === "home" ? "away" : "home");
        }, 2500);
      }

      function rAG(kt) {
        // kt = kickoff team (aki gÃ³lt kapott, Å‘ kezd)
        G.poss = kt;
        G.passesAfterWin = 0;
        G.ballWinner = null;
        
        // INSTANT TELEPORT - azonnal pozÃ­ciÃ³ba Ã¡llÃ­tjuk a csapatokat
        ["home", "away"].forEach((t) => {
          const fm = t === "home" ? G.hf : G.af;
          const fd = FMS[fm];
          // Ki vÃ©dekezik, ki tÃ¡mad
          const isAttacking = (G.poss === t);
          const ps = isAttacking ? fd.a : fd.d;
          
          G.pl[t].forEach((p, i) => {
            const pp = ps[i];
            let fx, fy;
            if (t === "home") {
              fx = G.fx + pp.x * G.fw;
              fy = G.fy + G.fh - pp.y * G.fh;
            } else {
              fx = G.fx + (1 - pp.x) * G.fw;
              fy = G.fy + pp.y * G.fh;
            }
            
            // INSTANT TELEPORT - nincs animÃ¡ciÃ³!
            p.x = fx;
            p.y = fy;
            p.bx = fx;
            p.by = fy;
            p.hb = false;
            
            // TELJES RESET - minden animÃ¡ciÃ³ Ã¡llapot
            p.targetBx = undefined;
            p.targetBy = undefined;
            p.moveState = 'rest';
            p.moveStartTime = Date.now();
            p.moveTargetX = undefined;
            p.moveTargetY = undefined;
          });
        });
        
        // Az egyik CB kapja meg a labdÃ¡t (aki gÃ³lt kapott)
        const cbList = G.pl[kt].filter(p => p.position === "CB");
        const kickoffPlayer = cbList.length > 0 ? cbList[0] : G.pl[kt][1]; // ElsÅ‘ CB vagy mÃ¡sodik jÃ¡tÃ©kos
        
        kickoffPlayer.hb = true;
        G.ball.x = kickoffPlayer.x;
        G.ball.y = kickoffPlayer.y;
        G.sel = kickoffPlayer;
        G.turn = kt;
        G.state = "playing";
        uUI();
      }

      function fTurn() {
        let md = 1e9,
          nr = null;
        [...G.pl.home, ...G.pl.away].forEach((p) => {
          const d = Math.hypot(p.x - G.ball.x, p.y - G.ball.y);
          if (d < md) {
            md = d;
            nr = p;
          }
        });
        G.turn = nr ? nr.team : G.turn === "home" ? "away" : "home";
        G.poss = G.turn;
        abn(G.turn);
        G.state = "playing";
        updFP();
        uUI();
      }

      function endM() {
        G.state = "mo";
        
        // XP Rewards based on result
        if (G.playersDB.length > 0) {
          let xpReward = 0;
          let coinReward = 0;
          
          if (G.hs > G.as) {
            // WIN
            xpReward = 100;
            coinReward = 50;
          } else if (G.hs === G.as) {
            // DRAW
            xpReward = 50;
            coinReward = 20;
          } else {
            // LOSS
            xpReward = 20;
            coinReward = 10;
          }
          
          // Clean sheet bonus (home team didn't concede)
          if (G.as === 0 && G.hs > 0) {
            xpReward += 30;
            coinReward += 20;
          }
          
          // Add rewards
          const levelUps = addUserXP(xpReward);
          G.userSquad.coins += coinReward;
          saveUserData();
          updateDebugUI(); // Update UI
          
          console.log(`âœ… Match complete! +${xpReward} XP, +${coinReward} coins`);
          
          // Show level ups
          if (levelUps.length > 0) {
            levelUps.forEach(lu => {
              console.log(`ğŸ‰ LEVEL UP! Level ${lu.level}`, lu.reward);
            });
          }
        }
        
        document.getElementById("moT").textContent =
          `${(G.hs > G.as ? G.ht : G.at).flag} ${(G.hs > G.as ? G.ht : G.at).code} wins!`;
        document.getElementById("moS").textContent = `${G.hs} - ${G.as}`;
        document.getElementById("moSb").textContent =
          `${G.ht.code} vs ${G.at.code}`;
        document.getElementById("mo").classList.add("a");
      }

      // AI
      let aiPending = false;
      function aiT() {
        if (G.state !== "playing" || G.turn !== "away" || aiPending) return;
        aiPending = true;
        const p = G.sel;
        if (!p) {
          aiPending = false;
          return;
        }
        setTimeout(
          () => {
            aiPending = false;
            if (G.state !== "playing" || G.turn !== "away") return;
            const gx = G.fx + G.fw / 2,
              gy = G.fy + G.fh,
              dg = Math.hypot(p.x - gx, p.y - gy);
            let dx, dy, pw;
            
            // EgyszerÅ±sÃ­tett AI dÃ¶ntÃ©s - csak tÃ¡volsÃ¡g alapÃº
            const closeToGoal = dg < G.fh * 0.40;
            
            if (closeToGoal) {
              // Intelligens lÃ¶vÃ©s - NEM a kÃ¶zepÃ©re!
              const gkPos = G.pl.home.find((pl) => pl.position === "GK");
              let tx;
              
              // CÃ©lzÃ¡s stratÃ©giÃ¡ja: kerÃ¼ld a kÃ¶zÃ©pet, cÃ©lozz a sarokra
              const shootStrategy = Math.random();
              
              if (shootStrategy < 0.45) {
                // Bal sarok felÃ© (45%)
                tx = G.fx + (G.fw - G.gw) / 2 + G.gw * (0.15 + Math.random() * 0.25);
              } else if (shootStrategy < 0.90) {
                // Jobb sarok felÃ© (45%)
                tx = G.fx + (G.fw - G.gw) / 2 + G.gw * (0.75 + Math.random() * 0.25);
              } else {
                // RitkÃ¡n a kÃ¶zÃ©p felÃ© (10%)
                tx = gx + (Math.random() - 0.5) * G.gw * 0.4;
              }
              
              // Ha van kapus, prÃ³bÃ¡ld az ellenkezÅ‘ oldalra
              if (gkPos) {
                const gkSide = gkPos.x > gx ? 'right' : 'left';
                if (gkSide === 'right' && shootStrategy < 0.5) {
                  // Kapus jobbra van, lÅ‘j balra
                  tx = G.fx + (G.fw - G.gw) / 2 + G.gw * (0.15 + Math.random() * 0.25);
                } else if (gkSide === 'left' && shootStrategy >= 0.5 && shootStrategy < 0.9) {
                  // Kapus balra van, lÅ‘j jobbra
                  tx = G.fx + (G.fw - G.gw) / 2 + G.gw * (0.75 + Math.random() * 0.25);
                }
              }
              
              tx = Math.max(G.fx + (G.fw - G.gw) / 2, Math.min(tx, G.fx + (G.fw + G.gw) / 2));
              const ddx = tx - p.x,
                ddy = gy - p.y,
                l = Math.hypot(ddx, ddy);
              dx = ddx / l;
              dy = ddy / l;
              pw = 0.70 + Math.random() * 0.25; // ErÅ‘sebb lÃ¶vÃ©sek
            } else {
              // Pontosabb passzok
              const ms = G.pl.away.filter((t) => {
                if (t.id === p.id) return false;
                const ahead = t.y > p.y + G.fh * 0.08;
                const notTooFar = Math.hypot(t.x - p.x, t.y - p.y) < G.fw * 0.6;
                return ahead && notTooFar;
              });
              
              if (ms.length > 0) {
                ms.sort((a, b) => b.y - a.y); // ElÅ‘rÃ©bb lÃ©vÅ‘k elÅ‘nyben
                const tg = ms[Math.floor(Math.random() * Math.min(3, ms.length))];
                const ddx = tg.x - p.x,
                  ddy = tg.y - p.y,
                  l = Math.hypot(ddx, ddy);
                dx = ddx / l;
                dy = ddy / l;
                pw = 0.55 + Math.random() * 0.25; // ErÅ‘sebb, pontosabb passzok
              } else {
                // Nincs jÃ³ passz lehetÅ‘sÃ©g - dribble elÅ‘re
                dx = (Math.random() - 0.5) * 0.6;
                dy = 1;
                const l = Math.hypot(dx, dy);
                dx /= l;
                dy /= l;
                pw = 0.25 + Math.random() * 0.25;
              }
            }
            kick(p, dx, dy, pw);
          },
          600 + Math.random() * 600, // LASSABB: 600-1200ms (volt: 350-750ms)
        );
      }

      // Input
      let tid = null,
        md = false;
      function gP(cx, cy) {
        const r = C.getBoundingClientRect();
        return { x: cx - r.left, y: cy - r.top };
      }
      C.addEventListener(
        "touchstart",
        (e) => {
          e.preventDefault();
          if (G.state !== "playing" || G.turn !== "home") return;
          const t = e.touches[0];
          tid = t.identifier;
          const p = gP(t.clientX, t.clientY);
          
          // Ha van labdÃ¡t birtoklÃ³ jÃ¡tÃ©kos, BÃRHONNAN lehet rÃºgni!
          const ballOwner = G.pl[G.turn].find((pp) => pp.hb);
          if (ballOwner) {
            G.ds = p;
            G.dc = p;
          }
        },
        { passive: false },
      );
      C.addEventListener(
        "touchmove",
        (e) => {
          e.preventDefault();
          if (!G.ds) return;
          for (let i = 0; i < e.touches.length; i++)
            if (e.touches[i].identifier === tid) {
              G.dc = gP(e.touches[i].clientX, e.touches[i].clientY);
              break;
            }
        },
        { passive: false },
      );
      C.addEventListener(
        "touchend",
        (e) => {
          e.preventDefault();
          if (G.ds && G.dc && G.sel) {
            const dx = G.ds.x - G.dc.x,
              dy = G.ds.y - G.dc.y,
              l = Math.hypot(dx, dy);
            if (l > 15) kick(G.sel, dx / l, dy / l, Math.min(l / 150, 1));
          }
          G.ds = null;
          G.dc = null;
          document.getElementById("pb").style.display = "none";
        },
        { passive: false },
      );
      C.addEventListener("mousedown", (e) => {
        if (G.state !== "playing" || G.turn !== "home") return;
        const p = gP(e.clientX, e.clientY);
        
        // Ha van labdÃ¡t birtoklÃ³ jÃ¡tÃ©kos, BÃRHONNAN lehet rÃºgni!
        // Nem kell pontosan rÃ¡kattintani a jÃ¡tÃ©kosra
        const ballOwner = G.pl[G.turn].find((pp) => pp.hb);
        if (ballOwner) {
          G.ds = p;
          G.dc = p;
          md = true;
        }
      });
      C.addEventListener("mousemove", (e) => {
        if (!md || !G.ds) return;
        G.dc = gP(e.clientX, e.clientY);
      });
      C.addEventListener("mouseup", (e) => {
        if (md && G.ds && G.dc && G.sel) {
          const dx = G.ds.x - G.dc.x,
            dy = G.ds.y - G.dc.y,
            l = Math.hypot(dx, dy);
          if (l > 15) kick(G.sel, dx / l, dy / l, Math.min(l / 150, 1));
        }
        md = false;
        G.ds = null;
        G.dc = null;
        document.getElementById("pb").style.display = "none";
      });

      function addFT(x, y, text, color) {
        const f = { x, y, a: 1, text, color };
        G.anims.push(f);
        (function fade() {
          f.a -= 0.02;
          f.y -= 0.5;
          if (f.a > 0) requestAnimationFrame(fade);
          else G.anims = G.anims.filter((a) => a !== f);
        })();
      }
      function uUI() {
        const i = document.getElementById("ti");
        if (G.turn === "home") {
          i.textContent = `${G.ht.flag} ${G.ht.code} kicks`;
          i.style.background = "rgba(59,130,246,.2)";
          i.style.color = "#93c5fd";
          i.style.border = "1px solid rgba(59,130,246,.4)";
        } else {
          i.textContent = `${G.at.flag} ${G.at.code} kicks`;
          i.style.background = "rgba(239,68,68,.2)";
          i.style.color = "#fca5a5";
          i.style.border = "1px solid rgba(239,68,68,.4)";
        }
        uIns();
      }
      function uIns() {
        document.getElementById("ins").textContent =
          G.turn === "home" && G.state === "playing"
            ? "Pull back to curve the shot"
            : "";
      }

      // Menus
      function hAll() {
        document
          .querySelectorAll(".ov")
          .forEach((o) => o.classList.remove("a"));
        document.getElementById("mo").classList.remove("a");
      }
      function bMenu() {
        hAll();
        document.getElementById("scoreboard").classList.remove("active");
        document.getElementById("menu").classList.add("a");
        G.state = "menu";
      }
      function openQM() {
        G.mode = "qm";
        G.step = "home";
        hAll();
        sTSel("Choose HOME team");
      }
      function sTSel(title) {
        hAll();
        document.getElementById("tsel").classList.add("a");
        document.getElementById("tst").textContent = title;
        document.getElementById("tsrch").value = "";
        document.getElementById("tsrch").oninput = filt;
        
        // Update squad player count
        const squadCountEl = document.getElementById("squadPlayerCount");
        if (squadCountEl) {
          squadCountEl.textContent = G.userSquad.players.length;
        }
        
        rTG();
      }
      function rTG(f = "") {
        const gr = document.getElementById("tgr");
        const fl = f.toLowerCase();
        gr.innerHTML = "";
        
        // Filter by continent
        let availableTeams = TEAMS;
        if (SELECTED_CUP && SELECTED_CUP !== 'WC') {
          const continentMap = {
            'EURO': 'UEFA',
            'AFCON': 'CAF',
            'COPA': 'CONMEBOL',
            'AFC': 'AFC',
            'CONCACAF': 'CONCACAF'
          };
          const continent = continentMap[SELECTED_CUP];
          availableTeams = TEAMS.filter(t => t.continent === continent || t.code === 'MY_SQUAD');
        }
        
        availableTeams
          .filter((t) => t.name.toLowerCase().includes(fl))
          .forEach((t) => {
            // Calculate average rating based on FIFA rank (or My Squad rating)
            let avgRating = 75;
            if (t.code === 'MY_SQUAD') {
              avgRating = t.avgRating;
            } else if (t.rank <= 10) {
              avgRating = 85; // Top 10: 85
            } else if (t.rank <= 30) {
              avgRating = 80; // Top 30: 80
            } else if (t.rank <= 80) {
              avgRating = 75; // Mid: 75
            } else {
              avgRating = 70; // Lower: 70
            }
            
            const c = document.createElement("div");
            c.className = "tc";
            
            // Visual feedback for selected teams
            const isHomeTeam = G.ht && G.ht.code === t.code;
            const isAwayTeam = G.at && G.at.code === t.code;
            
            if (isHomeTeam) {
              c.style.border = "2px solid #3b82f6";
              c.style.background = "rgba(59, 130, 246, 0.1)";
            } else if (isAwayTeam) {
              c.style.border = "2px solid #ef4444";
              c.style.background = "rgba(239, 68, 68, 0.1)";
            }
            
            c.innerHTML = `
              <span class="f">${t.flag}</span>
              <div class="i">
                <div class="n">${t.name}</div>
                <div class="r" style="color: #facc15; font-size: 10px;">AVG: ${avgRating}</div>
              </div>
            `;
            c.onclick = () => selT(t);
            gr.appendChild(c);
          });
      }
      function filt() {
        rTG(document.getElementById("tsrch").value);
      }
      function selT(t) {
        if (G.step === "home") {
          G.ht = t;
          
          // If My Squad selected, skip formation selection (use squad formation)
          if (t.code === 'MY_SQUAD') {
            G.useMySquad = true;
            G.hf = G.userSquad.formation || '4-4-2';
          } else {
            G.useMySquad = false;
          }
          
          G.step = "away";
          sTSel("Choose AWAY team");
        } else if (G.step === "away") {
          G.at = t;
          
          // If home is My Squad, skip formation selection
          if (G.ht.code === 'MY_SQUAD') {
            startM(); // Direct to match
          } else {
            // Set formations based on country default
            G.hf = getCountryFormation(G.ht.code);
            G.af = getCountryFormation(G.at.code);
            startM(); // Direct to match (no formation selection)
          }
        } else if (G.step === "cupTeam") {
          G.ht = t;
          
          if (t.code === 'MY_SQUAD') {
            G.useMySquad = true;
            G.hf = G.userSquad.formation || '4-4-2';
          } else {
            G.useMySquad = false;
            G.hf = getCountryFormation(t.code);
          }
          
          G.step = "hf";
          initCupDraw(); // Continue to cup
        }
      }
      
      // Get country's default formation
      function getCountryFormation(code) {
        // Default formations per country (based on real tactics)
        const formations = {
          'ESP': '4-3-3', 'FRA': '4-2-3-1', 'ENG': '4-3-3', 'BRA': '4-3-3',
          'ARG': '4-3-3', 'POR': '4-3-3', 'NED': '4-3-3', 'BEL': '3-4-3',
          'GER': '4-2-3-1', 'ITA': '3-5-2', 'URU': '4-4-2', 'CRO': '4-3-3',
          'MAR': '4-1-4-1', 'CRC': '5-4-1', 'MEX': '4-3-3', 'USA': '4-3-3'
        };
        
        return formations[code] || '4-4-2'; // Default: 4-4-2
      }
      
      function sFSel(title) {
        hAll();
        document.getElementById("fsel").classList.add("a");
        document.getElementById("fst").textContent = title;
        const gr = document.getElementById("fgr");
        gr.innerHTML = "";
        Object.keys(FMS).forEach((f) => {
          const b = document.createElement("button");
          b.className = "fb";
          b.textContent = f;
          b.onclick = () => selF(f);
          gr.appendChild(b);
        });
      }
      function selF(f) {
        // NOT USED ANYMORE - formations are auto-assigned
        // This function is kept for backwards compatibility only
        if (G.step === "hf") {
          G.hf = f;
          
          if (G.mode === "cup") {
            initCupDraw();
            return;
          }
          G.step = "af";
          sFSel("VendÃ©g FormÃ¡ciÃ³");
        } else {
          G.af = f;
          startM();
        }
      }
      function bTS() {
        if (G.step === "hf") {
          G.step = "away";
          sTSel("VÃ¡laszd a VENDÃ‰G csapatot");
        } else openQM();
      }

      function startM() {
        hAll();
        const sb = document.getElementById("scoreboard");
        sb.classList.add("active");
        document.getElementById("hf").textContent = G.ht.flag;
        document.getElementById("hn").textContent = G.ht.code;
        document.getElementById("af").textContent = G.at.flag;
        document.getElementById("an").textContent = G.at.code;
        G.hs = 0;
        G.as = 0;
        document.getElementById("hs").textContent = "0";
        document.getElementById("as").textContent = "0";
        
        // Initialize match timer
        G.matchTime = 0;
        G.matchStartTime = Date.now();
        
        resize();
        G.poss = "home";
        G.turn = "home";
        initP();
        G.state = "playing";
        uUI();
      }

      function moCont() {
        document.getElementById("mo").classList.remove("a");
        if (G.mode === "cup" && G.cup) cupMO();
        else bMenu();
      }

      // ==================== CUP ====================
      let SELECTED_CUP = null; // KivÃ¡lasztott kupa tÃ­pusa

      function selectCup(cupType) {
        SELECTED_CUP = cupType;
        G.mode = "cup";
        G.cupType = cupType;
        G.step = "cupTeam";
        hAll();
        document.getElementById("tsel").classList.add("a");
        
        // Cup specific text
        const cupNames = {
          'EURO': 'European Championship 2026 - Choose your European team!',
          'AFCON': 'African Championship 2026 - Choose your African team!',
          'COPA': 'South American Cup 2026 - Choose your South American team!',
          'AFC': 'Asian Championship 2026 - Choose your Asian team!',
          'CONCACAF': 'North American Cup 2026 - Choose your CONCACAF team!',
          'WC': 'World Championship 2026 - Choose your team!'
        };
        
        document.getElementById("tst").textContent = cupNames[cupType];
        document.getElementById("tsrch").value = "";
        document.getElementById("tsrch").oninput = filt;
        rTG();
      }

      function openCup() {
        selectCup('WC'); // Default World Cup
      }

      function initCupDraw() {
        hAll();
        
        // Kontinens szerinti csapatok
        const continentMap = {
          'EURO': 'UEFA',
          'AFCON': 'CAF',
          'COPA': 'CONMEBOL',
          'AFC': 'AFC',
          'CONCACAF': 'CONCACAF'
        };
        
        let ts;
        if (SELECTED_CUP === 'WC') {
          // World Cup - elÅ‘szÃ¶r selejtezÅ‘k!
          initWorldCupQualifiers();
          return;
        } else {
          // KontinentÃ¡lis kupa - csak az adott kontinens csapatai
          const continent = continentMap[SELECTED_CUP];
          ts = TEAMS.filter(t => t.continent === continent);
        }
        
        // KeverÃ©s
        for (let i = ts.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [ts[i], ts[j]] = [ts[j], ts[i]];
        }
        ts.sort((a, b) => a.rank - b.rank);
        
        // Kupa-specifikus sorsolÃ¡s
        const cupConfig = {
          'EURO': { teams: 24, groups: 6, teamsPerGroup: 4, pots: 4 },
          'AFCON': { teams: 24, groups: 6, teamsPerGroup: 4, pots: 4 },
          'COPA': { teams: 10, groups: 2, teamsPerGroup: 5, pots: 2 },
          'AFC': { teams: 24, groups: 6, teamsPerGroup: 4, pots: 4 },
          'CONCACAF': { teams: 16, groups: 4, teamsPerGroup: 4, pots: 4 }
        };
        
        const config = cupConfig[SELECTED_CUP];
        ts = ts.slice(0, config.teams); // Top N csapat
        
        // Kalapok (pots)
        const potSize = config.teams / config.pots;
        const pots = [];
        for (let i = 0; i < config.pots; i++) {
          pots.push(ts.slice(i * potSize, (i + 1) * potSize));
        }
        
        // KeverÃ©s kalapokban
        pots.forEach((p) => {
          for (let i = p.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [p[i], p[j]] = [p[j], p[i]];
          }
        });
        
        // Csoportok lÃ©trehozÃ¡sa
        const groups = [];
        for (let i = 0; i < config.groups; i++) {
          const g = {
            name: String.fromCharCode(65 + i),
            teams: [],
            matches: [],
          };
          
          // Minden kalapbÃ³l 1 csapat
          for (let p = 0; p < config.pots; p++) {
            g.teams.push(pots[p][i % pots[p].length]);
          }
          
          // Meccsek generÃ¡lÃ¡sa (mindenki-mindenki)
          for (let a = 0; a < g.teams.length; a++) {
            for (let b = a + 1; b < g.teams.length; b++) {
              g.matches.push({
                home: g.teams[a],
                away: g.teams[b],
                hg: null,
                ag: null,
                played: false,
              });
            }
          }
          groups.push(g);
        }
        
        G.cup = { 
          user: G.ht, 
          groups, 
          phase: "groups", 
          ko: null,
          type: SELECTED_CUP
        };
        showCup();
      }
      
      function initWorldCupQualifiers() {
        // World Cup selejtezÅ‘ rendszer
        hAll();
        
        const userContinent = G.ht.continent;
        const continentTeams = TEAMS.filter(t => t.continent === userContinent);
        
        // Kontinens szerinti helyek
        const spots = {
          'UEFA': 13,      // EurÃ³pa - 13 hely
          'CAF': 9,        // Afrika - 9 hely
          'CONMEBOL': 6,   // DÃ©l-Amerika - 6 hely (10-bÅ‘l 6)
          'AFC': 8,        // Ãzsia - 8 hely
          'CONCACAF': 6    // CONCACAF - 6 hely
        };
        
        const qualifierSpots = spots[userContinent];
        
        // SelejtezÅ‘ csoportok
        let numGroups, teamsPerGroup;
        if (userContinent === 'CONMEBOL') {
          // DÃ©l-Amerika: 1 csoport, mindenki-mindenki (10 csapat)
          numGroups = 1;
          teamsPerGroup = 10;
        } else if (userContinent === 'UEFA') {
          // EurÃ³pa: 10 csoport Ã— 5-6 csapat
          numGroups = 10;
          teamsPerGroup = Math.ceil(continentTeams.length / numGroups);
        } else if (userContinent === 'CAF') {
          // Afrika: 9 csoport Ã— 6 csapat
          numGroups = 9;
          teamsPerGroup = 6;
        } else if (userContinent === 'AFC') {
          // Ãzsia: 6 csoport Ã— 4 csapat
          numGroups = 6;
          teamsPerGroup = 4;
        } else {
          // CONCACAF: 3 csoport Ã— 5-6 csapat
          numGroups = 3;
          teamsPerGroup = Math.ceil(continentTeams.length / numGroups);
        }
        
        // SelejtezÅ‘ csoportok sorsolÃ¡sa
        let sortedTeams = [...continentTeams].sort((a, b) => a.rank - b.rank);
        const groups = [];
        
        for (let i = 0; i < numGroups; i++) {
          const g = {
            name: String.fromCharCode(65 + i),
            teams: [],
            matches: [],
          };
          
          // KÃ­gyÃ³ rendszerÅ± sorsolÃ¡s (1,2,3...visszafelÃ©...3,2,1)
          for (let pot = 0; pot < teamsPerGroup; pot++) {
            const idx = pot * numGroups + (pot % 2 === 0 ? i : numGroups - 1 - i);
            if (idx < sortedTeams.length) {
              g.teams.push(sortedTeams[idx]);
            }
          }
          
          // Meccsek (mindenki-mindenki)
          for (let a = 0; a < g.teams.length; a++) {
            for (let b = a + 1; b < g.teams.length; b++) {
              g.matches.push({
                home: g.teams[a],
                away: g.teams[b],
                hg: null,
                ag: null,
                played: false,
              });
            }
          }
          groups.push(g);
        }
        
        G.wcQualifiers = {
          user: G.ht,
          continent: userContinent,
          groups,
          spots: qualifierSpots,
          phase: "groups"
        };
        
        showWCQualifiers();
      }

      function calcSt(g) {
        const m = {};
        g.teams.forEach(
          (t) =>
            (m[t.code] = {
              team: t,
              p: 0,
              w: 0,
              d: 0,
              l: 0,
              gf: 0,
              ga: 0,
              pts: 0,
            }),
        );
        g.matches
          .filter((mm) => mm.played)
          .forEach((mm) => {
            m[mm.home.code].p++;
            m[mm.away.code].p++;
            m[mm.home.code].gf += mm.hg;
            m[mm.home.code].ga += mm.ag;
            m[mm.away.code].gf += mm.ag;
            m[mm.away.code].ga += mm.hg;
            if (mm.hg > mm.ag) {
              m[mm.home.code].w++;
              m[mm.home.code].pts += 3;
              m[mm.away.code].l++;
            } else if (mm.hg < mm.ag) {
              m[mm.away.code].w++;
              m[mm.away.code].pts += 3;
              m[mm.home.code].l++;
            } else {
              m[mm.home.code].d++;
              m[mm.away.code].d++;
              m[mm.home.code].pts++;
              m[mm.away.code].pts++;
            }
          });
        return Object.values(m).sort(
          (a, b) => b.pts - a.pts || b.gf - b.ga - (a.gf - a.ga) || b.gf - a.gf,
        );
      }

      function simMatch(h, a) {
        // Realististic 90-minute match simulation
        // Average goals per match in real football: 2.5-3 total
        
        let hg = 0, ag = 0;
        
        // Simulate based on team strength (rank)
        const homeStrength = 200 - (h.rank || 100); // Lower rank = stronger (inverse)
        const awayStrength = 200 - (a.rank || 100);
        const totalStrength = homeStrength + awayStrength;
        
        const homeWinProb = homeStrength / totalStrength;
        
        // Average 2.7 goals per match (realistic)
        const totalGoals = Math.floor(Math.random() * 2) + Math.floor(Math.random() * 3); // 0-4 goals typically
        
        // Distribute goals based on team strength
        for (let i = 0; i < totalGoals; i++) {
          if (Math.random() < homeWinProb + 0.1) { // Home advantage (+10%)
            hg++;
          } else {
            ag++;
          }
        }
        
        return { hg, ag };
      }

      function findNextGM() {
        // First, try to find user's next match
        for (const g of G.cup.groups) {
          for (const m of g.matches) {
            if (!m.played && (m.home.code === G.cup.user.code || m.away.code === G.cup.user.code)) {
              return { g, m, isUser: true };
            }
          }
        }
        
        // If no user match, find any match
        for (const g of G.cup.groups) {
          for (const m of g.matches) {
            if (!m.played) {
              return { g, m, isUser: false };
            }
          }
        }
        
        return null;
      }

      function showCup() {
        hAll();
        document.getElementById("scoreboard").classList.remove("active");
        document.getElementById("cup").classList.add("a");
        const c = document.getElementById("cupc");
        c.innerHTML = "";
        
        // Cup names - generic
        const cupNames = {
          'EURO': 'ğŸ† European Championship 2026',
          'AFCON': 'ğŸ† African Championship 2026',
          'COPA': 'ğŸ† South American Cup 2026',
          'AFC': 'ğŸ† Asian Championship 2026',
          'CONCACAF': 'ğŸ† North American Cup 2026',
          'WC': 'ğŸŒ World Championship 2026'
        };
        const cupName = cupNames[G.cup.type] || 'ğŸ† Championship';
        
        if (G.cup.phase === "groups") {
          c.innerHTML = `<h1 class="t">${cupName}</h1><h2 class="s">Group Stage - ${G.cup.groups.length} groups</h2>`;
          G.cup.groups.forEach((g) => {
            const st = calcSt(g);
            const iu = g.teams.some((t) => t.code === G.cup.user.code);
            const allDone = g.matches.every((m) => m.played);
            const d = document.createElement("div");
            d.style.cssText = `width:100%;margin-bottom:10px;border-radius:7px;overflow:hidden;${iu ? "border:1px solid #facc15;" : "border:1px solid #1e293b;"}`;
            let h = `<table class="gt"><tr><th colspan="7">${iu ? "â­ " : ""}Group ${g.name}</th></tr><tr><th></th><th>Pts</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th></tr>`;
            st.forEach((s, si) => {
              const q = si < 2 && allDone;
              const u = s.team.code === G.cup.user.code;
              h += `<tr class="${q ? "q" : ""}" style="${u ? "font-weight:700;color:#facc15;" : ""}"><td>${s.team.flag} ${s.team.code}</td><td>${s.pts}</td><td>${s.p}</td><td>${s.w}</td><td>${s.d}</td><td>${s.l}</td><td>${s.gf}-${s.ga}</td></tr>`;
            });
            h += "</table>";
            g.matches
              .filter((m) => m.played)
              .forEach((m) => {
                h += `<div class="mr">${m.home.flag}${m.home.code} <b>${m.hg}</b>-<b>${m.ag}</b> ${m.away.code}${m.away.flag}</div>`;
              });
            d.innerHTML = h;
            c.appendChild(d);
          });

          const nm = findNextGM();
          if (nm) {
            if (nm.isUser) {
              // Show user's match button
              const b1 = document.createElement("button");
              b1.className = "b";
              b1.textContent = `â–¶ Play Match: ${nm.m.home.flag} ${nm.m.home.code} vs ${nm.m.away.code} ${nm.m.away.flag}`;
              b1.onclick = () => playCupM(nm);
              c.appendChild(b1);
            } else {
              // Auto-simulate all remaining matches since user has no more matches
              while (findNextGM() !== null) {
                const nextMatch = findNextGM();
                if (!nextMatch) break;
                simCupM(nextMatch);
              }
              // Refresh display
              showCup();
              return;
            }
            
            // Results button - show all matches of current round
            const totalMatches = G.cup.groups.reduce((sum, g) => sum + g.matches.length, 0);
            const playedMatches = G.cup.groups.reduce((sum, g) => sum + g.matches.filter(m => m.played).length, 0);
            
            if (playedMatches > 0) {
              const bResults = document.createElement("button");
              bResults.className = "b b2";
              bResults.style.marginTop = "8px";
              bResults.textContent = `ğŸ“Š View Results (${playedMatches}/${totalMatches} matches played)`;
              bResults.onclick = showResults;
              c.appendChild(bResults);
            }
          } else {
            const b = document.createElement("button");
            b.className = "b bg";
            b.textContent = "ğŸ† Knockout Stage â†’";
            b.onclick = initKO;
            c.appendChild(b);
          }
        } else showKO();

        const bk = document.createElement("button");
        bk.className = "b br";
        bk.style.marginTop = "6px";
        bk.textContent = "Exit";
        bk.onclick = bMenu;
        c.appendChild(bk);
      }
      
      function showWCQualifiers() {
        hAll();
        document.getElementById("scoreboard").classList.remove("active");
        document.getElementById("cup").classList.add("a");
        const c = document.getElementById("cupc");
        c.innerHTML = "";
        
        const continentNames = {
          'UEFA': 'Europe',
          'CAF': 'Africa',
          'CONMEBOL': 'South America',
          'AFC': 'Asia',
          'CONCACAF': 'CONCACAF'
        };
        
        c.innerHTML = `<h1 class="t">ğŸŒ World Championship 2026 Qualifiers</h1><h2 class="s">${continentNames[G.wcQualifiers.continent]} - ${G.wcQualifiers.spots} spots available</h2>`;
        
        G.wcQualifiers.groups.forEach((g) => {
          const st = calcSt(g);
          const iu = g.teams.some((t) => t.code === G.wcQualifiers.user.code);
          const allDone = g.matches.every((m) => m.played);
          const d = document.createElement("div");
          d.style.cssText = `width:100%;margin-bottom:10px;border-radius:7px;overflow:hidden;${iu ? "border:1px solid #facc15;" : "border:1px solid #1e293b;"}`;
          
          // How many teams qualify from this group
          let qualifySpots = 1; // Default: group winners
          if (G.wcQualifiers.continent === 'CONMEBOL') {
            qualifySpots = 6; // Top 6 in South America
          }
          
          let h = `<table class="gt"><tr><th colspan="7">${iu ? "â­ " : ""}Group ${g.name}</th></tr><tr><th></th><th>Pts</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th></tr>`;
          st.forEach((s, si) => {
            const q = si < qualifySpots && allDone;
            const u = s.team.code === G.wcQualifiers.user.code;
            h += `<tr class="${q ? "q" : ""}" style="${u ? "font-weight:700;color:#facc15;" : ""}"><td>${s.team.flag} ${s.team.code}</td><td>${s.pts}</td><td>${s.p}</td><td>${s.w}</td><td>${s.d}</td><td>${s.l}</td><td>${s.gf}-${s.ga}</td></tr>`;
          });
          h += "</table>";
          g.matches
            .filter((m) => m.played)
            .forEach((m) => {
              h += `<div class="mr">${m.home.flag}${m.home.code} <b>${m.hg}</b>-<b>${m.ag}</b> ${m.away.code}${m.away.flag}</div>`;
            });
          d.innerHTML = h;
          c.appendChild(d);
        });
        
        const nm = findNextWCQM();
        if (nm) {
          if (nm.isUser) {
            // Show user's match button
            const b1 = document.createElement("button");
            b1.className = "b";
            b1.textContent = `â–¶ Play Match: ${nm.m.home.flag} ${nm.m.home.code} vs ${nm.m.away.code} ${nm.m.away.flag}`;
            b1.onclick = () => playWCQM(nm);
            c.appendChild(b1);
          } else {
            // Auto-simulate all remaining matches since user has no more matches
            while (findNextWCQM() !== null) {
              const nextMatch = findNextWCQM();
              if (!nextMatch) break;
              simWCQM(nextMatch);
            }
            // Refresh display
            showWCQualifiers();
            return;
          }
          
          // Results button
          const totalMatches = G.wcQualifiers.groups.reduce((sum, g) => sum + g.matches.length, 0);
          const playedMatches = G.wcQualifiers.groups.reduce((sum, g) => sum + g.matches.filter(m => m.played).length, 0);
          
          if (playedMatches > 0) {
            const bResults = document.createElement("button");
            bResults.className = "b b2";
            bResults.style.marginTop = "8px";
            bResults.textContent = `ğŸ“Š View Results (${playedMatches}/${totalMatches} matches played)`;
            bResults.onclick = showResultsWCQ;
            c.appendChild(bResults);
          }
        } else {
          // Qualifiers ended - did we qualify?
          const qualified = checkWCQualification();
          if (qualified) {
            const b = document.createElement("button");
            b.className = "b bg";
            b.style.fontSize = "15px";
            b.innerHTML = "âœ… YOU QUALIFIED FOR THE WORLD CHAMPIONSHIP! ğŸ‰<br>Start the finals â†’";
            b.onclick = initWorldCupFinals;
            c.appendChild(b);
          } else {
            const msg = document.createElement("div");
            msg.style.cssText = "padding:20px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;color:#fca5a5;text-align:center;font-size:16px;margin-bottom:10px;";
            msg.innerHTML = "âŒ Unfortunately you did not qualify for the World Championship.<br>Try again!";
            c.appendChild(msg);
          }
        }
        
        const bk = document.createElement("button");
        bk.className = "b br";
        bk.style.marginTop = "6px";
        bk.textContent = "Exit";
        bk.onclick = bMenu;
        c.appendChild(bk);
      }
      
      function findNextWCQM() {
        // First, try to find user's next match
        for (const g of G.wcQualifiers.groups) {
          for (const m of g.matches) {
            if (!m.played && (m.home.code === G.wcQualifiers.user.code || m.away.code === G.wcQualifiers.user.code)) {
              return { g, m, isUser: true };
            }
          }
        }
        
        // If no user match, find any match
        for (const g of G.wcQualifiers.groups) {
          for (const m of g.matches) {
            if (!m.played) {
              return { g, m, isUser: false };
            }
          }
        }
        
        return null;
      }
      
      function simWCQM(nm) {
        const r = simMatch(nm.m.home, nm.m.away);
        nm.m.hg = r.hg;
        nm.m.ag = r.ag;
        nm.m.played = true;
      }
      
      function simAllNonUserWCQ() {
        let nm;
        while ((nm = findNextWCQM()) !== null) {
          const iu =
            nm.m.home.code === G.wcQualifiers.user.code ||
            nm.m.away.code === G.wcQualifiers.user.code;
          if (iu) break;
          simWCQM(nm);
        }
      }
      
      function playWCQM(nm) {
        G.wcqMatch = nm; // MegjegyezzÃ¼k a selejtezÅ‘ meccset
        G.ht = nm.m.home;
        G.at = nm.m.away;
        G.af = Object.keys(FMS)[Math.floor(Math.random() * Object.keys(FMS).length)];
        if (nm.m.home.code !== G.wcQualifiers.user.code) {
          [G.ht, G.at] = [G.at, G.ht];
          const tmp = G.hf;
          G.hf = G.af;
          G.af = tmp;
        }
        startM();
      }
      
      function checkWCQualification() {
        // MegnÃ©zzÃ¼k hogy a user kvalifikÃ¡lt-e
        const userTeam = G.wcQualifiers.user;
        
        for (const g of G.wcQualifiers.groups) {
          if (!g.teams.some(t => t.code === userTeam.code)) continue;
          
          const st = calcSt(g);
          const userPos = st.findIndex(s => s.team.code === userTeam.code);
          
          if (G.wcQualifiers.continent === 'CONMEBOL') {
            // DÃ©l-Amerika: top 6
            return userPos < 6;
          } else {
            // MÃ¡s kontinensek: csoportelsÅ‘k
            return userPos === 0;
          }
        }
        return false;
      }
      
      function initWorldCupFinals() {
        // World Cup torna indÃ­tÃ¡sa a kvalifikÃ¡lt csapatokkal
        hAll();
        
        // Ã–sszegyÅ±jtjÃ¼k az Ã¶sszes kvalifikÃ¡lt csapatot kontinensenkÃ©nt
        const qualifiedTeams = [];
        
        // TODO: Itt kellene egy komplex rendszer ami minden kontinensrÅ‘l Ã¶sszegyÅ±jti a kvalifikÃ¡ltakat
        // EgyszerÅ±sÃ­tve: csak a legjobb 32 csapatot vesszÃ¼k
        const allTeams = [...TEAMS].sort((a, b) => a.rank - b.rank).slice(0, 32);
        
        // 8 csoport Ã— 4 csapat
        const pots = [
          allTeams.slice(0, 8),
          allTeams.slice(8, 16),
          allTeams.slice(16, 24),
          allTeams.slice(24, 32),
        ];
        
        pots.forEach((p) => {
          for (let i = p.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [p[i], p[j]] = [p[j], p[i]];
          }
        });
        
        const groups = [];
        for (let i = 0; i < 8; i++) {
          const g = {
            name: String.fromCharCode(65 + i),
            teams: [pots[0][i], pots[1][i], pots[2][i], pots[3][i]],
            matches: [],
          };
          
          for (let a = 0; a < 4; a++) {
            for (let b = a + 1; b < 4; b++) {
              g.matches.push({
                home: g.teams[a],
                away: g.teams[b],
                hg: null,
                ag: null,
                played: false,
              });
            }
          }
          groups.push(g);
        }
        
        G.cup = { 
          user: G.ht, 
          groups, 
          phase: "groups", 
          ko: null,
          type: 'WC'
        };
        showCup();
      }

      function simCupM(nm) {
        const r = simMatch(nm.m.home, nm.m.away);
        nm.m.hg = r.hg;
        nm.m.ag = r.ag;
        nm.m.played = true;
      }
      function simAllNonUser() {
        let nm;
        while ((nm = findNextGM()) !== null) {
          const iu =
            nm.m.home.code === G.cup.user.code ||
            nm.m.away.code === G.cup.user.code;
          if (iu) break;
          simCupM(nm);
        }
      }

      function playCupM(nm) {
        G.ht = nm.m.home;
        G.at = nm.m.away;
        G.af =
          Object.keys(FMS)[Math.floor(Math.random() * Object.keys(FMS).length)];
        if (nm.m.home.code !== G.cup.user.code) {
          [G.ht, G.at] = [G.at, G.ht];
          const tmp = G.hf;
          G.hf = G.af;
          G.af = tmp;
        }
        G.cup._cur = nm;
        startM();
      }

      function cupMO() {
        // EllenÅ‘rizzÃ¼k hogy selejtezÅ‘ meccs volt-e
        if (G.wcqMatch) {
          const nm = G.wcqMatch;
          let hg = G.hs, ag = G.as;
          if (nm.m.home.code === G.ht.code) {
            nm.m.hg = hg;
            nm.m.ag = ag;
          } else {
            nm.m.hg = ag;
            nm.m.ag = hg;
          }
          nm.m.played = true;
          G.wcqMatch = null;
          
          // SzimulÃ¡ljuk a tÃ¶bbi meccset is
          simulateOneRoundForOthersWCQ();
          showWCQualifiers();
          return;
        }
        
        // NormÃ¡l kupa meccs
        const nm = G.cup._cur;
        if (nm) {
          let hg = G.hs,
            ag = G.as;
          if (nm.m.home.code === G.ht.code) {
            nm.m.hg = hg;
            nm.m.ag = ag;
          } else {
            nm.m.hg = ag;
            nm.m.ag = hg;
          }
          nm.m.played = true;
          
          // ÃšJDONSÃG: Amikor a user lejÃ¡tszik 1 meccset, 
          // minden mÃ¡s csapat is jÃ¡tszik 1 meccset
          if (G.cup.phase === "groups") {
            simulateOneRoundForOthers();
          }
        }
        if (G.cup.phase === "knockout") {
          cupKOMO();
          return;
        }
        showCup();
      }
      
      function simulateOneRoundForOthersWCQ() {
        // Simulate 1 match for each group
        G.wcQualifiers.groups.forEach((g) => {
          const nextMatch = g.matches.find((m) => {
            if (m.played) return false;
            return m.home.code !== G.wcQualifiers.user.code && m.away.code !== G.wcQualifiers.user.code;
          });
          
          if (nextMatch) {
            const r = simMatch(nextMatch.home, nextMatch.away);
            nextMatch.hg = r.hg;
            nextMatch.ag = r.ag;
            nextMatch.played = true;
          }
        });
      }
      
      // Results viewer for Cup
      function showResults() {
        hAll();
        document.getElementById("cup").classList.add("a");
        const c = document.getElementById("cupc");
        c.innerHTML = "<h1 class='t'>ğŸ“Š Match Results</h1>";
        
        // Group matches by round
        const maxRound = Math.max(...G.cup.groups.flatMap(g => g.matches.filter(m => m.played).map((m, i) => Math.floor(i / (g.teams.length / 2)) + 1)));
        
        // Create tabs for each round
        const tabContainer = document.createElement("div");
        tabContainer.style.cssText = "display:flex;gap:4px;margin-bottom:12px;overflow-x:auto;";
        
        for (let round = 1; round <= maxRound; round++) {
          const tab = document.createElement("button");
          tab.className = "b";
          tab.style.cssText = "flex-shrink:0;padding:8px 16px;font-size:12px;";
          tab.textContent = `Match ${round}`;
          tab.onclick = () => showResultsRound(round);
          tabContainer.appendChild(tab);
        }
        c.appendChild(tabContainer);
        
        // Show first round by default
        showResultsRound(1);
        
        const bBack = document.createElement("button");
        bBack.className = "b b2";
        bBack.style.marginTop = "12px";
        bBack.textContent = "Back";
        bBack.onclick = showCup;
        c.appendChild(bBack);
      }
      
      function showResultsRound(roundNum) {
        const c = document.getElementById("cupc");
        // Remove previous round results if any
        const existing = document.getElementById("roundResults");
        if (existing) existing.remove();
        
        const resultsDiv = document.createElement("div");
        resultsDiv.id = "roundResults";
        
        resultsDiv.innerHTML = `<h2 class="s">Matchday ${roundNum}</h2>`;
        
        // Show all matches from this round across all groups
        G.cup.groups.forEach((g) => {
          const roundMatches = [];
          let matchIndex = 0;
          
          g.matches.forEach((m, idx) => {
            const currentRound = Math.floor(idx / (g.teams.length / 2)) + 1;
            if (currentRound === roundNum && m.played) {
              roundMatches.push(m);
            }
          });
          
          if (roundMatches.length > 0) {
            const groupDiv = document.createElement("div");
            groupDiv.style.cssText = "margin-bottom:12px;padding:8px;background:#1f2937;border-radius:6px;";
            groupDiv.innerHTML = `<div style="font-weight:700;margin-bottom:6px;">Group ${g.name}</div>`;
            
            roundMatches.forEach(m => {
              const matchDiv = document.createElement("div");
              matchDiv.className = "mr";
              matchDiv.innerHTML = `${m.home.flag} ${m.home.code} <b>${m.hg}-${m.ag}</b> ${m.away.code} ${m.away.flag}`;
              groupDiv.appendChild(matchDiv);
            });
            
            resultsDiv.appendChild(groupDiv);
          }
        });
        
        // Insert before the back button
        const backBtn = c.querySelector(".b2");
        c.insertBefore(resultsDiv, backBtn);
      }
      
      // Results viewer for WC Qualifiers
      function showResultsWCQ() {
        hAll();
        document.getElementById("cup").classList.add("a");
        const c = document.getElementById("cupc");
        c.innerHTML = "<h1 class='t'>ğŸ“Š Qualifier Results</h1>";
        
        // Group matches by round
        const maxRound = Math.max(...G.wcQualifiers.groups.flatMap(g => g.matches.filter(m => m.played).map((m, i) => Math.floor(i / (g.teams.length / 2)) + 1)));
        
        // Create tabs
        const tabContainer = document.createElement("div");
        tabContainer.style.cssText = "display:flex;gap:4px;margin-bottom:12px;overflow-x:auto;";
        
        for (let round = 1; round <= maxRound; round++) {
          const tab = document.createElement("button");
          tab.className = "b";
          tab.style.cssText = "flex-shrink:0;padding:8px 16px;font-size:12px;";
          tab.textContent = `Match ${round}`;
          tab.onclick = () => showResultsRoundWCQ(round);
          tabContainer.appendChild(tab);
        }
        c.appendChild(tabContainer);
        
        showResultsRoundWCQ(1);
        
        const bBack = document.createElement("button");
        bBack.className = "b b2";
        bBack.style.marginTop = "12px";
        bBack.textContent = "Back";
        bBack.onclick = showWCQualifiers;
        c.appendChild(bBack);
      }
      
      function showResultsRoundWCQ(roundNum) {
        const c = document.getElementById("cupc");
        const existing = document.getElementById("roundResults");
        if (existing) existing.remove();
        
        const resultsDiv = document.createElement("div");
        resultsDiv.id = "roundResults";
        resultsDiv.innerHTML = `<h2 class="s">Matchday ${roundNum}</h2>`;
        
        G.wcQualifiers.groups.forEach((g) => {
          const roundMatches = [];
          
          g.matches.forEach((m, idx) => {
            const currentRound = Math.floor(idx / (g.teams.length / 2)) + 1;
            if (currentRound === roundNum && m.played) {
              roundMatches.push(m);
            }
          });
          
          if (roundMatches.length > 0) {
            const groupDiv = document.createElement("div");
            groupDiv.style.cssText = "margin-bottom:12px;padding:8px;background:#1f2937;border-radius:6px;";
            groupDiv.innerHTML = `<div style="font-weight:700;margin-bottom:6px;">Group ${g.name}</div>`;
            
            roundMatches.forEach(m => {
              const matchDiv = document.createElement("div");
              matchDiv.className = "mr";
              matchDiv.innerHTML = `${m.home.flag} ${m.home.code} <b>${m.hg}-${m.ag}</b> ${m.away.code} ${m.away.flag}`;
              groupDiv.appendChild(matchDiv);
            });
            
            resultsDiv.appendChild(groupDiv);
          }
        });
        
        const backBtn = c.querySelector(".b2");
        c.insertBefore(resultsDiv, backBtn);
      }
      
      function simulateOneRoundForOthers() {
        // Minden csoportban keressÃ¼k meg a kÃ¶vetkezÅ‘ nem jÃ¡tszott meccset
        G.cup.groups.forEach((g) => {
          // KeressÃ¼k meg az elsÅ‘ lejÃ¡tszatlan meccset ami NEM a user-t Ã©rinti
          const nextMatch = g.matches.find((m) => {
            if (m.played) return false;
            // Csak akkor szimulÃ¡ljuk, ha a user egyik csapata sem jÃ¡tszik benne
            const userPlaying = 
              m.home.code === G.cup.user.code || 
              m.away.code === G.cup.user.code;
            return !userPlaying;
          });
          
          if (nextMatch) {
            const result = simMatch(nextMatch.home, nextMatch.away);
            nextMatch.hg = result.hg;
            nextMatch.ag = result.ag;
            nextMatch.played = true;
          }
        });
      }

      // Knockout
      function initKO() {
        G.cup.phase = "knockout";
        
        // CsoportgyÅ‘ztesek Ã©s mÃ¡sodikak Ã¶sszegyÅ±jtÃ©se
        const firsts = [];
        const seconds = [];
        
        G.cup.groups.forEach((g) => {
          const st = calcSt(g);
          firsts.push(st[0].team);
          if (st.length > 1) seconds.push(st[1].team);
        });
        
        // Copa AmÃ©rica speciÃ¡lis eset: 2 csoport Ã— 5 csapat, TOP 4 (2-2) jut tovÃ¡bb
        if (G.cup.type === 'COPA' && G.cup.groups.length === 2) {
          // ElÅ‘dÃ¶ntÅ‘: 1A vs 2B, 1B vs 2A
          const ko = [
            {
              home: firsts[0],
              away: seconds[1],
              hg: null,
              ag: null,
              played: false,
            },
            {
              home: firsts[1],
              away: seconds[0],
              hg: null,
              ag: null,
              played: false,
            }
          ];
          G.cup.ko = [ko];
          showCup();
          return;
        }
        
        // NormÃ¡l keresztbe pÃ¡rosÃ­tÃ¡s (1st A vs 2nd B, 1st B vs 2nd A, stb.)
        const ko = [];
        const numMatches = Math.min(firsts.length, seconds.length);
        
        for (let i = 0; i < numMatches; i++) {
          ko.push({
            home: firsts[i],
            away: seconds[numMatches - 1 - i],
            hg: null,
            ag: null,
            played: false,
          });
        }
        
        G.cup.ko = [ko];
        showCup();
      }

      function showKO() {
        const c = document.getElementById("cupc");
        const rounds = G.cup.ko;
        
        // Dynamic round names based on team count
        function getRoundName(numTeams) {
          if (numTeams === 2) return "FINAL";
          if (numTeams === 4) return "Semi-Final";
          if (numTeams === 8) return "Quarter-Final";
          if (numTeams === 16) return "Round of 16";
          return `Round of ${numTeams}`;
        }
        
        const cupNames = {
          'EURO': 'ğŸ† European Championship 2026',
          'AFCON': 'ğŸ† African Championship 2026',
          'COPA': 'ğŸ† South American Cup 2026',
          'AFC': 'ğŸ† Asian Championship 2026',
          'CONCACAF': 'ğŸ† North American Cup 2026',
          'WC': 'ğŸŒ World Championship 2026'
        };
        const cupName = cupNames[G.cup.type] || 'ğŸ† Championship';
        
        c.innerHTML = `<h1 class="t">${cupName} - Knockout Stage</h1>`;
        
        // Show bracket tree (all rounds)
        let bracketHTML = '<div style="margin: 16px 0;">';
        
        for (let roundIdx = 0; roundIdx < rounds.length; roundIdx++) {
          const round = rounds[roundIdx];
          const numTeams = round.length * 2;
          const roundName = getRoundName(numTeams);
          
          bracketHTML += `
            <div style="margin-bottom: 16px;">
              <h3 style="font-size: 14px; color: #facc15; margin-bottom: 8px;">${roundName}</h3>
          `;
          
          round.forEach((m, i) => {
            const iu = m.home.code === G.cup.user.code || m.away.code === G.cup.user.code;
            
            bracketHTML += `
              <div class="mr" style="padding:6px;background:#1f2937;border-radius:6px;margin:3px 0;width:100%;font-size:12px;${iu ? 'border:1px solid #facc15;' : ''}">
            `;
            
            if (m.played) {
              const homeWon = m.hg > m.ag;
              const awayWon = m.ag > m.hg;
              bracketHTML += `
                ${m.home.flag}<b style="color:${homeWon ? '#22c55e' : '#fff'}">${m.home.code}</b> 
                <b>${m.hg}-${m.ag}</b> 
                <b style="color:${awayWon ? '#22c55e' : '#fff'}">${m.away.code}</b>${m.away.flag}
              `;
            } else {
              bracketHTML += `${m.home.flag} ${m.home.code} vs ${m.away.code} ${m.away.flag}`;
            }
            
            bracketHTML += `</div>`;
          });
          
          bracketHTML += `</div>`;
        }
        
        bracketHTML += '</div>';
        c.innerHTML += bracketHTML;

        // Find current round and next match
        const curRound = rounds[rounds.length - 1];
        const nm = curRound.find((m) => !m.played);
        
        if (nm) {
          const iu = nm.home.code === G.cup.user.code || nm.away.code === G.cup.user.code;
          
          if (iu) {
            // User's match - show play button
            const b = document.createElement("button");
            b.className = "b";
            b.style.marginTop = "8px";
            b.textContent = `â–¶ Play Your Match: ${nm.home.flag} ${nm.home.code} vs ${nm.away.code} ${nm.away.flag}`;
            b.onclick = () => playKOM(nm);
            c.appendChild(b);
          } else {
            // AI match - show simulate button
            const b = document.createElement("button");
            b.className = "b b2";
            b.style.marginTop = "8px";
            b.textContent = `â© Simulate: ${nm.home.flag} ${nm.home.code} vs ${nm.away.code} ${nm.away.flag}`;
            b.onclick = () => {
              simKOM(nm);
              showCup();
            };
            c.appendChild(b);
          }
        } else {
          // All matches in current round done
          if (curRound.length === 1) {
            // Tournament over!
            const w = curRound[0].hg > curRound[0].ag ? curRound[0].home : curRound[0].away;
            c.innerHTML += `<div style="margin-top:16px;text-align:center"><div style="font-size:40px">ğŸ†</div><div style="font-family:'Russo One',sans-serif;font-size:24px;color:#facc15;margin:8px 0">${w.flag} ${w.code}</div><div style="color:#9ca3af">${cupName} Champion!</div></div>`;
          } else {
            const b = document.createElement("button");
            b.className = "b bg";
            b.style.marginTop = "8px";
            b.textContent = "Next Round â†’";
            b.onclick = () => {
              const winners = curRound.map((m) =>
                m.hg > m.ag ? m.home : m.away,
              );
              const next = [];
              for (let i = 0; i < winners.length; i += 2)
                next.push({
                  home: winners[i],
                  away: winners[i + 1],
                  hg: null,
                  ag: null,
                  played: false,
                });
              G.cup.ko.push(next);
              showCup();
            };
            c.appendChild(b);
          }
        }
      }

      function simKOM(m) {
        let r;
        do {
          r = simMatch(m.home, m.away);
        } while (r.hg === r.ag);
        m.hg = r.hg;
        m.ag = r.ag;
        m.played = true;
      }

      function playKOM(m) {
        G.cup._curKO = m;
        G.ht = m.home;
        G.at = m.away;
        G.af =
          Object.keys(FMS)[Math.floor(Math.random() * Object.keys(FMS).length)];
        if (m.home.code !== G.cup.user.code) {
          [G.ht, G.at] = [G.at, G.ht];
        }
        startM();
      }

      function cupKOMO() {
        const m = G.cup._curKO;
        if (m) {
          if (m.home.code === G.ht.code) {
            m.hg = G.hs;
            m.ag = G.as;
          } else {
            m.hg = G.as;
            m.ag = G.hs;
          } // If draw, add random extra goal
          if (m.hg === m.ag) {
            if (Math.random() < 0.5) m.hg++;
            else m.ag++;
          }
          m.played = true;
        }
        showCup();
      }

      // Game loop
      // JÃ¡tÃ©kosok mozgÃ¡sa - 4 irÃ¡nyos + tiltÃ³ kÃ¶r (circle collider)
      function updatePlayerMovement() {
        const moveRange = G.fw * 0.03; // CSÃ–KKENTVE 0.05 â†’ 0.03 (kisebb mozgÃ¡s)
        const moveDuration = 1200;
        const restDuration = 300; // CSÃ–KKENTVE 500 â†’ 300ms (gyorsabb mozgÃ¡s indÃ­tÃ¡s)
        const exclusionRadius = G.fw * 0.06; // NÃ–VELVE 0.03 â†’ 0.06 (nagyobb tÃ©r)
        
        [...G.pl.home, ...G.pl.away].forEach((p) => {
          // Kapus Ã©s labdÃ¡t birtoklÃ³ jÃ¡tÃ©kos nem mozog
          if (p.position === "GK" || p.hb) {
            // KRITIKUS: Ha labdÃ¡ja van, NEM Ã¡llÃ­tjuk x,y-t!
            // Marad ahol Ã©ppen van, ne teleportÃ¡ljon
            // (A loop-ban a labda kÃ¶veti Å‘t: ball.x = p.x)
            p.moveState = 'rest';
            return;
          }
          
          // LassÃº bx,by kÃ¶zelÃ­tÃ©s targetBx/targetBy felÃ©
          let adjustedMoveRange = moveRange; // NormÃ¡l mozgÃ¡si tÃ¡volsÃ¡g
          
          if (p.targetBx !== undefined && p.targetBy !== undefined) {
            const dx = p.targetBx - p.bx;
            const dy = p.targetBy - p.by;
            const dist = Math.hypot(dx, dy);
            
            if (dist > 1) {
              let speed = dist / 180; // 3 sec at 60fps (alap sebessÃ©g)
              
              // PLAYER SPEED STAT MODIFIER
              if (p.speed !== undefined) {
                // Speed stat: 50-95 typically
                // 50 = 0.7x slower, 70 = 1.0x normal, 90 = 1.3x faster
                const speedModifier = 0.4 + (p.speed / 100) * 0.9; // 0.85-1.30 range
                speed *= speedModifier;
              }
              
              // VÃ‰DÅK: 2Ã— gyorsabb defenzÃ­v pozÃ­ciÃ³vÃ¡ltÃ¡s!
              const isDefender = ['CB', 'LB', 'RB', 'LWB', 'RWB'].includes(p.position);
              const isDefending = (p.team === 'home' && G.poss === 'away') || 
                                   (p.team === 'away' && G.poss === 'home');
              
              if (isDefender && isDefending) {
                speed = speed * 2; // 2Ã— gyorsabb! (1.5 sec helyett 3 sec)
              }
              
              // EllenÅ‘rizzÃ¼k hogy a cÃ©l felÃ© vezetÅ‘ Ãºt szabad-e
              const nextX = p.bx + (dx / dist) * Math.min(speed, dist);
              const nextY = p.by + (dy / dist) * Math.min(speed, dist);
              const blocked = checkPathBlocked(p, nextX, nextY, exclusionRadius * 2);
              
              if (blocked) {
                // Van valaki az Ãºton - kerÃ¼lÅ‘ manÅ‘ver
                // OldalirÃ¡nyba mozdulunk kicsit
                const perpX = -dy / dist;
                const perpY = dx / dist;
                const detourAmount = G.fw * 0.01; // Kis kitÃ©rÅ‘
                
                p.bx += perpX * detourAmount;
                p.by += perpY * detourAmount;
              } else {
                // Szabad az Ãºt - normÃ¡l kÃ¶zelÃ­tÃ©s
                p.bx += (dx / dist) * Math.min(speed, dist);
                p.by += (dy / dist) * Math.min(speed, dist);
              }
              
              // KRITIKUS: PozÃ­ciÃ³vÃ¡ltÃ¡s kÃ¶zben IS mozoghat!
              // De KISEBB tÃ¡volsÃ¡gra (fele) hogy ne menjen tÃºl messzire
              adjustedMoveRange = moveRange * 0.5;
            } else {
              p.bx = p.targetBx;
              p.by = p.targetBy;
              p.targetBx = undefined;
              p.targetBy = undefined;
            }
          }
          
          const now = Date.now();
          
          if (!p.moveStartTime) {
            p.moveStartTime = now;
            p.moveState = 'rest';
          }
          
          const elapsed = now - p.moveStartTime;
          
          if (p.moveState === 'rest') {
            if (elapsed >= restDuration) {
              // Random 4 irÃ¡ny vÃ¡lasztÃ¡s
              const direction = Math.floor(Math.random() * 4);
              
              switch(direction) {
                case 0: // Fel
                  p.moveTargetX = p.bx;
                  p.moveTargetY = p.by - adjustedMoveRange;
                  break;
                case 1: // Le
                  p.moveTargetX = p.bx;
                  p.moveTargetY = p.by + adjustedMoveRange;
                  break;
                case 2: // Bal
                  p.moveTargetX = p.bx - adjustedMoveRange;
                  p.moveTargetY = p.by;
                  break;
                case 3: // Jobb
                  p.moveTargetX = p.bx + adjustedMoveRange;
                  p.moveTargetY = p.by;
                  break;
              }
              
              p.moveState = 'moving';
              p.moveStartTime = now;
              p.moveFromX = p.x;
              p.moveFromY = p.y;
            }
          } else if (p.moveState === 'moving') {
            if (elapsed >= moveDuration) {
              p.moveTargetX = p.bx;
              p.moveTargetY = p.by;
              p.moveState = 'returning';
              p.moveStartTime = now;
              p.moveFromX = p.x;
              p.moveFromY = p.y;
            } else {
              const progress = elapsed / moveDuration;
              const eased = progress * progress * (3 - 2 * progress);
              const targetX = p.moveFromX + (p.moveTargetX - p.moveFromX) * eased;
              const targetY = p.moveFromY + (p.moveTargetY - p.moveFromY) * eased;
              
              // ÃœTKÃ–ZÃ‰S ELLENÅRZÃ‰S - van-e ellenfÃ©l az Ãºton?
              const blocker = checkPathBlocked(p, targetX, targetY, exclusionRadius * 2);
              
              if (blocker) {
                // VAN ellenfÃ©l az Ãºton - kerÃ¼lÅ‘ Ã­v!
                // SzÃ¡mÃ­tjuk a kerÃ¼lÅ‘ irÃ¡nyt (merÅ‘leges az eredeti irÃ¡nyra)
                const dx = targetX - p.x;
                const dy = targetY - p.y;
                const perpX = -dy; // MerÅ‘leges vektor
                const perpY = dx;
                const perpLen = Math.hypot(perpX, perpY);
                
                // KerÃ¼lÅ‘ irÃ¡ny: melyik oldalon van tÃ¶bb hely?
                const leftSpace = checkSpace(p, perpX / perpLen, perpY / perpLen);
                const rightSpace = checkSpace(p, -perpX / perpLen, -perpY / perpLen);
                
                const detourDir = leftSpace > rightSpace ? 1 : -1;
                
                // KerÃ¼lÅ‘ Ã­v mentÃ©n mozgÃ¡s - akkora mint egy jÃ¡tÃ©kos sugara
                p.x += (perpX / perpLen) * detourDir * moveRange * 0.02; // 0.05 â†’ 0.02
                p.y += (perpY / perpLen) * detourDir * moveRange * 0.02;
                
                // KRITIKUS: FrissÃ­tjÃ¼k a moveFrom Ã©rtÃ©keket
                // Ãgy amikor returning-be vÃ¡lt, a smooth animÃ¡ciÃ³ innen indul
                p.moveFromX = p.x;
                p.moveFromY = p.y;
              } else {
                // Nincs akadÃ¡ly - normÃ¡l mozgÃ¡s
                p.x = targetX;
                p.y = targetY;
              }
            }
          } else if (p.moveState === 'returning') {
            // Mindig lassan kÃ¶zelÃ­t a bx,by felÃ© (nem idÅ‘alapÃº animÃ¡ciÃ³)
            const dx = p.bx - p.x;
            const dy = p.by - p.y;
            const dist = Math.hypot(dx, dy);
            
            if (dist < 1) {
              // ElÃ©rte a cÃ©lt
              p.x = p.bx;
              p.y = p.by;
              p.moveState = 'rest';
              p.moveStartTime = now;
            } else {
              // LassÃº kÃ¶zelÃ­tÃ©s - progresszÃ­v lassulÃ¡s a kÃ¶zeledÃ©skor
              // MinÃ©l kÃ¶zelebb van a cÃ©lhoz, annÃ¡l lassabban megy
              const maxSpeed = moveRange * 0.012; // Kicsit lassabb mint a moving
              const distanceRatio = Math.min(dist / (moveRange * 2), 1); // 0-1 skÃ¡la
              const returnSpeed = maxSpeed * (0.3 + 0.7 * distanceRatio); // Lassul a vÃ©gÃ©n
              
              // ÃœTKÃ–ZÃ‰S ELLENÅRZÃ‰S
              const blocker = checkPathBlocked(p, p.x + (dx/dist) * returnSpeed, p.y + (dy/dist) * returnSpeed, exclusionRadius * 2);
              
              if (blocker) {
                // KerÃ¼lÅ‘ Ã­v
                const perpX = -dy;
                const perpY = dx;
                const perpLen = Math.hypot(perpX, perpY);
                
                const leftSpace = checkSpace(p, perpX / perpLen, perpY / perpLen);
                const rightSpace = checkSpace(p, -perpX / perpLen, -perpY / perpLen);
                const detourDir = leftSpace > rightSpace ? 1 : -1;
                
                // KerÃ¼lÅ‘ Ã­v + lassÃº kÃ¶zelÃ­tÃ©s - akkora mint egy jÃ¡tÃ©kos
                p.x += (perpX / perpLen) * detourDir * moveRange * 0.02; // 0.05 â†’ 0.02
                p.y += (perpY / perpLen) * detourDir * moveRange * 0.02;
                p.x += (dx / dist) * returnSpeed * 0.3; // KÃ¶zben kÃ¶zelÃ­t is
                p.y += (dy / dist) * returnSpeed * 0.3;
              } else {
                // Szabad az Ãºt - egyenesen kÃ¶zelÃ­t
                p.x += (dx / dist) * returnSpeed;
                p.y += (dy / dist) * returnSpeed;
              }
            }
          }
        });
        
        // TILTÃ“ KÃ–R (Circle Collider) - jÃ¡tÃ©kosok elcsÃºsznak egymÃ¡s mellett
        applyExclusionCircles(exclusionRadius);
        
        // PÃLYÃN TARTÃS - jÃ¡tÃ©kosok ne menjenek le a pÃ¡lyÃ¡rÃ³l!
        [...G.pl.home, ...G.pl.away].forEach((p) => {
          const margin = p.r; // JÃ¡tÃ©kos sugara a margÃ³
          
          // Bal szÃ©l
          if (p.x < G.fx + margin) {
            p.x = G.fx + margin;
          }
          // Jobb szÃ©l
          if (p.x > G.fx + G.fw - margin) {
            p.x = G.fx + G.fw - margin;
          }
          // FelsÅ‘ szÃ©l
          if (p.y < G.fy + margin) {
            p.y = G.fy + margin;
          }
          // AlsÃ³ szÃ©l
          if (p.y > G.fy + G.fh - margin) {
            p.y = G.fy + G.fh - margin;
          }
        });
      }
      
      // EllenÅ‘rzi hogy van-e ellenfÃ©l a cÃ©lpozÃ­ciÃ³ kÃ¶zelÃ©ben
      function checkPathBlocked(player, targetX, targetY, radius) {
        const allPlayers = [...G.pl.home, ...G.pl.away];
        for (let other of allPlayers) {
          if (other.id === player.id) continue;
          const dist = Math.hypot(targetX - other.x, targetY - other.y);
          if (dist < radius) {
            return other; // Van blocker
          }
        }
        return null; // Szabad az Ãºt
      }
      
      // EllenÅ‘rzi mennyi hely van egy irÃ¡nyban
      function checkSpace(player, dirX, dirY) {
        const allPlayers = [...G.pl.home, ...G.pl.away];
        const checkDist = G.fw * 0.1;
        const checkX = player.x + dirX * checkDist;
        const checkY = player.y + dirY * checkDist;
        
        let minDist = checkDist;
        for (let other of allPlayers) {
          if (other.id === player.id) continue;
          const dist = Math.hypot(checkX - other.x, checkY - other.y);
          if (dist < minDist) minDist = dist;
        }
        return minDist; // Nagyobb = tÃ¶bb hely
      }
      
      // TiltÃ³ kÃ¶r rendszer - jÃ¡tÃ©kosok nem mehetnek egymÃ¡s kÃ¶rÃ©be
      function applyExclusionCircles(radius) {
        const allPlayers = [...G.pl.home, ...G.pl.away];
        const minDist = radius * 2;
        
        // CSÃ–KKENTVE 3 â†’ 2 iterÃ¡ciÃ³ (kevÃ©sbÃ© agresszÃ­v)
        for (let iteration = 0; iteration < 2; iteration++) {
          for (let i = 0; i < allPlayers.length; i++) {
            for (let j = i + 1; j < allPlayers.length; j++) {
              const p1 = allPlayers[i];
              const p2 = allPlayers[j];
              
              const dx = p2.x - p1.x;
              const dy = p2.y - p1.y;
              const dist = Math.hypot(dx, dy);
              
              // Ha tÃºl kÃ¶zel vannak (kÃ¶rÃ¶k Ã¡tfednek)
              if (dist < minDist && dist > 0.1) {
                const overlap = minDist - dist;
                const nx = dx / dist;
                const ny = dy / dist;
                
                // PRIORITÃS rendszer:
                // Ha valaki pozÃ­ciÃ³vÃ¡ltÃ¡s kÃ¶zben van (targetBx van), ÅT nem toljuk!
                const p1HasPriority = p1.targetBx !== undefined && p1.targetBy !== undefined;
                const p2HasPriority = p2.targetBx !== undefined && p2.targetBy !== undefined;
                
                let pushDistance = overlap * 0.3;
                
                if (p1HasPriority && !p2HasPriority) {
                  // P1-nek prioritÃ¡sa van â†’ CSAK P2-t toljuk (dupla erÅ‘vel)
                  if (!p2.hb) {
                    p2.x += nx * pushDistance * 2;
                    p2.y += ny * pushDistance * 2;
                  }
                } else if (p2HasPriority && !p1HasPriority) {
                  // P2-nek prioritÃ¡sa van â†’ CSAK P1-et toljuk (dupla erÅ‘vel)
                  if (!p1.hb) {
                    p1.x -= nx * pushDistance * 2;
                    p1.y -= ny * pushDistance * 2;
                  }
                } else {
                  // MindkettÅ‘nek vagy egyiknek sincs prioritÃ¡sa â†’ normÃ¡l tolÃ¡s
                  if (!p1.hb) {
                    p1.x -= nx * pushDistance;
                    p1.y -= ny * pushDistance;
                  }
                  if (!p2.hb) {
                    p2.x += nx * pushDistance;
                    p2.y += ny * pushDistance;
                  }
                }
              }
            }
          }
        }
      }

      // SzÃ¡mÃ­tja egy jÃ¡tÃ©kos mÃ¡gneses taszÃ­tÃ¡sÃ¡t
      function loop() {
        X.clearRect(0, 0, C.width, C.height);
        X.fillStyle = "#0a1628";
        X.fillRect(0, 0, C.width, C.height);
        if (G.state !== "menu") {
          updatePlayerMovement(); // JÃ¡tÃ©kosok mozgÃ¡sa (mÃ¡gneses taszÃ­tÃ¡ssal)
          
          // KRITIKUS: Ha valakinek van labdÃ¡ja, a labda mindig nÃ¡la legyen
          if (G.state === "playing" && G.sel && G.sel.hb) {
            G.ball.x = G.sel.x;
            G.ball.y = G.sel.y;
          }
          
          // Update match timer (90 real seconds = 90 game minutes)
          if (G.state === "playing" && G.matchStartTime) {
            const elapsed = (Date.now() - G.matchStartTime) / 1000; // Real seconds
            G.matchTime = Math.floor(elapsed * G.matchTimerSpeed); // Game minutes
            
            // Update display
            const minutes = Math.min(G.matchTime, 90);
            document.getElementById("sd").textContent = `${minutes}'`;
            
            // STAMINA DRAIN (players get tired over time)
            if (G.matchTime > 0) {
              ['home', 'away'].forEach(team => {
                G.pl[team].forEach(player => {
                  if (player.stamina !== undefined && player.currentStamina !== undefined) {
                    // Drain stamina: Higher base stamina = slower drain
                    // Formula: Lose 0-40 stamina over 90 minutes depending on base stamina
                    const staminaDrain = (100 - player.stamina) / 100; // 0-0.5 (low stamina drains faster)
                    const drainPerMinute = staminaDrain * 0.5; // 0-0.25 per minute
                    
                    // Update current stamina
                    player.currentStamina = Math.max(30, player.stamina - (G.matchTime * drainPerMinute));
                  }
                });
              });
            }
            
            // End match when time runs out
            if (G.matchTime >= G.matchDuration) {
              endM();
            }
          }
          
          dF();
          dP();
          dB();
          dAL();
          G.anims.forEach((a) => {
            X.fillStyle = `rgba(${a.color === "#22c55e" ? "34,197,94" : "250,204,21"},${a.a})`;
            X.font = 'bold 13px "Russo One",sans-serif';
            X.textAlign = "center";
            X.fillText(a.text, a.x, a.y);
          });
          if (G.state === "playing" && G.turn === "away") aiT();
        }
        requestAnimationFrame(loop);
      }

      window.addEventListener("resize", () => {
        resize();
        if (G.state !== "menu") initP();
      });
      
      // ============================================
      // PLAYER SYSTEM - Database & Progression
      // ============================================
      
      // Load player database
      async function loadPlayerDatabase() {
        try {
          const response = await fetch('players_database.json');
          G.playersDB = await response.json();
          console.log(`âœ… Loaded ${G.playersDB.length} players`);
          return true;
        } catch (error) {
          console.error('âŒ Failed to load player database:', error);
          // Fallback: Create minimal database
          G.playersDB = [];
          return false;
        }
      }
      
      // Helper functions
      function getPlayerById(id) {
        return G.playersDB.find(p => p.id === id);
      }
      
      function getPlayersByCountry(code) {
        return G.playersDB.filter(p => p.country === code);
      }
      
      function getPlayersByTier(tier) {
        return G.playersDB.filter(p => p.tier === tier);
      }
      
      // Weighted random selection
      function weightedRandom(odds) {
        const random = Math.random();
        let cumulative = 0;
        
        for (const [tier, probability] of Object.entries(odds)) {
          cumulative += probability;
          if (random < cumulative) return tier;
        }
        
        return Object.keys(odds)[Object.keys(odds).length - 1];
      }
      
      // Pack system
      function openPack(packType) {
        const packConfig = {
          bronze: {
            cost: 200,
            cards: 3,
            odds: { common: 0.75, rare: 0.24, epic: 0.01, legendary: 0 }
          },
          silver: {
            cost: 500,
            cards: 5,
            odds: { common: 0.60, rare: 0.30, epic: 0.09, legendary: 0.01 }
          },
          gold: {
            cost: 1500,
            cards: 5,
            odds: { common: 0.20, rare: 0.50, epic: 0.25, legendary: 0.05 }
          },
          premium: {
            cost: 3000,
            cards: 7,
            odds: { common: 0, rare: 0.40, epic: 0.45, legendary: 0.15 }
          }
        };
        
        const config = packConfig[packType];
        if (!config) return [];
        
        const pack = [];
        const pulledIds = new Set();
        
        for (let i = 0; i < config.cards; i++) {
          const tier = weightedRandom(config.odds);
          const availablePlayers = G.playersDB.filter(p => 
            p.tier === tier && !pulledIds.has(p.id)
          );
          
          if (availablePlayers.length === 0) continue;
          
          const randomPlayer = availablePlayers[
            Math.floor(Math.random() * availablePlayers.length)
          ];
          
          pack.push(randomPlayer);
          pulledIds.add(randomPlayer.id);
        }
        
        return pack;
      }
      
      // Handle pack opening with duplicates
      function handlePackOpening(pack) {
        const results = [];
        const coinValue = { common: 50, rare: 150, epic: 500, legendary: 2000 };
        
        pack.forEach(player => {
          if (G.userCollection.has(player.id)) {
            // DUPLICATE!
            const coins = coinValue[player.tier];
            G.userSquad.coins += coins;
            
            results.push({
              player: player,
              isDuplicate: true,
              coinsEarned: coins
            });
          } else {
            // NEW PLAYER!
            G.userCollection.add(player.id);
            
            results.push({
              player: player,
              isDuplicate: false,
              isNew: true
            });
          }
        });
        
        return results;
      }
      
      // User XP & Leveling
      function addUserXP(amount) {
        G.userSquad.xp += amount;
        
        const levelUps = [];
        
        while (G.userSquad.xp >= G.userSquad.nextLevelXP) {
          G.userSquad.xp -= G.userSquad.nextLevelXP;
          G.userSquad.level++;
          G.userSquad.nextLevelXP = Math.floor(G.userSquad.nextLevelXP * 1.15);
          
          // Level up reward
          const reward = getLevelUpReward(G.userSquad.level);
          levelUps.push({ level: G.userSquad.level, reward });
        }
        
        saveUserData();
        return levelUps;
      }
      
      function getLevelUpReward(level) {
        const rewards = {
          2: { coins: 100 },
          3: { pack: 'bronze' },
          5: { coins: 200, pack: 'silver' },
          10: { pack: 'epic', coins: 500 },
          15: { pack: 'gold', coins: 500 },
          20: { pack: 'legendary', coins: 1000 },
          25: { coins: 1000 },
          30: { pack: 'premium', coins: 2000 },
        };
        
        if (rewards[level]) return rewards[level];
        
        // Every 10 levels
        if (level % 10 === 0) {
          return { coins: 300, pack: 'silver' };
        }
        
        return { coins: 100 };
      }
      
      // Save/Load user data
      function saveUserData() {
        const data = {
          squad: G.userSquad,
          collection: Array.from(G.userCollection),
          timestamp: Date.now()
        };
        
        localStorage.setItem('fm2026_userdata', JSON.stringify(data));
      }
      
      function loadUserData() {
        const saved = localStorage.getItem('fm2026_userdata');
        if (!saved) return null;
        
        try {
          const data = JSON.parse(saved);
          
          G.userSquad = data.squad;
          G.userCollection = new Set(data.collection);
          
          return data;
        } catch (error) {
          console.error('Failed to load user data:', error);
          return null;
        }
      }
      
      // Starter pack for new players
      function giveStarterPack() {
        console.log('ğŸ New player! Giving starter pack...');
        
        // Ensure complete squads for 3 formations: 4-4-2, 5-4-1, 3-4-3
        const neededPositions = {
          "GK": 1,      // Goalkeeper (all formations)
          "CB": 3,      // 3-4-3 needs 3 CBs, 5-4-1 needs 3
          "LB": 1,      // 4-4-2
          "RB": 1,      // 4-4-2
          "LWB": 1,     // 5-4-1
          "RWB": 1,     // 5-4-1
          "CM": 4,      // All formations use CM
          "LM": 1,      // 4-4-2, 5-4-1, 3-4-3
          "RM": 1,      // 4-4-2, 5-4-1, 3-4-3
          "LW": 1,      // 3-4-3
          "RW": 1,      // 3-4-3
          "ST": 2       // 4-4-2, 3-4-3 (one ST in 5-4-1)
        };
        
        const selectedPlayers = new Set();
        
        // For each needed position, find best available player
        Object.entries(neededPositions).forEach(([position, count]) => {
          const candidates = G.playersDB
            .filter(p => p.position === position && !selectedPlayers.has(p.id))
            .sort((a, b) => b.overall - a.overall); // Best first
          
          // Pick required count
          for (let i = 0; i < count && i < candidates.length; i++) {
            selectedPlayers.add(candidates[i].id);
            G.userCollection.add(candidates[i].id);
          }
        });
        
        // Add a few random extra players (bonus)
        const bonusPack = openPack('silver');
        bonusPack.forEach(player => {
          G.userCollection.add(player.id);
        });
        
        G.userSquad.coins = 1000;
        G.userSquad.level = 1;
        G.userSquad.xp = 0;
        G.userSquad.nextLevelXP = 1000;
        G.userSquad.formation = '4-4-2'; // Default formation
        
        saveUserData();
        
        console.log(`âœ… Starter pack: ${G.userCollection.size} players (4-4-2, 5-4-1, 3-4-3) + 1000 coins`);
        return Array.from(selectedPlayers).map(id => getPlayerById(id));
      }
      
      // ============================================
      // SQUAD BUILDER & SHOP UI
      // ============================================
      
      let currentSquadTab = 'lineup';
      let currentTierFilter = 'all';
      let currentPositionFilter = 'all';
      let selectedPositionSlot = null;
      
      // Open Squad Builder
      function openSquadBuilder() {
        document.getElementById('menu').classList.remove('a');
        document.getElementById('squadBuilder').classList.add('a');
        updateSquadBuilderUI();
        renderFormationDisplay();
        renderCollection();
      }
      
      // Close Squad Builder
      function closeSquadBuilder() {
        document.getElementById('squadBuilder').classList.remove('a');
        document.getElementById('menu').classList.add('a');
      }
      
      // Switch Squad Tab
      function switchSquadTab(tab) {
        currentSquadTab = tab;
        
        // Update tab buttons
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        
        // Show/hide content
        if (tab === 'lineup') {
          document.getElementById('squadLineup').style.display = 'block';
          document.getElementById('squadCollection').style.display = 'none';
        } else {
          document.getElementById('squadLineup').style.display = 'none';
          document.getElementById('squadCollection').style.display = 'block';
          renderCollection();
        }
      }
      
      // Update Squad Builder UI stats
      function updateSquadBuilderUI() {
        document.getElementById('sbLevel').textContent = G.userSquad.level;
        document.getElementById('sbXP').textContent = G.userSquad.xp;
        document.getElementById('sbNextXP').textContent = G.userSquad.nextLevelXP;
        document.getElementById('sbCoins').textContent = G.userSquad.coins;
        document.getElementById('sbPlayers').textContent = G.userCollection.size;
        document.getElementById('squadFormation').textContent = G.userSquad.formation;
      }
      
      // Render Formation Display
      function renderFormationDisplay() {
        const display = document.getElementById('formationDisplay');
        const formation = G.userSquad.formation || '4-4-2';
        
        // Highlight selected formation button
        document.querySelectorAll('#squadLineup .fb').forEach(btn => {
          btn.classList.remove('sel');
          if (btn.textContent === formation) {
            btn.classList.add('sel');
          }
        });
        
        const formationPositions = {
          "4-4-2": [
            { pos: "GK", x: 50, y: 5 },
            { pos: "LB", x: 15, y: 25 }, { pos: "CB", x: 35, y: 20 }, { pos: "CB", x: 65, y: 20 }, { pos: "RB", x: 85, y: 25 },
            { pos: "LM", x: 15, y: 50 }, { pos: "CM", x: 35, y: 50 }, { pos: "CM", x: 65, y: 50 }, { pos: "RM", x: 85, y: 50 },
            { pos: "ST", x: 35, y: 85 }, { pos: "ST", x: 65, y: 85 }
          ],
          "5-4-1": [
            { pos: "GK", x: 50, y: 5 },
            { pos: "LWB", x: 10, y: 25 }, { pos: "CB", x: 28, y: 18 }, { pos: "CB", x: 50, y: 15 }, { pos: "CB", x: 72, y: 18 }, { pos: "RWB", x: 90, y: 25 },
            { pos: "LM", x: 15, y: 50 }, { pos: "CM", x: 35, y: 50 }, { pos: "CM", x: 65, y: 50 }, { pos: "RM", x: 85, y: 50 },
            { pos: "ST", x: 50, y: 85 }
          ],
          "3-4-3": [
            { pos: "GK", x: 50, y: 5 },
            { pos: "CB", x: 25, y: 20 }, { pos: "CB", x: 50, y: 18 }, { pos: "CB", x: 75, y: 20 },
            { pos: "LM", x: 15, y: 50 }, { pos: "CM", x: 35, y: 50 }, { pos: "CM", x: 65, y: 50 }, { pos: "RM", x: 85, y: 50 },
            { pos: "LW", x: 15, y: 80 }, { pos: "ST", x: 50, y: 85 }, { pos: "RW", x: 85, y: 80 }
          ]
        };
        
        const positions = formationPositions[formation] || formationPositions["4-4-2"];
        
        let html = '';
        positions.forEach((slot, index) => {
          const player = G.userSquad.players[index] ? getPlayerById(G.userSquad.players[index]) : null;
          
          html += `
            <div class="formation-player-slot ${player ? 'filled' : ''}" 
                 style="left: ${slot.x}%; top: ${slot.y}%; transform: translate(-50%, -50%);"
                 onclick="selectPositionSlot(${index}, '${slot.pos}')">
              <div class="formation-player-circle">
                ${player ? player.overall : slot.pos}
              </div>
              <div class="formation-player-name">
                ${player ? player.name : slot.pos}
              </div>
            </div>
          `;
        });
        
        display.innerHTML = html;
      }
      
      // Change Formation
      function changeFormation(formation) {
        G.userSquad.formation = formation;
        
        // Clear current squad (positions don't match anymore)
        if (confirm(`Change formation to ${formation}?\n\nThis will clear your current lineup.`)) {
          G.userSquad.players = [];
          saveUserData();
          renderFormationDisplay();
          renderCollection();
        }
      }
      
      // Select Position Slot
      function selectPositionSlot(index, position) {
        selectedPositionSlot = { index, position };
        
        // Switch to collection tab
        document.querySelectorAll('.tab')[1].click();
        
        // Auto-filter by compatible positions
        const positionGroups = {
          'GK': 'GK',
          'LB': 'DEF', 'CB': 'DEF', 'RB': 'DEF', 'LWB': 'DEF', 'RWB': 'DEF',
          'CDM': 'MID', 'CM': 'MID', 'CAM': 'MID', 'LM': 'MID', 'RM': 'MID',
          'LW': 'ATT', 'RW': 'ATT', 'ST': 'ATT', 'CF': 'ATT', 'LF': 'ATT', 'RF': 'ATT'
        };
        
        const group = positionGroups[position] || 'all';
        currentPositionFilter = group;
        
        filterCollection();
        
        // Show message
        const msg = position === 'GK' ? 'Select a Goalkeeper' : 
                    group === 'DEF' ? `Select a Defender (preferably ${position})` :
                    group === 'MID' ? `Select a Midfielder (preferably ${position})` :
                    `Select an Attacker (preferably ${position})`;
        
        setTimeout(() => alert(msg), 100);
      }
      
      // Render Collection
      function renderCollection() {
        const grid = document.getElementById('collectionGrid');
        
        // Get owned players
        let players = Array.from(G.userCollection).map(id => getPlayerById(id)).filter(p => p);
        
        // Apply filters
        const search = document.getElementById('collectionSearch')?.value.toLowerCase() || '';
        if (search) {
          players = players.filter(p => 
            p.name.toLowerCase().includes(search) ||
            p.country.toLowerCase().includes(search) ||
            p.position.toLowerCase().includes(search)
          );
        }
        
        if (currentTierFilter !== 'all') {
          players = players.filter(p => p.tier === currentTierFilter);
        }
        
        // Position filter
        if (currentPositionFilter !== 'all') {
          const positionGroups = {
            'GK': ['GK'],
            'DEF': ['LB', 'CB', 'RB', 'LWB', 'RWB'],
            'MID': ['CDM', 'CM', 'CAM', 'LM', 'RM'],
            'ATT': ['LW', 'RW', 'ST', 'CF', 'LF', 'RF']
          };
          
          const allowedPositions = positionGroups[currentPositionFilter] || [];
          players = players.filter(p => allowedPositions.includes(p.position));
        }
        
        // Sort by overall
        players.sort((a, b) => b.overall - a.overall);
        
        // Render
        let html = '';
        players.forEach(player => {
          const isInSquad = G.userSquad.players.includes(player.id);
          
          html += `
            <div class="player-card ${player.tier} ${isInSquad ? 'selected' : ''}" 
                 onclick="togglePlayerInSquad(${player.id})">
              <div class="player-card-header">
                <div class="player-card-name">${player.name}</div>
                <div class="player-card-ovr">${player.overall}</div>
              </div>
              <div class="player-card-info">
                <span class="player-card-country">${getCountryFlag(player.country)}</span>
                ${player.position} â€¢ ${player.tier}
                ${isInSquad ? 'âœ“ In Squad' : ''}
              </div>
              <div class="player-card-stats">
                <div class="player-card-stat">
                  <span class="player-card-stat-label">PAC</span>
                  <span>${player.speed}</span>
                </div>
                <div class="player-card-stat">
                  <span class="player-card-stat-label">SHO</span>
                  <span>${player.shooting}</span>
                </div>
                <div class="player-card-stat">
                  <span class="player-card-stat-label">PAS</span>
                  <span>${player.passing}</span>
                </div>
                <div class="player-card-stat">
                  <span class="player-card-stat-label">DEF</span>
                  <span>${player.tackling}</span>
                </div>
              </div>
            </div>
          `;
        });
        
        grid.innerHTML = html || '<div style="color: #6b7280; text-align: center; padding: 20px;">No players found</div>';
      }
      
      // Get country flag
      function getCountryFlag(code) {
        const team = TEAMS.find(t => t.code === code);
        return team ? team.flag : 'ğŸ´';
      }
      
      // Toggle Player in Squad
      function togglePlayerInSquad(playerId) {
        const player = getPlayerById(playerId);
        if (!player) return;
        
        const index = G.userSquad.players.indexOf(playerId);
        
        if (index !== -1) {
          // Remove from squad
          G.userSquad.players.splice(index, 1);
          selectedPositionSlot = null; // Clear selection
        } else {
          // If a position slot is selected, validate position match
          if (selectedPositionSlot) {
            const slotPosition = selectedPositionSlot.position;
            const slotIndex = selectedPositionSlot.index;
            
            // Strict validation for GK
            if (slotPosition === 'GK' && player.position !== 'GK') {
              alert('âŒ This slot requires a Goalkeeper (GK)!');
              return;
            }
            
            if (player.position === 'GK' && slotPosition !== 'GK') {
              alert('âŒ Goalkeepers can only play in GK position!');
              return;
            }
            
            // Compatible positions check (more flexible for outfield players)
            const compatiblePositions = {
              'LB': ['LB', 'LWB'],
              'CB': ['CB'],
              'RB': ['RB', 'RWB'],
              'LWB': ['LB', 'LWB'],
              'RWB': ['RB', 'RWB'],
              'CDM': ['CDM', 'CM'],
              'CM': ['CM', 'CDM', 'CAM'],
              'CAM': ['CAM', 'CM'],
              'LM': ['LM', 'LW', 'CM'],
              'RM': ['RM', 'RW', 'CM'],
              'LW': ['LW', 'LM', 'ST'],
              'RW': ['RW', 'RM', 'ST'],
              'ST': ['ST', 'CF', 'LW', 'RW'],
              'CF': ['CF', 'ST', 'CAM']
            };
            
            const allowed = compatiblePositions[slotPosition] || [slotPosition];
            
            if (!allowed.includes(player.position)) {
              alert(`âŒ Position mismatch!\n\nSlot: ${slotPosition}\nPlayer: ${player.name} (${player.position})\n\nAllowed: ${allowed.join(', ')}`);
              return;
            }
            
            // Add to specific slot
            G.userSquad.players[slotIndex] = playerId;
            selectedPositionSlot = null;
          } else {
            // Add to squad (max 23)
            if (G.userSquad.players.length >= 23) {
              alert('Squad is full! (Maximum 23 players)');
              return;
            }
            
            G.userSquad.players.push(playerId);
          }
        }
        
        saveUserData();
        renderCollection();
        renderFormationDisplay();
      }
      
      // Filter Collection
      function filterCollection() {
        renderCollection();
      }
      
      // Filter by Tier
      function filterByTier(tier) {
        currentTierFilter = tier;
        
        // Update buttons
        document.querySelectorAll('#squadCollection .fb').forEach(btn => {
          btn.classList.remove('sel');
        });
        event.target.classList.add('sel');
        
        renderCollection();
      }
      
      // Filter by Position
      function filterByPosition(group) {
        currentPositionFilter = group;
        
        // Update buttons (position filter buttons are separate)
        const positionButtons = document.querySelectorAll('#squadCollection .fb');
        // Don't clear tier buttons, only update position buttons
        event.target.classList.toggle('sel');
        
        renderCollection();
      }
      
      // Auto-Select Best XI
      function autoSelectBest() {
        const formation = G.userSquad.formation || '4-4-2';
        const positions = {
          "4-4-2": ["GK", "LB", "CB", "CB", "RB", "LM", "CM", "CM", "RM", "ST", "ST"],
          "5-4-1": ["GK", "LWB", "CB", "CB", "CB", "RWB", "LM", "CM", "CM", "RM", "ST"],
          "3-4-3": ["GK", "CB", "CB", "CB", "LM", "CM", "CM", "RM", "LW", "ST", "RW"]
        }[formation] || ["GK", "LB", "CB", "CB", "RB", "LM", "CM", "CM", "RM", "ST", "ST"];
        
        // Compatible positions map (same as togglePlayerInSquad)
        const compatiblePositions = {
          'GK': ['GK'],
          'LB': ['LB', 'LWB'],
          'CB': ['CB'],
          'RB': ['RB', 'RWB'],
          'LWB': ['LB', 'LWB'],
          'RWB': ['RB', 'RWB'],
          'CDM': ['CDM', 'CM'],
          'CM': ['CM', 'CDM', 'CAM'],
          'CAM': ['CAM', 'CM'],
          'LM': ['LM', 'LW', 'CM'],
          'RM': ['RM', 'RW', 'CM'],
          'LW': ['LW', 'LM', 'ST'],
          'RW': ['RW', 'RM', 'ST'],
          'ST': ['ST', 'CF', 'LW', 'RW'],
          'CF': ['CF', 'ST', 'CAM']
        };
        
        G.userSquad.players = [];
        
        positions.forEach(slotPos => {
          const allowedPositions = compatiblePositions[slotPos] || [slotPos];
          
          // Find best player from compatible positions
          const candidates = Array.from(G.userCollection)
            .map(id => getPlayerById(id))
            .filter(p => p && allowedPositions.includes(p.position) && !G.userSquad.players.includes(p.id))
            .sort((a, b) => {
              // Prefer exact position match, then overall
              const aExact = p.position === slotPos ? 1 : 0;
              const bExact = p.position === slotPos ? 1 : 0;
              if (aExact !== bExact) return bExact - aExact;
              return b.overall - a.overall;
            });
          
          if (candidates.length > 0) {
            G.userSquad.players.push(candidates[0].id);
          } else {
            // No compatible player - leave slot empty
            G.userSquad.players.push(null);
          }
        });
        
        saveUserData();
        renderFormationDisplay();
        renderCollection();
        
        const filled = G.userSquad.players.filter(id => id !== null).length;
        alert(`Auto-selected ${filled}/11 players!${filled < 11 ? '\n\nSome positions could not be filled.' : ''}`);
      }
      
      // ============================================
      // SHOP
      // ============================================
      
      // Open Shop
      function openShop() {
        document.getElementById('menu').classList.remove('a');
        document.getElementById('shop').classList.add('a');
        updateShopUI();
      }
      
      // Close Shop
      function closeShop() {
        document.getElementById('shop').classList.remove('a');
        document.getElementById('menu').classList.add('a');
      }
      
      // Update Shop UI
      function updateShopUI() {
        document.getElementById('shopCoins').textContent = G.userSquad.coins;
      }
      
      // Buy Pack
      function buyPack(packType) {
        const packPrices = {
          bronze: 200,
          silver: 500,
          gold: 1500,
          premium: 3000
        };
        
        const price = packPrices[packType];
        
        if (G.userSquad.coins < price) {
          alert(`Not enough coins! You need ${price} ğŸ’°`);
          return;
        }
        
        // Deduct coins
        G.userSquad.coins -= price;
        saveUserData();
        updateShopUI();
        updateDebugUI();
        
        // Open pack
        const pack = openPack(packType);
        const results = handlePackOpening(pack);
        
        // Show pack opening animation
        showPackOpening(results, packType);
      }
      
      // Show Pack Opening Animation
      function showPackOpening(results, packType) {
        const container = document.getElementById('packCard');
        
        let html = `
          <div style="font-family: 'Russo One', sans-serif; font-size: 24px; color: #facc15; margin-bottom: 16px;">
            ${packType.toUpperCase()} PACK
          </div>
        `;
        
        results.forEach(result => {
          const player = result.player;
          const tierColors = {
            legendary: '#fbbf24',
            epic: '#a855f7',
            rare: '#3b82f6',
            common: '#6b7280'
          };
          
          html += `
            <div style="
              background: linear-gradient(135deg, #1f2937, #111827);
              border: 2px solid ${tierColors[player.tier]};
              border-radius: 8px;
              padding: 12px;
              margin-bottom: 10px;
              text-align: left;
            ">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-family: 'Russo One', sans-serif; font-size: 16px; color: #fff;">
                    ${player.name}
                  </div>
                  <div style="font-size: 11px; color: #9ca3af;">
                    ${getCountryFlag(player.country)} ${player.position} â€¢ ${player.tier}
                  </div>
                </div>
                <div style="font-family: 'Russo One', sans-serif; font-size: 24px; color: ${tierColors[player.tier]};">
                  ${player.overall}
                </div>
              </div>
              ${result.isDuplicate ? `
                <div style="font-size: 12px; color: #facc15; margin-top: 6px;">
                  âš ï¸ DUPLICATE! +${result.coinsEarned} ğŸ’°
                </div>
              ` : `
                <div style="font-size: 12px; color: #22c55e; margin-top: 6px;">
                  âœ“ NEW PLAYER!
                </div>
              `}
            </div>
          `;
        });
        
        container.innerHTML = html;
        document.getElementById('packOpening').classList.add('active');
        
        saveUserData();
        updateDebugUI();
      }
      
      // Close Pack Opening
      function closePackOpening() {
        document.getElementById('packOpening').classList.remove('active');
        updateShopUI();
        updateSquadBuilderUI();
      }
      
      // Initialize player system
      async function initPlayerSystem() {
        console.log('ğŸ”„ Initializing player system...');
        
        // Load database
        const dbLoaded = await loadPlayerDatabase();
        if (!dbLoaded) {
          console.warn('âš ï¸ Running without player database');
          return;
        }
        
        // Load user data or create new
        const userData = loadUserData();
        
        if (!userData) {
          // New player
          giveStarterPack();
        } else {
          console.log(`âœ… Welcome back! Level ${G.userSquad.level}, ${G.userSquad.coins} coins`);
        }
        
        // Show debug UI
        updateDebugUI();
        document.getElementById('playerDebug').style.display = 'block';
      }
      
      // Update debug UI
      function updateDebugUI() {
        const debugLevel = document.getElementById('debugLevel');
        const debugXP = document.getElementById('debugXP');
        const debugNextXP = document.getElementById('debugNextXP');
        const debugCoins = document.getElementById('debugCoins');
        const debugPlayers = document.getElementById('debugPlayers');
        
        if (debugLevel) debugLevel.textContent = G.userSquad.level;
        if (debugXP) debugXP.textContent = G.userSquad.xp;
        if (debugNextXP) debugNextXP.textContent = G.userSquad.nextLevelXP;
        if (debugCoins) debugCoins.textContent = G.userSquad.coins;
        if (debugPlayers) debugPlayers.textContent = G.userCollection.size;
      }
      
      // Initialize on load
      initPlayerSystem().then(() => {
        console.log('âœ… Player system ready!');
      });
      
      resize();
      loop();
    </script>
  </body>
</html>




